<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FK Team Planner</title>

  <!-- Bootstrap (pas jsdelivr) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" />

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Supabase JS v2 (pas jsdelivr) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    /* RESET & BASE */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --sidebar-bg: #1a1d29;
      --sidebar-hover: #252836;
      --orange: #FF6B35;
      --orange-dark: #E85528;
      --white: #FFFFFF;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --text-primary: #111827;
      --text-secondary: #6B7280;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
      background: #f0f2f5 !important;
      color: var(--text-primary) !important;
      overflow: hidden !important;
    }

    /* LAYOUT FLEX */
    body > .container {
      display: flex !important;
      height: 100vh !important;
      max-width: 100% !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    /* SIDEBAR */
    .sidebar {
      width: 240px;
      background: var(--sidebar-bg);
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 12px rgba(0,0,0,0.1);
      z-index: 1000;
      padding: 1.5rem 0;
    }

    .sidebar-logo {
      padding: 0 1.5rem 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 1rem;
    }

    .logo-content {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: white;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--orange), var(--orange-dark));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
    }

    .logo-text {
      font-weight: 700;
      font-size: 1.1rem;
    }

    .logo-subtitle {
      font-size: 0.75rem;
      color: var(--gray-400);
      display: block;
      margin-top: 0.125rem;
    }

    .sidebar-nav {
      flex: 1;
      padding: 0 0.75rem;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      color: var(--gray-400);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 0.25rem;
    }

    .nav-item:hover {
      background: var(--sidebar-hover);
      color: white;
    }

    .nav-item.active {
      background: var(--orange);
      color: white;
    }

    .nav-section-title {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 1.5rem 1rem 0.75rem;
    }

    /* MAIN CONTENT */
    .main-wrapper {
      margin-left: 240px;
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* TOP BAR */
    .top-bar {
      background: white;
      border-bottom: 1px solid var(--gray-200);
      padding: 0 2rem;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .page-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .page-subtitle {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin: 0.25rem 0 0 0;
    }

    /* CONTENT AREA */
    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
      background: #f0f2f5;
    }

    /* CARDS */
    .card {
      background: white !important;
      border: 1px solid var(--gray-200) !important;
      border-radius: 12px !important;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05) !important;
    }

    /* CALENDAR */
    .calendar-header-custom {
      background: white;
      padding: 1.5rem 2rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .cal-grid {
      background: white !important;
      border-radius: 12px !important;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05) !important;
      display: grid !important;
      grid-template-columns: repeat(7, 1fr) !important;
      gap: 0 !important;
    }

    .cal-head {
      background: var(--gray-50) !important;
      color: var(--gray-500) !important;
      padding: 1rem !important;
      text-align: center !important;
      font-weight: 600 !important;
      font-size: 0.875rem !important;
      border-bottom: 1px solid var(--gray-200) !important;
    }

    .cal-cell {
      background: white !important;
      border-right: 1px solid var(--gray-100) !important;
      border-bottom: 1px solid var(--gray-100) !important;
      padding: 12px !important;
      min-height: 120px !important;
      transition: background 0.2s ease !important;
      border-radius: 0 !important;
    }

    .cal-cell:nth-child(7n) {
      border-right: none !important;
    }

    .cal-cell:hover {
      background: var(--gray-50) !important;
    }

    .cal-day {
      font-weight: 600 !important;
      color: var(--text-primary) !important;
      font-size: 0.95rem !important;
    }

    .task-pill {
      background: var(--orange) !important;
      color: white !important;
      padding: 4px 8px !important;
      border-radius: 6px !important;
      font-size: 0.75rem !important;
      font-weight: 500 !important;
      display: block !important;
      margin-top: 6px !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
    }

    .task-pill small {
      color: rgba(255,255,255,0.9) !important;
    }

    /* BUTTONS */
    .btn {
      border-radius: 8px !important;
      font-weight: 500 !important;
      transition: all 0.2s ease !important;
    }

    .btn-primary {
      background: var(--orange) !important;
      border: none !important;
      color: white !important;
    }

    .btn-primary:hover {
      background: var(--orange-dark) !important;
    }

    .btn-outline-secondary,
    .btn-secondary {
      background: white !important;
      border: 1px solid var(--gray-300) !important;
      color: var(--gray-700) !important;
    }

    .btn-outline-secondary:hover,
    .btn-secondary:hover {
      background: var(--gray-50) !important;
      border-color: var(--gray-400) !important;
    }

    .btn-outline-primary {
      background: transparent !important;
      border: 2px solid var(--orange) !important;
      color: var(--orange) !important;
    }

    .btn-outline-primary:hover {
      background: var(--orange) !important;
      color: white !important;
    }

    .btn-danger {
      background: #DC2626 !important;
      border: none !important;
      color: white !important;
    }

    .btn-danger:hover {
      background: #B91C1C !important;
    }

    .btn-link {
      color: var(--orange) !important;
      text-decoration: none !important;
    }

    .btn-link:hover {
      text-decoration: underline !important;
    }

    /* FORMS */
    .form-control,
    .form-select {
      background: white !important;
      border: 1px solid var(--gray-300) !important;
      color: var(--text-primary) !important;
      border-radius: 8px !important;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--orange) !important;
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1) !important;
    }

    .form-label {
      color: var(--gray-700) !important;
      font-weight: 600 !important;
      font-size: 0.875rem !important;
    }

    .form-text {
      color: var(--gray-500) !important;
    }

    /* BADGES */
    .badge {
      border-radius: 999px !important;
      font-size: 0.8rem !important;
      padding: 0.35rem 0.75rem !important;
    }

    .badge-soft {
      background: rgba(255, 107, 53, 0.1) !important;
      color: var(--orange) !important;
    }

    .text-bg-light {
      background: var(--gray-100) !important;
      color: var(--gray-700) !important;
    }

    .text-bg-warning {
      background: rgba(251, 191, 36, 0.2) !important;
      color: #D97706 !important;
    }

    .text-bg-success {
      background: rgba(34, 197, 94, 0.2) !important;
      color: #059669 !important;
    }

    /* ALERTS */
    .alert {
      border-radius: 10px !important;
      border: 1px solid !important;
    }

    .alert-danger {
      background: rgba(220, 38, 38, 0.1) !important;
      color: #DC2626 !important;
      border-color: rgba(220, 38, 38, 0.3) !important;
    }

    .alert-success {
      background: rgba(34, 197, 94, 0.1) !important;
      color: #059669 !important;
      border-color: rgba(34, 197, 94, 0.3) !important;
    }

    .alert-info {
      background: rgba(59, 130, 246, 0.1) !important;
      color: #2563EB !important;
      border-color: rgba(59, 130, 246, 0.3) !important;
    }

    /* MODAL */
    .modal-content {
      background: white !important;
      border: 1px solid var(--gray-200) !important;
      color: var(--text-primary) !important;
      border-radius: 12px !important;
    }

    .modal-header {
      border-bottom-color: var(--gray-200) !important;
    }

    .modal-footer {
      border-top-color: var(--gray-200) !important;
    }

    .btn-close {
      filter: none;
    }

    /* TEXT */
    .muted,
    .text-secondary {
      color: var(--text-secondary) !important;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, 'Courier New', monospace !important;
      color: var(--gray-500) !important;
    }

    /* UTILITIES */
    .border {
      border-color: var(--gray-200) !important;
    }

    .bg-white {
      background: white !important;
    }

    .rounded-3 {
      border-radius: 10px !important;
    }

    .pointer {
      cursor: pointer !important;
    }

    .hidden {
      display: none !important;
    }

    /* SCROLLBAR */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--gray-100);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-400);
    }

    /* RESPONSIVE */
    @media (max-width: 968px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .main-wrapper {
        margin-left: 0;
      }
    }
  </style>
</head>

<body>
  <div class="container py-4">

    <!-- SIDEBAR NOIRE À GAUCHE -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <div class="logo-content">
          <div class="logo-icon">FK</div>
          <div>
            <div class="logo-text">Task Team Manager</div>
            <span class="logo-subtitle">Gestion d'équipe</span>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <a href="#" class="nav-item" onclick="showDashboard(event)">
          <i data-lucide="layout-dashboard" style="width:20px;height:20px;"></i>
          Dashboard
        </a>
        <a href="#" class="nav-item active" onclick="showCalendar(event)">
          <i data-lucide="calendar" style="width:20px;height:20px;"></i>
          Calendrier
        </a>
        <a href="#" class="nav-item" onclick="showTasks(event)">
          <i data-lucide="check-square" style="width:20px;height:20px;"></i>
          Tâches
        </a>
        <a href="#" class="nav-item" onclick="showTeams(event)">
          <i data-lucide="users" style="width:20px;height:20px;"></i>
          Équipes
        </a>

        <div class="nav-section-title">VUES RAPIDES</div>
        <a href="#" class="nav-item" onclick="quickFilter('mine', event)">
          <i data-lucide="user" style="width:20px;height:20px;"></i>
          Mes tâches
        </a>
        <a href="#" class="nav-item" onclick="quickFilter('late', event)">
          <i data-lucide="alert-circle" style="width:20px;height:20px;"></i>
          En retard
        </a>
        <a href="#" class="nav-item" onclick="quickFilter('week', event)">
          <i data-lucide="calendar-days" style="width:20px;height:20px;"></i>
          Cette semaine
        </a>
      </nav>
    </aside>

    <!-- CONTENU PRINCIPAL DÉCALÉ -->
    <div class="main-wrapper">

      <!-- TOP BAR BLANC -->
      <header class="top-bar">
        <div>
          <h1 class="page-title" id="pageTitle">Calendrier</h1>
          <p class="page-subtitle" id="pageSubtitle">Janvier 2026</p>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="badge text-bg-light border" id="roleBadge">non connecté</span>
          <span class="text-secondary small" id="userEmail"></span>
          <button class="btn btn-outline-secondary btn-sm hidden" id="btnLogout">Se déconnecter</button>
        </div>
      </header>

      <!-- ZONE DE CONTENU SCROLLABLE -->
      <main class="content-area" id="mainContentArea">

    <!-- AUTH -->
    <div id="authView" class="row g-3">
      <div class="col-12 col-lg-6">
        <div class="card p-4">
          <h4 class="mb-1">Connexion</h4>
          <p class="muted mb-4">Connecte-toi pour accéder au calendrier collectif.</p>

          <form id="loginForm" class="vstack gap-2">
            <div>
              <label class="form-label">Email</label>
              <input class="form-control" type="email" id="loginEmail" required />
            </div>
            <div>
              <label class="form-label">Mot de passe</label>
              <input class="form-control" type="password" id="loginPassword" required />
            </div>
            <button class="btn btn-primary mt-2" type="submit">Se connecter</button>
          </form>

          <div class="alert alert-danger mt-3 hidden" id="loginError"></div>
          <div class="alert alert-success mt-3 hidden" id="loginOk"></div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card p-4">
          <h4 class="mb-1">Créer un compte</h4>
          <p class="muted mb-4">Inscription simple (email + mot de passe).</p>

          <form id="registerForm" class="vstack gap-2">
            <div>
              <label class="form-label">Nom complet (optionnel)</label>
              <input class="form-control" type="text" id="regName" placeholder="Anthony POIGNARD" />
            </div>
            <div>
              <label class="form-label">Email</label>
              <input class="form-control" type="email" id="regEmail" required />
            </div>
            <div>
              <label class="form-label">Mot de passe</label>
              <input class="form-control" type="password" id="regPassword" required minlength="6" />
              <div class="form-text">Min 6 caractères.</div>
            </div>

            <button class="btn btn-outline-primary mt-2" type="submit">Créer le compte</button>
          </form>

          <div class="alert alert-danger mt-3 hidden" id="regError"></div>
          <div class="alert alert-success mt-3 hidden" id="regOk"></div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="appView" class="hidden">

      <!-- DASHBOARD VIEW -->
      <div id="dashboardView" class="hidden">
        <div class="row g-3">
          <!-- Stats cards -->
          <div class="col-12 col-lg-3">
            <div class="card p-3">
              <div class="d-flex align-items-center gap-3">
                <div style="width:48px;height:48px;border-radius:12px;background:rgba(59,130,246,0.1);display:flex;align-items:center;justify-content:center;">
                  <i data-lucide="clipboard-list" style="width:24px;height:24px;color:#3B82F6;"></i>
                </div>
                <div>
                  <div class="small text-secondary">Total tâches</div>
                  <div class="fs-3 fw-bold" id="totalTasks">0</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <div class="card p-3">
              <div class="d-flex align-items-center gap-3">
                <div style="width:48px;height:48px;border-radius:12px;background:rgba(34,197,94,0.1);display:flex;align-items:center;justify-content:center;">
                  <i data-lucide="check-circle" style="width:24px;height:24px;color:#22C55E;"></i>
                </div>
                <div>
                  <div class="small text-secondary">Terminées</div>
                  <div class="fs-3 fw-bold" id="doneTasks">0</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <div class="card p-3">
              <div class="d-flex align-items-center gap-3">
                <div style="width:48px;height:48px;border-radius:12px;background:rgba(251,191,36,0.1);display:flex;align-items:center;justify-content:center;">
                  <i data-lucide="clock" style="width:24px;height:24px;color:#FBBF24;"></i>
                </div>
                <div>
                  <div class="small text-secondary">En cours</div>
                  <div class="fs-3 fw-bold" id="inProgressTasks">0</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-3">
            <div class="card p-3">
              <div class="d-flex align-items-center gap-3">
                <div style="width:48px;height:48px;border-radius:12px;background:rgba(239,68,68,0.1);display:flex;align-items:center;justify-content:center;">
                  <i data-lucide="alert-triangle" style="width:24px;height:24px;color:#EF4444;"></i>
                </div>
                <div>
                  <div class="small text-secondary">En retard</div>
                  <div class="fs-3 fw-bold text-danger" id="lateTasks">0</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <h5 class="mb-3">Répartition par statut</h5>
              <div id="statusBreakdown"></div>
            </div>
          </div>
          <div class="col-12 col-lg-6">
            <div class="card p-3">
              <h5 class="mb-3">Répartition par priorité</h5>
              <div id="priorityBreakdown"></div>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-3">
          <div class="col-12">
            <div class="card p-3">
              <h5 class="mb-3">Charge par membre</h5>
              <div id="memberWorkload"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- CALENDAR VIEW -->
      <div id="calendarView" class="hidden">
        <!-- Calendar controls -->
        <div class="calendar-header-custom">
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="calPrev">
              <i data-lucide="chevron-left"></i>
            </button>
            <div class="fw-semibold" style="min-width:140px;text-align:center;" id="calTitle"></div>
            <button class="btn btn-outline-secondary btn-sm" id="calNext">
              <i data-lucide="chevron-right"></i>
            </button>
            <button class="btn btn-outline-secondary btn-sm" id="calToday">Aujourd'hui</button>
          </div>
          <div>
            <!-- View switcher could go here -->
          </div>
        </div>

        <!-- Calendar grid -->
        <div class="cal-grid" id="calGrid">
          <div class="cal-head">Lun</div>
          <div class="cal-head">Mar</div>
          <div class="cal-head">Mer</div>
          <div class="cal-head">Jeu</div>
          <div class="cal-head">Ven</div>
          <div class="cal-head">Sam</div>
          <div class="cal-head">Dim</div>
        </div>
      </div>

      <!-- TASKS VIEW -->
      <div id="tasksView" class="hidden">
        <div class="row g-3">
          <div class="col-12 col-lg-8">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Liste des tâches</h5>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-secondary btn-sm" onclick="downloadTasksTemplate()">
                    <i data-lucide="download" style="width:14px;height:14px;"></i>
                    Modèle
                  </button>
                  <button class="btn btn-primary btn-sm" onclick="document.getElementById('importTasksFile').click()">
                    <i data-lucide="upload" style="width:14px;height:14px;"></i>
                    Importer
                  </button>
                  <input type="file" id="importTasksFile" accept=".csv,.xlsx,.xls" style="display:none;" onchange="importTasks(event)">
                  <select class="form-select form-select-sm" id="taskFilterMode" style="width:auto;">
                    <option value="all">Toutes les tâches</option>
                    <option value="team">Équipe sélectionnée</option>
                  </select>
                  <select class="form-select form-select-sm" id="taskSort" style="width:auto;">
                    <option value="start_asc">Plus anciennes</option>
                    <option value="start_desc">Plus récentes</option>
                  </select>
                </div>
              </div>
              <div id="tasksListView"></div>
            </div>
          </div>

          <div class="col-12 col-lg-4">
            <div class="card p-3">
              <h5 class="mb-3">Créer une tâche</h5>
              <form id="taskForm">
                <div class="mb-2">
                  <label class="form-label">Titre</label>
                  <input class="form-control" id="taskTitle" required />
                </div>
                <div class="mb-2">
                  <label class="form-label">Description</label>
                  <textarea class="form-control" id="taskDescription" rows="2"></textarea>
                </div>
                <div class="mb-2">
                  <label class="form-label">Catégorie</label>
                  <select class="form-select" id="taskCategory">
                    <option>Design</option>
                    <option>Dev</option>
                    <option>Marketing</option>
                    <option>Réunion</option>
                    <option>Autre</option>
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label">Début</label>
                  <input type="date" class="form-control" id="taskStart" required />
                </div>
                <div class="mb-2">
                  <label class="form-label">Fin</label>
                  <input type="date" class="form-control" id="taskEnd" required />
                </div>
                <div class="mb-2">
                  <label class="form-label">Assigné à</label>
                  <select class="form-select" id="taskAssignee">
                    <option value="">Non assigné</option>
                  </select>
                </div>
                <button class="btn btn-primary w-100" type="submit">Créer</button>
                <div class="alert alert-danger mt-2 hidden" id="taskError"></div>
                <div class="alert alert-success mt-2 hidden" id="taskOk"></div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- TEAMS VIEW -->
      <div id="teamsView" class="hidden">
        <div class="row g-3 mb-3">
          <div class="col-12">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h5 class="mb-1">Équipes</h5>
                  <p class="text-secondary small mb-0">Gérez vos équipes et leurs membres</p>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-secondary btn-sm" onclick="downloadTeamsTemplate()">
                    <i data-lucide="download" style="width:14px;height:14px;"></i>
                    Modèle Équipes
                  </button>
                  <button class="btn btn-outline-secondary btn-sm" onclick="downloadMembersTemplate()">
                    <i data-lucide="download" style="width:14px;height:14px;"></i>
                    Modèle Membres
                  </button>
                  <button class="btn btn-primary btn-sm" onclick="document.getElementById('importTeamsFile').click()">
                    <i data-lucide="upload" style="width:14px;height:14px;"></i>
                    Importer
                  </button>
                  <input type="file" id="importTeamsFile" accept=".csv,.xlsx,.xls" style="display:none;" onchange="importTeamsOrMembers(event)">
                  <button class="btn btn-primary btn-sm hidden" id="btnCreateTeam">
                    <i data-lucide="plus" class="me-1"></i>Nouvelle équipe
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-lg-4">
            <div class="card p-3">
              <label class="form-label mb-2">Équipe sélectionnée</label>
              <select class="form-select mb-3" id="teamSelect"></select>
              <button class="btn btn-outline-secondary btn-sm w-100" id="btnRefresh">
                <i data-lucide="refresh-cw" class="me-1"></i>Rafraîchir
              </button>
              <div id="writeStatus" class="badge mt-2"></div>
            </div>

            <div class="card p-3 mt-3">
              <h6 class="mb-2">Membres (<span id="teamMembersCount">0</span>)</h6>
              <div id="membersList"></div>

              <hr class="my-3" />
              
              <h6 class="mb-2">Ajouter un membre</h6>
              <form id="addMemberForm" class="hidden">
                <input class="form-control form-control-sm mb-2" type="email" id="addMemberEmail" placeholder="email@exemple.com" required />
                <select class="form-select form-select-sm mb-2" id="addMemberRole">
                  <option value="member">Membre</option>
                  <option value="viewer">Lecteur</option>
                </select>
                <button class="btn btn-primary btn-sm w-100" type="submit">Ajouter</button>
                <div class="alert alert-danger mt-2 hidden" id="addMemberError"></div>
                <div class="alert alert-success mt-2 hidden" id="addMemberOk"></div>
              </form>
              <div class="alert alert-info mt-2 hidden" id="addMemberHint">
                Seuls les managers et admins peuvent ajouter des membres.
              </div>
            </div>
          </div>

          <div class="col-12 col-lg-8">
            <div class="card p-3">
              <h5 class="mb-3">Tâches de l'équipe (<span id="tasksCount">0</span>)</h5>
              <div id="tasksListInTeams"></div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Modals restent en dehors -->
        <div class="col-12 col-lg-4">
          <div class="card p-3">
            <label class="form-label mb-1">Équipe (pour créer/filtrer)</label>
            <select class="form-select" id="teamSelect"></select>
            <div class="d-flex gap-2 mt-2">
              <button class="btn btn-outline-primary btn-sm hidden" id="btnCreateTeam">
                <i data-lucide="plus" class="me-1"></i>Créer une équipe
              </button>
              <button class="btn btn-outline-secondary btn-sm" id="btnRefresh">
                <i data-lucide="refresh-cw" class="me-1"></i>Rafraîchir
              </button>
            </div>
            <div class="small muted mt-2">
              Lecture globale (calendrier collectif). Écriture selon permissions.
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-8">
          <div class="card p-3">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
              <div>
                <div class="fw-bold">Calendrier collectif</div>
                <div class="small muted">Affiche toutes les équipes. Les tâches couvrent la période start → end.</div>
              </div>
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="calPrev">
                  <i data-lucide="chevron-left"></i>
                </button>
                <div class="fw-semibold" id="calTitle"></div>
                <button class="btn btn-outline-secondary btn-sm" id="calNext">
                  <i data-lucide="chevron-right"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="calToday">Aujourd’hui</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main columns -->
      <div class="row g-3">
        <!-- Left: members + add member -->
        <div class="col-12 col-lg-4">
          <div class="card p-3 mb-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-bold">Membres de l’équipe</div>
              <span class="badge badge-soft" id="teamMembersCount">0</span>
            </div>
            <div id="membersList" class="vstack gap-2 small"></div>

            <hr class="my-3" />
            <div class="fw-bold mb-2">Ajouter un membre (manager/admin)</div>
            <div class="small muted mb-2">Le membre doit déjà avoir créé un compte (profile existant).</div>

            <form id="addMemberForm" class="vstack gap-2 hidden">
              <input class="form-control" type="email" id="addMemberEmail" placeholder="email@exemple.com" required />
              <select class="form-select" id="addMemberRole">
                <option value="member">member (peut modifier son équipe)</option>
                <option value="viewer">viewer (lecture seule)</option>
              </select>
              <button class="btn btn-outline-primary btn-sm" type="submit">Ajouter</button>
              <div class="alert alert-danger mt-2 hidden" id="addMemberError"></div>
              <div class="alert alert-success mt-2 hidden" id="addMemberOk"></div>
            </form>

            <div class="alert alert-info mt-2 hidden" id="addMemberHint">
              Tu n’es pas manager/admin : tu peux voir le collectif, mais tu ne peux pas gérer les membres.
            </div>
          </div>

          <div class="card p-3">
            <div class="fw-bold mb-2">Debug</div>
            <div class="small mono muted" id="debugBox">—</div>
          </div>
        </div>

        <!-- Right: tasks + create task -->
        <div class="col-12 col-lg-8">
          <div class="card p-3 mb-3">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="fw-bold">Créer une tâche</div>
                <div class="small muted">Dates : début + fin. L’équipe vient du sélecteur.</div>
              </div>
              <span class="badge text-bg-light border" id="writeStatus">—</span>
            </div>

            <form id="taskForm" class="row g-2 mt-1">
              <div class="col-12 col-lg-6">
                <label class="form-label">Titre</label>
                <input class="form-control" id="taskTitle" required />
              </div>
              <div class="col-12 col-lg-6">
                <label class="form-label">Catégorie</label>
                <select class="form-select" id="taskCategory">
                  <option>Design</option>
                  <option>Dev</option>
                  <option>Marketing</option>
                  <option>Réunion</option>
                  <option>Autre</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="taskDescription" rows="2"></textarea>
              </div>

              <div class="col-6 col-lg-3">
                <label class="form-label">Début</label>
                <input type="date" class="form-control" id="taskStart" required />
              </div>
              <div class="col-6 col-lg-3">
                <label class="form-label">Fin</label>
                <input type="date" class="form-control" id="taskEnd" required />
              </div>

              <div class="col-12 col-lg-6">
                <label class="form-label">Assigné à</label>
                <select class="form-select" id="taskAssignee">
                  <option value="">Non assigné</option>
                </select>
              </div>

              <div class="col-12 d-flex gap-2 align-items-center">
                <button class="btn btn-primary" type="submit">Créer</button>
                <div class="alert alert-danger py-2 px-3 mb-0 hidden" id="taskError"></div>
                <div class="alert alert-success py-2 px-3 mb-0 hidden" id="taskOk"></div>
              </div>
            </form>
          </div>

          <div class="card p-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-bold">Tâches (liste)</div>
              <span class="badge badge-soft" id="tasksCount">0</span>
            </div>
            <div class="small muted mb-2">Affiche toutes les équipes (collectif). Tu peux filtrer avec l’équipe si tu veux.</div>

            <div class="d-flex gap-2 align-items-center mb-3">
              <select class="form-select form-select-sm w-auto" id="taskFilterMode">
                <option value="all">Tout (collectif)</option>
                <option value="team">Seulement l’équipe sélectionnée</option>
              </select>
              <select class="form-select form-select-sm w-auto" id="taskSort">
                <option value="start_asc">Trier: début ↑</option>
                <option value="start_desc">Trier: début ↓</option>
              </select>
            </div>

            <div id="tasksList" class="vstack gap-2"></div>
          </div>
        </div>
      </div>

      <!-- Calendar -->
      <div class="card p-3 mt-3">
        <div class="cal-grid mb-2" id="calHeader"></div>
        <div class="cal-grid" id="calGrid"></div>
      </div>

      <!-- Create team modal (simple) -->
      <div class="modal fade" id="createTeamModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content" style="border-radius:16px;">
            <div class="modal-header">
              <h5 class="modal-title">Créer une équipe</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-2">
                <label class="form-label">Nom</label>
                <input class="form-control" id="newTeamName" placeholder="Web" />
              </div>
              <div class="alert alert-danger hidden" id="createTeamError"></div>
              <div class="alert alert-success hidden" id="createTeamOk"></div>
              <div class="small muted">Seuls admin/manager peuvent créer des équipes.</div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
              <button class="btn btn-primary" note="btn" id="btnCreateTeamConfirm">Créer</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Bootstrap JS (pas jsdelivr) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>

  <script>
    // =========================
    // CONFIG
    // =========================
    const SUPABASE_URL = "https://yeusqubxgxchigssobma.supabase.co";
    const SUPABASE_KEY = "sb_publishable_FkwKSPbHO3CPHdRvt35img__s3HSY5R";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // =========================
    // DOM
    // =========================
    const authView = document.getElementById("authView");
    const appView  = document.getElementById("appView");

    const userEmail = document.getElementById("userEmail");
    const roleBadge = document.getElementById("roleBadge");
    const btnLogout = document.getElementById("btnLogout");

    const debugBox = document.getElementById("debugBox");

    const teamSelect = document.getElementById("teamSelect");
    const btnRefresh = document.getElementById("btnRefresh");
    const btnCreateTeam = document.getElementById("btnCreateTeam");

    const membersList = document.getElementById("membersList");
    const teamMembersCount = document.getElementById("teamMembersCount");

    const addMemberForm = document.getElementById("addMemberForm");
    const addMemberEmail = document.getElementById("addMemberEmail");
    const addMemberRole = document.getElementById("addMemberRole");
    const addMemberError = document.getElementById("addMemberError");
    const addMemberOk = document.getElementById("addMemberOk");
    const addMemberHint = document.getElementById("addMemberHint");

    const taskForm = document.getElementById("taskForm");
    const taskTitle = document.getElementById("taskTitle");
    const taskCategory = document.getElementById("taskCategory");
    const taskDescription = document.getElementById("taskDescription");
    const taskStart = document.getElementById("taskStart");
    const taskEnd = document.getElementById("taskEnd");
    const taskAssignee = document.getElementById("taskAssignee");
    const taskError = document.getElementById("taskError");
    const taskOk = document.getElementById("taskOk");
    const writeStatus = document.getElementById("writeStatus");

    const tasksList = document.getElementById("tasksList");
    const tasksCount = document.getElementById("tasksCount");
    const taskFilterMode = document.getElementById("taskFilterMode");
    const taskSort = document.getElementById("taskSort");

    const calHeader = document.getElementById("calHeader");
    const calGrid = document.getElementById("calGrid");
    const calTitle = document.getElementById("calTitle");
    const calPrev = document.getElementById("calPrev");
    const calNext = document.getElementById("calNext");
    const calToday = document.getElementById("calToday");

    const createTeamModalEl = document.getElementById("createTeamModal");
    const createTeamModal = new bootstrap.Modal(createTeamModalEl);
    const newTeamName = document.getElementById("newTeamName");
    const createTeamError = document.getElementById("createTeamError");
    const createTeamOk = document.getElementById("createTeamOk");
    const btnCreateTeamConfirm = document.getElementById("btnCreateTeamConfirm");

    // =========================
    // State
    // =========================
    let session = null;
    let user = null;
    let globalRole = null; // "admin" | "manager" | null
    let teams = [];
    let memberships = []; // team_memberships rows for current user (for UI decisions)
    let allMemberships = []; // for viewing members by team (global select allowed)
    let profilesCache = new Map(); // user_id -> profile
    let tasks = [];

    let selectedTeamId = null;

    let calDate = new Date();

    // =========================
    // Utils
    // =========================
    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function setText(idOrEl, txt){
      const el = typeof idOrEl === "string" ? document.getElementById(idOrEl) : idOrEl;
      if (el) el.textContent = txt;
    }
    function fmtDate(d){
      // d: YYYY-MM-DD
      try {
        const dt = new Date(d + "T00:00:00");
        return dt.toLocaleDateString("fr-FR");
      } catch { return d; }
    }
    function ymd(dateObj){
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth()+1).padStart(2,"0");
      const d = String(dateObj.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }
    function monthKey(dateObj){
      return `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,"0")}`;
    }
    function isBetween(dateStr, startStr, endStr){
      return dateStr >= startStr && dateStr <= endStr;
    }
    function info(msg){
      debugBox.textContent = msg;
    }

    // =========================
    // Auth UI
    // =========================
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(document.getElementById("loginError"));
      hide(document.getElementById("loginOk"));

      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;

      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        const box = document.getElementById("loginError");
        box.textContent = error.message;
        show(box);
        return;
      }
      const ok = document.getElementById("loginOk");
      ok.textContent = "Connecté.";
      show(ok);
    });

    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(document.getElementById("regError"));
      hide(document.getElementById("regOk"));

      const name = document.getElementById("regName").value.trim();
      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value;

      const { data, error } = await supabaseClient.auth.signUp({
        email,
        password,
        options: {
          data: { full_name: name }
        }
      });

      if (error) {
        const box = document.getElementById("regError");
        box.textContent = error.message;
        show(box);
        return;
      }

      const ok = document.getElementById("regOk");
      ok.textContent = "Compte créé. Tu peux te connecter.";
      show(ok);
    });

    btnLogout.addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
    });

    // =========================
    // Data loaders
    // =========================
    async function loadGlobalRole() {
      globalRole = null;
      const { data, error } = await supabaseClient
        .from("app_roles")
        .select("role")
        .eq("user_id", user.id)
        .maybeSingle();

      if (!error && data && data.role) globalRole = data.role;
    }

    async function loadTeams() {
      const { data, error } = await supabaseClient
        .from("teams")
        .select("id,name")
        .order("name", { ascending: true });

      if (error) throw error;
      teams = data || [];
    }

    async function loadMyMemberships() {
      // pour savoir si l’utilisateur est member/viewer sur telle team (UI)
      const { data, error } = await supabaseClient
        .from("team_memberships")
        .select("team_id, role")
        .eq("user_id", user.id);

      if (error) throw error;
      memberships = data || [];
    }

    async function loadAllMembershipsAndProfiles() {
      // lecture globale autorisée => on peut lister les membres par équipe
      // On récupère user_id + role + team_id + profiles(email/full_name)
      const { data, error } = await supabaseClient
        .from("team_memberships")
        .select("team_id, user_id, role, profiles!team_memberships_user_id_fkey (id, email, full_name)")
        .order("created_at", { ascending: true });

      if (error) throw error;
      allMemberships = data || [];

      profilesCache.clear();
      for (const row of allMemberships) {
        if (row.profiles && row.profiles.id) {
          profilesCache.set(row.user_id, row.profiles);
        }
      }
    }

    async function loadTasks() {
      const { data, error } = await supabaseClient
        .from("tasks")
        .select("id, team_id, title, description, category, start_date, end_date, completed, assignee_id, created_at, teams!tasks_team_id_fkey (name)")
        .order("start_date", { ascending: true });

      if (error) throw error;
      tasks = data || [];
    }

    function renderTeamSelect() {
      teamSelect.innerHTML = "";
      if (!teams.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Aucune équipe (crée-en une)";
        teamSelect.appendChild(opt);
        selectedTeamId = null;
        return;
      }

      for (const t of teams) {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        teamSelect.appendChild(opt);
      }

      // keep previous selection if still exists
      if (selectedTeamId && teams.some(t => t.id === selectedTeamId)) {
        teamSelect.value = selectedTeamId;
      } else {
        selectedTeamId = teams[0].id;
        teamSelect.value = selectedTeamId;
      }
    }

    function canWriteSelectedTeam() {
      if (!user || !selectedTeamId) return false;
      if (globalRole === "admin" || globalRole === "manager") return true;

      const my = memberships.find(m => m.team_id === selectedTeamId);
      return my && my.role === "member";
    }

    function renderWriteStatus() {
      if (!selectedTeamId) {
        writeStatus.textContent = "Sélectionne une équipe";
        writeStatus.className = "badge text-bg-light border";
        return;
      }

      if (globalRole === "admin" || globalRole === "manager") {
        writeStatus.textContent = `Écriture OK (global ${globalRole})`;
        writeStatus.className = "badge text-bg-success";
        return;
      }

      const my = memberships.find(m => m.team_id === selectedTeamId);
      if (!my) {
        writeStatus.textContent = "Lecture seule (pas membre de cette équipe)";
        writeStatus.className = "badge text-bg-secondary";
        return;
      }

      if (my.role === "viewer") {
        writeStatus.textContent = "Lecture seule (viewer)";
        writeStatus.className = "badge text-bg-secondary";
        return;
      }

      writeStatus.textContent = "Écriture OK (member sur cette équipe)";
      writeStatus.className = "badge text-bg-success";
    }

    function renderMembersList() {
      membersList.innerHTML = "";

      if (!selectedTeamId) {
        membersList.innerHTML = `<div class="muted">Aucune équipe sélectionnée.</div>`;
        setText(teamMembersCount, "0");
        return;
      }

      const rows = allMemberships.filter(r => r.team_id === selectedTeamId);

      setText(teamMembersCount, String(rows.length));

      if (!rows.length) {
        membersList.innerHTML = `<div class="muted">Aucun membre dans cette équipe.</div>`;
        return;
      }

      for (const r of rows) {
        const p = r.profiles || profilesCache.get(r.user_id) || {};
        const name = (p.full_name && p.full_name.trim()) ? p.full_name : (p.email || "inconnu");
        const email = p.email || "";

        const div = document.createElement("div");
        div.className = "d-flex align-items-center justify-content-between border rounded-3 px-3 py-2 bg-white";

        div.innerHTML = `
          <div>
            <div class="fw-semibold">${escapeHtml(name)}</div>
            <div class="muted">${escapeHtml(email)}</div>
          </div>
          <span class="badge text-bg-light border">${escapeHtml(r.role)}</span>
        `;

        membersList.appendChild(div);
      }
    }

    function renderAssigneeOptions() {
      taskAssignee.innerHTML = `<option value="">Non assigné</option>`;

      if (!selectedTeamId) return;

      const rows = allMemberships.filter(r => r.team_id === selectedTeamId);
      for (const r of rows) {
        const p = r.profiles || profilesCache.get(r.user_id) || {};
        const label = (p.full_name && p.full_name.trim()) ? `${p.full_name} (${p.email || "?"})` : (p.email || r.user_id);

        const opt = document.createElement("option");
        opt.value = r.user_id;
        opt.textContent = label;
        taskAssignee.appendChild(opt);
      }
    }

    function renderTasksList() {
      // Determine which container to use
      const container = document.getElementById('tasksListView') || document.getElementById('tasksList');
      if (!container) return;
      
      container.innerHTML = "";

      let rows = [...tasks];

      // filter mode
      if (taskFilterMode && taskFilterMode.value === "team" && selectedTeamId) {
        rows = rows.filter(t => t.team_id === selectedTeamId);
      }

      // sort
      if (taskSort && taskSort.value === "start_desc") {
        rows.sort((a,b) => (b.start_date || "").localeCompare(a.start_date || ""));
      } else {
        rows.sort((a,b) => (a.start_date || "").localeCompare(b.start_date || ""));
      }

      if (tasksCount) setText(tasksCount, String(rows.length));

      if (!rows.length) {
        container.innerHTML = `<div class="muted">Aucune tâche.</div>`;
        return;
      }

      for (const t of rows) {
        const teamName = (t.teams && t.teams.name) ? t.teams.name : "—";
        const range = `${fmtDate(t.start_date)} → ${fmtDate(t.end_date)}`;

        const div = document.createElement("div");
        div.className = "border rounded-3 px-3 py-2 bg-white mb-2";

        div.innerHTML = `
          <div class="d-flex align-items-start justify-content-between gap-2">
            <div class="flex-grow-1">
              <div class="fw-semibold">${escapeHtml(t.title)}</div>
              <div class="muted small">${escapeHtml(t.description || "")}</div>
              <div class="small mt-1">
                <span class="badge badge-soft me-1">${escapeHtml(teamName)}</span>
                <span class="badge text-bg-light border me-1">${escapeHtml(t.category || "Autre")}</span>
                <span class="badge text-bg-light border">${escapeHtml(range)}</span>
              </div>
            </div>
            <div class="text-end d-flex flex-column align-items-end gap-2">
              ${t.completed ? `<span class="badge text-bg-success">done</span>` : `<span class="badge text-bg-warning">todo</span>`}
              ${canWriteForTask(t) ? `
                <button class="btn btn-danger btn-sm" onclick="deleteTask('${t.id}')" title="Supprimer">
                  <i data-lucide="trash-2" style="width:14px;height:14px;"></i>
                </button>
              ` : ''}
              <div class="small muted mt-1">${escapeHtml(t.id.slice(0,8))}</div>
            </div>
          </div>
        `;

        // (Option) click to toggle completed if allowed
        if (canWriteForTask(t)) {
          div.classList.add("pointer");
          div.title = "Cliquer pour toggle completed";
          div.addEventListener("click", async (e) => {
            // Don't toggle if clicking the delete button
            if (e.target.closest('button')) return;
            await toggleTaskCompleted(t);
          });
        }

        container.appendChild(div);
      }
      
      // Refresh icons
      setTimeout(() => { if (window.lucide) lucide.createIcons(); }, 100);
    }

    function canWriteForTask(task) {
      // server enforces anyway; this is UI comfort
      if (!user) return false;
      if (globalRole === "admin" || globalRole === "manager") return true;

      const my = memberships.find(m => m.team_id === task.team_id);
      return my && my.role === "member";
    }

    async function toggleTaskCompleted(task) {
      try {
        const next = !task.completed;
        const { error } = await supabaseClient
          .from("tasks")
          .update({ completed: next })
          .eq("id", task.id);

        if (error) throw error;

        task.completed = next;
        renderTasksList();
        renderCalendar();

      } catch (e) {
        alert("Impossible de modifier (permissions).");
        console.error(e);
      }
    }

    // =========================
    // Calendar
    // =========================
    function renderCalendar() {
      // header
      calHeader.innerHTML = "";
      const days = ["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];
      for (const d of days) {
        const el = document.createElement("div");
        el.className = "cal-head text-center";
        el.textContent = d;
        calHeader.appendChild(el);
      }

      // title
      const monthNames = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
      calTitle.textContent = `${monthNames[calDate.getMonth()]} ${calDate.getFullYear()}`;

      // grid
      calGrid.innerHTML = "";

      const year = calDate.getFullYear();
      const month = calDate.getMonth();

      const first = new Date(year, month, 1);
      const last = new Date(year, month + 1, 0);

      // Convert to Monday-based offset
      let startDay = first.getDay(); // 0 sunday
      if (startDay === 0) startDay = 7;
      startDay = startDay - 1; // 0 = Monday

      // empty cells before
      for (let i=0; i<startDay; i++) {
        const cell = document.createElement("div");
        cell.className = "cal-cell";
        cell.style.opacity = "0.35";
        lookTodayCell(cell, null);
        calGrid.appendChild(cell);
      }

      // actual days
      for (let day=1; day<=last.getDate(); day++) {
        const dt = new Date(year, month, day);
        const dStr = ymd(dt);

        const cell = document.createElement("div");
        cell.className = "cal-cell";

        // tasks covering that day
        const todays = tasks
          .filter(t => t.start_date && t.end_date && isBetween(dStr, t.start_date, t.end_date))
          .slice(0, 5); // limit display

        let html = `<div class="d-flex align-items-center justify-content-between">
          <div class="cal-day">${day}</div>
          <div class="small muted">${dStr}</div>
        </div>`;

        for (const t of todays) {
          const teamName = (t.teams && t.teams.name) ? t.teams.name : "—";
          html += `<span class="task-pill">
            ${escapeHtml(t.title)}
            <br><small>${escapeHtml(teamName)} • ${escapeHtml(t.category || "Autre")}</small>
          </span>`;
        }

        if (!todays.length) {
          html += `<div class="small muted mt-2">—</div>`;
        } else if (tasks.filter(t => t.start_date && t.end_date && isBetween(dStr, t.start_date, t.end_date)).length > 5) {
          html += `<div class="small muted mt-2">+ plus…</div>`;
        }

        cell.innerHTML = html;
        lookTodayCell(cell, dStr);

        calGrid.appendChild(cell);
      }
    }

    function lookTodayCell(cell, dStr) {
      const today = ymd(new Date());
      if (dStr && dStr === today) {
        cell.style.outline = "2px solid rgba(13,110,253,.45)";
        cell.style.boxShadow = "0 6px 18px rgba(13,110,253,.10)";
      }
    }

    calPrev.addEventListener("click", () => {
      calDate.setMonth(calDate.getMonth() - 1);
      renderCalendar();
    });

    calNext.addEventListener("click", () => {
      calDate.setMonth(calDate.getMonth() + 1);
      renderCalendar();
    });

    calToday.addEventListener("click", () => {
      calDate = new Date();
      renderCalendar();
    });

    // =========================
    // Actions: Create team / Add member / Create task
    // =========================
    btnRefresh.addEventListener("click", async () => {
      await refreshAll();
    });

    teamSelect.addEventListener("change", () => {
      selectedTeamId = teamSelect.value || null;
      renderMembersList();
      renderAssigneeOptions();
      renderWriteStatus();
      renderTasksList();
      info(`selectedTeamId=${selectedTeamId}`);
    });

    btnCreateTeam.addEventListener("click", () => {
      hide(createTeamError); hide(createTeamOk);
      newTeamName.value = "";
      createTeamModal.show();
    });

    btnCreateTeamConfirm.addEventListener("click", async () => {
      hide(createTeamError); hide(createTeamOk);

      const name = (newTeamName.value || "").trim();
      if (!name) {
        createTeamError.textContent = "Nom requis.";
        show(createTeamError);
        return;
      }

      try {
        const { data, error } = await supabaseClient
          .from("teams")
          .insert([{ name, created_by: user.id }])
          .select("id,name")
          .single();

        if (error) throw error;

        createTeamOk.textContent = "Équipe créée.";
        show(createTeamOk);

        // auto add yourself as member of that team (optional)
        await supabaseClient
          .from("team_memberships")
          .insert([{ team_id: data.id, user_id: user.id, role: "member" }]);

        await refreshAll();
        selectedTeamId = data.id;
        renderTeamSelect();
        teamSelect.value = selectedTeamId;
        renderMembersList();
        renderAssigneeOptions();
        renderWriteStatus();

      } catch (e) {
        createTeamError.textContent = e.message || "Erreur création équipe.";
        show(createTeamError);
        console.error(e);
      }
    });

    addMemberForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(addMemberError); hide(addMemberOk);

      const email = (addMemberEmail.value || "").trim().toLowerCase();
      const role = addMemberRole.value;

      if (!selectedTeamId) {
        addMemberError.textContent = "Sélectionne une équipe.";
        show(addMemberError);
        return;
      }

      try {
        // find profile by email
        const { data: prof, error: pErr } = await supabaseClient
          .from("profiles")
          .select("id,email,full_name")
          .eq("email", email)
          .maybeSingle();

        if (pErr) throw pErr;
        if (!prof) {
          addMemberError.textContent = "Aucun profile trouvé avec cet email. Le user doit d’abord créer un compte.";
          show(addMemberError);
          return;
        }

        const { error: mErr } = await supabaseClient
          .from("team_memberships")
          .insert([{ team_id: selectedTeamId, user_id: prof.id, role }]);

        if (mErr) throw mErr;

        addMemberOk.textContent = "Membre ajouté.";
        show(addMemberOk);

        addMemberEmail.value = "";
        await refreshAll();

      } catch (e2) {
        addMemberError.textContent = e2.message || "Erreur ajout membre (permissions ?).";
        show(addMemberError);
        console.error(e2);
      }
    });

    taskForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(taskError); hide(taskOk);

      if (!selectedTeamId) {
        taskError.textContent = "Sélectionne une équipe.";
        show(taskError);
        return;
      }

      const start = taskStart.value;
      const end = taskEnd.value;
      if (end < start) {
        taskError.textContent = "La date de fin doit être >= date de début.";
        show(taskError);
        return;
      }

      try {
        const payload = {
          team_id: selectedTeamId,
          title: taskTitle.value.trim(),
          description: taskDescription.value.trim() || null,
          category: taskCategory.value || "Autre",
          start_date: start,
          end_date: end,
          completed: false,
          assignee_id: taskAssignee.value || null,
          created_by: user.id
        };

        const { error } = await supabaseClient
          .from("tasks")
          .insert([payload]);

        if (error) throw error;

        taskOk.textContent = "Tâche créée.";
        show(taskOk);

        taskTitle.value = "";
        taskDescription.value = "";

        await refreshAll();

      } catch (e3) {
        taskError.textContent = e3.message || "Erreur création tâche (permissions ?).";
        show(taskError);
        console.error(e3);
      }
    });

    taskFilterMode.addEventListener("change", renderTasksList);
    taskSort.addEventListener("change", renderTasksList);

    // =========================
    // Refresh orchestration
    // =========================
    async function refreshAll() {
      info("refresh…");

      await loadGlobalRole();
      await loadTeams();
      await loadMyMemberships();
      await loadAllMembershipsAndProfiles();
      await loadTasks();

      // teams selection
      if (!selectedTeamId && teams.length) selectedTeamId = teams[0].id;

      renderTeamSelect();
      renderWriteStatus();

      // permissions UI
      const isGlobal = (globalRole === "admin" || globalRole === "manager");

      if (isGlobal) {
        show(btnCreateTeam);
        show(addMemberForm);
        hide(addMemberHint);
      } else {
        hide(btnCreateTeam);
        hide(addMemberForm);
        show(addMemberHint);
      }

      // assignees/members
      renderMembersList();
      renderAssigneeOptions();

      // tasks + list + calendar
      renderTasksList();
      renderCalendar();

      // status badge
      roleBadge.textContent = globalRole ? `global: ${globalRole}` : `global: standard`;
      info(`user=${user.email} | globalRole=${globalRole || "none"} | teams=${teams.length} | tasks=${tasks.length}`);
    }

    // =========================
    // HTML escape
    // =========================
    function escapeHtml(str) {
      if (str === null || str === undefined) return "";
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // =========================
    // Boot
    // =========================
    async function setAuthedUI() {
      hide(authView);
      show(appView);
      show(btnLogout);

      userEmail.textContent = user.email || "";
      await refreshAll();

      // default dates to today
      const today = ymd(new Date());
      if (!taskStart.value) taskStart.value = today;
      if (!taskEnd.value) taskEnd.value = today;

      // Initialize views - show calendar by default
      initializeViews();

      // icons
      if (window.lucide) lucide.createIcons();
    }

    function setAnonUI() {
      show(authView);
      hide(appView);
      hide(btnLogout);

      userEmail.textContent = "";
      roleBadge.textContent = "non connecté";
      info("—");
    }

    (async () => {
      // init session
      const { data } = await supabaseClient.auth.getSession();
      session = data.session;
      user = session ? session.user : null;

      if (user) await setAuthedUI();
      else setAnonUI();

      // auth state changes
      supabaseClient.auth.onAuthStateChange(async (_event, newSession) => {
        session = newSession;
        user = newSession ? newSession.user : null;

        if (user) await setAuthedUI();
        else setAnonUI();
      });

      if (window.lucide) lucide.createIcons();
    })();

    // =========================
    // IMPORT / EXPORT FUNCTIONS
    // =========================
    
    // Download CSV template for tasks
    function downloadTasksTemplate() {
      const csv = `titre,description,categorie,date_debut,date_fin,equipe,priorite
Exemple tâche 1,Description de la tâche,Dev,2026-02-01,2026-02-15,Développement,haute
Exemple tâche 2,Autre description,Design,2026-02-05,2026-02-10,Design,moyenne`;
      
      downloadCSV(csv, 'modele_taches.csv');
    }
    
    // Download CSV template for teams
    function downloadTeamsTemplate() {
      const csv = `nom,description
Développement,Équipe de développement
Design,Équipe de design
Marketing,Équipe marketing`;
      
      downloadCSV(csv, 'modele_equipes.csv');
    }
    
    // Download CSV template for members
    function downloadMembersTemplate() {
      const csv = `email,nom_complet,equipe,role
john@exemple.com,John Doe,Développement,member
jane@exemple.com,Jane Smith,Design,member
bob@exemple.com,Bob Martin,Marketing,viewer`;
      
      downloadCSV(csv, 'modele_membres.csv');
    }
    
    // Helper to download CSV
    function downloadCSV(content, filename) {
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }
    
    // Import tasks from CSV/Excel
    async function importTasks(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const lines = text.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) {
          alert('❌ Fichier vide ou invalide');
          return;
        }
        
        // Skip header
        const dataLines = lines.slice(1);
        let imported = 0;
        let errors = 0;
        
        for (const line of dataLines) {
          const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
          
          if (values.length < 5) {
            errors++;
            continue;
          }
          
          const [titre, description, categorie, date_debut, date_fin, equipe_nom, priorite] = values;
          
          // Find team by name
          let team_id = selectedTeamId;
          if (equipe_nom) {
            const team = teams.find(t => t.name.toLowerCase() === equipe_nom.toLowerCase());
            if (team) team_id = team.id;
          }
          
          if (!team_id) {
            errors++;
            continue;
          }
          
          try {
            const { error } = await supabaseClient
              .from('tasks')
              .insert([{
                title: titre,
                description: description || '',
                category: categorie || 'Autre',
                start_date: date_debut,
                end_date: date_fin,
                team_id: team_id,
                created_by: user.id,
                completed: false
              }]);
            
            if (error) throw error;
            imported++;
          } catch (e) {
            console.error('Erreur import tâche:', e);
            errors++;
          }
        }
        
        await refreshAll();
        alert(`✅ Import terminé!\n${imported} tâche(s) importée(s)\n${errors} erreur(s)`);
        event.target.value = ''; // Reset input
        
      } catch (error) {
        console.error('Erreur:', error);
        alert('❌ Erreur lors de l\'import: ' + error.message);
      }
    }
    
    // Import teams or members from CSV/Excel
    async function importTeamsOrMembers(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const lines = text.split('\n').filter(line => line.trim());
        
        if (lines.length < 2) {
          alert('❌ Fichier vide ou invalide');
          return;
        }
        
        const header = lines[0].toLowerCase();
        
        // Detect if it's teams or members
        if (header.includes('email')) {
          await importMembers(lines);
        } else {
          await importTeams(lines);
        }
        
        event.target.value = ''; // Reset input
        
      } catch (error) {
        console.error('Erreur:', error);
        alert('❌ Erreur lors de l\'import: ' + error.message);
      }
    }
    
    async function importTeams(lines) {
      const dataLines = lines.slice(1);
      let imported = 0;
      let errors = 0;
      
      for (const line of dataLines) {
        const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
        
        if (values.length < 1) {
          errors++;
          continue;
        }
        
        const [nom, description] = values;
        
        try {
          const { error } = await supabaseClient
            .from('teams')
            .insert([{
              name: nom,
              description: description || '',
              created_by: user.id
            }]);
          
          if (error) throw error;
          imported++;
        } catch (e) {
          console.error('Erreur import équipe:', e);
          errors++;
        }
      }
      
      await refreshAll();
      alert(`✅ Import terminé!\n${imported} équipe(s) importée(s)\n${errors} erreur(s)`);
    }
    
    async function importMembers(lines) {
      const dataLines = lines.slice(1);
      let imported = 0;
      let errors = 0;
      
      for (const line of dataLines) {
        const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
        
        if (values.length < 3) {
          errors++;
          continue;
        }
        
        const [email, nom_complet, equipe_nom, role] = values;
        
        // Find team by name
        const team = teams.find(t => t.name.toLowerCase() === equipe_nom.toLowerCase());
        if (!team) {
          errors++;
          continue;
        }
        
        // Find user by email in profiles
        try {
          const { data: profiles, error: profileError } = await supabaseClient
            .from('profiles')
            .select('user_id')
            .eq('email', email)
            .single();
          
          if (profileError || !profiles) {
            errors++;
            continue;
          }
          
          const { error } = await supabaseClient
            .from('team_memberships')
            .insert([{
              team_id: team.id,
              user_id: profiles.user_id,
              role: role || 'member'
            }]);
          
          if (error) throw error;
          imported++;
        } catch (e) {
          console.error('Erreur import membre:', e);
          errors++;
        }
      }
      
      await refreshAll();
      alert(`✅ Import terminé!\n${imported} membre(s) importé(s)\n${errors} erreur(s)`);
    }
    
    // Make functions global
    window.downloadTasksTemplate = downloadTasksTemplate;
    window.downloadTeamsTemplate = downloadTeamsTemplate;
    window.downloadMembersTemplate = downloadMembersTemplate;
    window.importTasks = importTasks;
    window.importTeamsOrMembers = importTeamsOrMembers;

    // =========================
    // DELETE & EDIT TASKS
    // =========================
    async function deleteTask(taskId) {
      if (!confirm('Supprimer cette tâche définitivement ?')) return;
      
      try {
        const { error } = await supabaseClient
          .from('tasks')
          .delete()
          .eq('id', taskId);
        
        if (error) throw error;
        
        await refreshAll();
        alert('✅ Tâche supprimée');
      } catch (error) {
        console.error('Erreur:', error);
        alert('❌ Erreur: ' + error.message);
      }
    }

    async function removeMember(teamId, userId) {
      if (!confirm('Retirer ce membre de l\'équipe ?')) return;
      
      try {
        const { error } = await supabaseClient
          .from('team_memberships')
          .delete()
          .eq('team_id', teamId)
          .eq('user_id', userId);
        
        if (error) throw error;
        
        await refreshAll();
        alert('✅ Membre retiré');
      } catch (error) {
        console.error('Erreur:', error);
        alert('❌ Erreur: ' + error.message);
      }
    }

    // =========================
    // NAVIGATION SIDEBAR
    // =========================
    function showDashboard(e) {
      if(e) e.preventDefault();
      updateNavActive(e);
      
      // Hide all views
      document.getElementById('dashboardView').classList.remove('hidden');
      document.getElementById('calendarView').classList.add('hidden');
      document.getElementById('tasksView').classList.add('hidden');
      document.getElementById('teamsView').classList.add('hidden');
      
      // Update header
      document.getElementById('pageTitle').textContent = 'Tableau de bord';
      document.getElementById('pageSubtitle').textContent = 'Vue d\'ensemble de toutes les équipes';
      
      // Refresh dashboard stats
      refreshDashboardStats();
      
      if (window.lucide) lucide.createIcons();
    }

    function showCalendar(e) {
      if(e) e.preventDefault();
      updateNavActive(e);
      
      // Hide all views
      document.getElementById('dashboardView').classList.add('hidden');
      document.getElementById('calendarView').classList.remove('hidden');
      document.getElementById('tasksView').classList.add('hidden');
      document.getElementById('teamsView').classList.add('hidden');
      
      // Update header
      document.getElementById('pageTitle').textContent = 'Calendrier';
      const month = calDate.getMonth();
      const months = ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
      document.getElementById('pageSubtitle').textContent = `${months[month]} ${calDate.getFullYear()}`;
      
      // Render calendar
      renderCalendar();
      
      if (window.lucide) lucide.createIcons();
    }

    function showTasks(e) {
      if(e) e.preventDefault();
      updateNavActive(e);
      
      // Hide all views
      document.getElementById('dashboardView').classList.add('hidden');
      document.getElementById('calendarView').classList.add('hidden');
      document.getElementById('tasksView').classList.remove('hidden');
      document.getElementById('teamsView').classList.add('hidden');
      
      // Update header
      document.getElementById('pageTitle').textContent = 'Tâches';
      document.getElementById('pageSubtitle').textContent = 'Gestion des tâches';
      
      // Render tasks
      renderTasksList();
      
      if (window.lucide) lucide.createIcons();
    }

    function showTeams(e) {
      if(e) e.preventDefault();
      updateNavActive(e);
      
      // Hide all views
      document.getElementById('dashboardView').classList.add('hidden');
      document.getElementById('calendarView').classList.add('hidden');
      document.getElementById('tasksView').classList.add('hidden');
      document.getElementById('teamsView').classList.remove('hidden');
      
      // Update header
      document.getElementById('pageTitle').textContent = 'Équipes';
      document.getElementById('pageSubtitle').textContent = 'Gestion des équipes et membres';
      
      // Render teams
      renderMembersList();
      
      if (window.lucide) lucide.createIcons();
    }

    function quickFilter(type, e) {
      if(e) e.preventDefault();
      updateNavActive(e);
      
      // Show tasks view with filter
      document.getElementById('dashboardView').classList.add('hidden');
      document.getElementById('calendarView').classList.add('hidden');
      document.getElementById('tasksView').classList.remove('hidden');
      document.getElementById('teamsView').classList.add('hidden');
      
      const titles = {
        'mine': 'Mes tâches',
        'late': 'En retard',
        'week': 'Cette semaine'
      };
      document.getElementById('pageTitle').textContent = titles[type] || type;
      document.getElementById('pageSubtitle').textContent = 'Vue filtrée';
      
      // Apply filter (you can customize this)
      renderTasksList();
      
      if (window.lucide) lucide.createIcons();
    }

    function updateNavActive(e) {
      if(!e || !e.target) return;
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      e.target.closest('.nav-item').classList.add('active');
    }

    // Make functions global - AFTER declarations
    window.deleteTask = deleteTask;
    window.removeMember = removeMember;
    window.showDashboard = showDashboard;
    window.showCalendar = showCalendar;
    window.showTasks = showTasks;
    window.showTeams = showTeams;
    window.quickFilter = quickFilter;

    function refreshDashboardStats() {
      // Update dashboard statistics
      document.getElementById('totalTasks').textContent = tasks.length;
      document.getElementById('doneTasks').textContent = tasks.filter(t => t.completed).length;
      document.getElementById('inProgressTasks').textContent = tasks.filter(t => !t.completed && new Date(t.end_date) >= new Date()).length;
      
      const today = new Date();
      today.setHours(0,0,0,0);
      document.getElementById('lateTasks').textContent = tasks.filter(t => !t.completed && new Date(t.end_date) < today).length;
      
      // You can add more dashboard rendering here (charts, etc.)
    }

    // Initialize with calendar view on load
    function initializeViews() {
      // Show calendar by default when logged in
      document.getElementById('calendarView').classList.remove('hidden');
      renderCalendar();
    }
  </script>

  </main>
  </div>
  </div>

</body>
</html>
