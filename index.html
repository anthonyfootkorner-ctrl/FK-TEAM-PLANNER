<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TaskFlow - Gestion d'équipe</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" />

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    /* RESET & BASE */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --sidebar-bg: #1a1d29;
      --sidebar-hover: #252836;
      --orange: #FF6B35;
      --orange-dark: #E85528;
      --white: #FFFFFF;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --text-primary: #111827;
      --text-secondary: #6B7280;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
      background: #f0f2f5 !important;
      color: var(--text-primary) !important;
      overflow: hidden !important;
    }

    /* LAYOUT FLEX */
    body > .container {
      display: flex !important;
      height: 100vh !important;
      max-width: 100% !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    /* SIDEBAR */
    .sidebar {
      width: 240px;
      background: var(--sidebar-bg);
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 12px rgba(0,0,0,0.1);
      z-index: 1000;
      padding: 1.5rem 0;
    }

    .sidebar-logo {
      padding: 0 1.5rem 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 1rem;
    }

    .logo-content {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: white;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--orange), var(--orange-dark));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
    }

    .logo-text {
      font-weight: 700;
      font-size: 1.1rem;
    }

    .logo-subtitle {
      font-size: 0.75rem;
      color: var(--gray-400);
      display: block;
      margin-top: 0.125rem;
    }

    .sidebar-nav {
      flex: 1;
      padding: 0 0.75rem;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      color: var(--gray-400);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 0.25rem;
    }

    .nav-item:hover {
      background: var(--sidebar-hover);
      color: white;
    }

    .nav-item.active {
      background: var(--orange);
      color: white;
    }

    .nav-section-title {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 1.5rem 1rem 0.75rem;
    }

    /* MAIN CONTENT */
    .main-wrapper {
      margin-left: 240px;
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* TOP BAR */
    .top-bar {
      background: white;
      border-bottom: 1px solid var(--gray-200);
      padding: 0 2rem;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .page-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .page-subtitle {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin: 0.25rem 0 0 0;
    }

    /* CONTENT AREA */
    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
      background: #f0f2f5;
    }

    /* CARDS */
    .card {
      background: white !important;
      border: 1px solid var(--gray-200) !important;
      border-radius: 12px !important;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05) !important;
    }

    /* STAT CARDS */
    .stat-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1.5rem;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    /* PROGRESS BARS */
    .progress-item {
      margin-bottom: 1rem;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .progress {
      height: 8px;
      border-radius: 999px;
      background: var(--gray-100);
    }

    .progress-bar {
      border-radius: 999px;
    }

    /* CALENDAR */
    .calendar-header-custom {
      background: white;
      padding: 1.5rem 2rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .cal-grid {
      background: white !important;
      border-radius: 12px !important;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05) !important;
      display: grid !important;
      grid-template-columns: repeat(7, 1fr) !important;
      gap: 0 !important;
    }

    .cal-head {
      background: var(--gray-50) !important;
      color: var(--gray-500) !important;
      padding: 1rem !important;
      text-align: center !important;
      font-weight: 600 !important;
      font-size: 0.875rem !important;
      border-bottom: 1px solid var(--gray-200) !important;
    }

    .cal-cell {
      background: white !important;
      border-right: 1px solid var(--gray-100) !important;
      border-bottom: 1px solid var(--gray-100) !important;
      padding: 12px !important;
      min-height: 120px !important;
      transition: background 0.2s ease !important;
      border-radius: 0 !important;
    }

    .cal-cell:nth-child(7n) {
      border-right: none !important;
    }

    .cal-cell:hover {
      background: var(--gray-50) !important;
    }

    .cal-day {
      font-weight: 600 !important;
      color: var(--text-primary) !important;
      font-size: 0.95rem !important;
    }

    .task-pill {
      background: var(--orange) !important;
      color: white !important;
      padding: 4px 8px !important;
      border-radius: 6px !important;
      font-size: 0.75rem !important;
      font-weight: 500 !important;
      display: block !important;
      margin-top: 6px !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
    }

    .task-pill small {
      color: rgba(255,255,255,0.9) !important;
    }

    /* TASK CARD */
    .task-card {
      border: 1px solid var(--gray-200);
      border-left: 4px solid;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      background: white;
      transition: all 0.2s ease;
    }

    .task-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }

    .task-card.priority-haute { border-left-color: #EF4444; }
    .task-card.priority-moyenne { border-left-color: #FBBF24; }
    .task-card.priority-basse { border-left-color: #6B7280; }

    /* TEAM CARD */
    .team-card {
      border-radius: 12px;
      padding: 1.5rem;
      color: white;
      margin-bottom: 1rem;
      position: relative;
      overflow: hidden;
    }

    .team-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, transparent 0%, rgba(0,0,0,0.1) 100%);
      pointer-events: none;
    }

    /* EVENT CARD */
    .event-card {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      background: white;
      margin-bottom: 0.75rem;
      transition: all 0.2s ease;
    }

    .event-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .event-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* BUTTONS */
    .btn {
      border-radius: 8px !important;
      font-weight: 500 !important;
      transition: all 0.2s ease !important;
    }

    .btn-primary {
      background: var(--orange) !important;
      border: none !important;
      color: white !important;
    }

    .btn-primary:hover {
      background: var(--orange-dark) !important;
    }

    .btn-outline-secondary,
    .btn-secondary {
      background: white !important;
      border: 1px solid var(--gray-300) !important;
      color: var(--gray-700) !important;
    }

    .btn-outline-secondary:hover,
    .btn-secondary:hover {
      background: var(--gray-50) !important;
      border-color: var(--gray-400) !important;
    }

    .btn-outline-primary {
      background: transparent !important;
      border: 2px solid var(--orange) !important;
      color: var(--orange) !important;
    }

    .btn-outline-primary:hover {
      background: var(--orange) !important;
      color: white !important;
    }

    .btn-danger {
      background: #DC2626 !important;
      border: none !important;
      color: white !important;
    }

    .btn-danger:hover {
      background: #B91C1C !important;
    }

    /* FORMS */
    .form-control,
    .form-select {
      background: white !important;
      border: 1px solid var(--gray-300) !important;
      color: var(--text-primary) !important;
      border-radius: 8px !important;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--orange) !important;
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1) !important;
    }

    .form-label {
      color: var(--gray-700) !important;
      font-weight: 600 !important;
      font-size: 0.875rem !important;
    }

    /* BADGES */
    .badge {
      border-radius: 999px !important;
      font-size: 0.8rem !important;
      padding: 0.35rem 0.75rem !important;
    }

    .badge-soft {
      background: rgba(255, 107, 53, 0.1) !important;
      color: var(--orange) !important;
    }

    /* ALERTS */
    .alert {
      border-radius: 10px !important;
      border: 1px solid !important;
    }

    .alert-danger {
      background: rgba(220, 38, 38, 0.1) !important;
      color: #DC2626 !important;
      border-color: rgba(220, 38, 38, 0.3) !important;
    }

    .alert-success {
      background: rgba(34, 197, 94, 0.1) !important;
      color: #059669 !important;
      border-color: rgba(34, 197, 94, 0.3) !important;
    }

    /* UTILITIES */
    .hidden {
      display: none !important;
    }

    .pointer {
      cursor: pointer !important;
    }

    /* SCROLLBAR */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--gray-100);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-400);
    }

    /* RESPONSIVE */
    @media (max-width: 968px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .main-wrapper {
        margin-left: 0;
      }
    }
  </style>
</head>

<body>
  <div class="container py-4">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <div class="logo-content">
          <div class="logo-icon">TF</div>
          <div>
            <div class="logo-text">TaskFlow</div>
            <span class="logo-subtitle">Gestion d'équipe</span>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <a href="#" class="nav-item" data-view="dashboard">
          <i data-lucide="layout-dashboard" style="width:20px;height:20px;"></i>
          Tableau de bord
        </a>
        <a href="#" class="nav-item active" data-view="calendar">
          <i data-lucide="calendar" style="width:20px;height:20px;"></i>
          Calendrier
        </a>
        <a href="#" class="nav-item" data-view="tasks">
          <i data-lucide="check-square" style="width:20px;height:20px;"></i>
          Tâches
        </a>
        <a href="#" class="nav-item" data-view="teams">
          <i data-lucide="users" style="width:20px;height:20px;"></i>
          Équipes
        </a>
        <a href="#" class="nav-item" data-view="events">
          <i data-lucide="star" style="width:20px;height:20px;"></i>
          Événements
        </a>

        <div class="nav-section-title">VUES RAPIDES</div>
        <a href="#" class="nav-item" data-filter="mine">
          <i data-lucide="user" style="width:20px;height:20px;"></i>
          Mes tâches
        </a>
        <a href="#" class="nav-item" data-filter="late">
          <i data-lucide="alert-circle" style="width:20px;height:20px;"></i>
          En retard
        </a>
        <a href="#" class="nav-item" data-filter="week">
          <i data-lucide="calendar-days" style="width:20px;height:20px;"></i>
          Cette semaine
        </a>
      </nav>
    </aside>

    <!-- MAIN WRAPPER -->
    <div class="main-wrapper">

      <!-- TOP BAR -->
      <header class="top-bar">
        <div>
          <h1 class="page-title" id="pageTitle">Calendrier</h1>
          <p class="page-subtitle" id="pageSubtitle">Janvier 2026</p>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="badge text-bg-light border" id="roleBadge">non connecté</span>
          <span class="text-secondary small" id="userEmail"></span>
          <button class="btn btn-outline-secondary btn-sm hidden" id="btnLogout">Se déconnecter</button>
        </div>
      </header>

      <!-- CONTENT AREA -->
      <main class="content-area" id="mainContentArea">

        <!-- AUTH VIEW -->
        <div id="authView" class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card p-4">
              <h4 class="mb-1">Connexion</h4>
              <p class="text-secondary mb-4">Connecte-toi pour accéder à TaskFlow.</p>

              <form id="loginForm" class="vstack gap-2">
                <div>
                  <label class="form-label" for="loginEmail">Email</label>
                  <input class="form-control" type="email" id="loginEmail" required />
                </div>
                <div>
                  <label class="form-label" for="loginPassword">Mot de passe</label>
                  <input class="form-control" type="password" id="loginPassword" required />
                </div>
                <button class="btn btn-primary mt-2" type="submit">Se connecter</button>
              </form>

              <div class="alert alert-danger mt-3 hidden" id="loginError"></div>
              <div class="alert alert-success mt-3 hidden" id="loginOk"></div>
            </div>
          </div>

          <div class="col-12 col-lg-6">
            <div class="card p-4">
              <h4 class="mb-1">Créer un compte</h4>
              <p class="text-secondary mb-4">Inscription simple (email + mot de passe).</p>

              <form id="registerForm" class="vstack gap-2">
                <div>
                  <label class="form-label" for="regName">Nom complet (optionnel)</label>
                  <input class="form-control" type="text" id="regName" placeholder="Anthony POIGNARD" />
                </div>
                <div>
                  <label class="form-label" for="regEmail">Email</label>
                  <input class="form-control" type="email" id="regEmail" required />
                </div>
                <div>
                  <label class="form-label" for="regPassword">Mot de passe</label>
                  <input class="form-control" type="password" id="regPassword" required minlength="6" />
                  <div class="form-text">Min 6 caractères.</div>
                </div>

                <button class="btn btn-outline-primary mt-2" type="submit">Créer le compte</button>
              </form>

              <div class="alert alert-danger mt-3 hidden" id="regError"></div>
              <div class="alert alert-success mt-3 hidden" id="regOk"></div>
            </div>
          </div>
        </div>

        <!-- APP VIEW -->
        <div id="appView" class="hidden">

          <!-- DASHBOARD VIEW -->
          <div id="dashboardView" class="hidden">
            <div class="row g-3 mb-4">
              <div class="col-12 col-lg-3">
                <div class="stat-card">
                  <div class="d-flex align-items-center gap-3">
                    <div class="stat-icon" style="background:rgba(59,130,246,0.1);">
                      <i data-lucide="clipboard-list" style="width:24px;height:24px;color:#3B82F6;"></i>
                    </div>
                    <div>
                      <div class="stat-label">Total des tâches</div>
                      <div class="stat-value" id="totalTasks">0</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-lg-3">
                <div class="stat-card">
                  <div class="d-flex align-items-center gap-3">
                    <div class="stat-icon" style="background:rgba(34,197,94,0.1);">
                      <i data-lucide="check-circle" style="width:24px;height:24px;color:#22C55E;"></i>
                    </div>
                    <div>
                      <div class="stat-label">Terminées</div>
                      <div class="stat-value" id="doneTasks">0</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-lg-3">
                <div class="stat-card">
                  <div class="d-flex align-items-center gap-3">
                    <div class="stat-icon" style="background:rgba(251,191,36,0.1);">
                      <i data-lucide="clock" style="width:24px;height:24px;color:#FBBF24;"></i>
                    </div>
                    <div>
                      <div class="stat-label">En cours</div>
                      <div class="stat-value" id="inProgressTasks">0</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-lg-3">
                <div class="stat-card">
                  <div class="d-flex align-items-center gap-3">
                    <div class="stat-icon" style="background:rgba(239,68,68,0.1);">
                      <i data-lucide="alert-triangle" style="width:24px;height:24px;color:#EF4444;"></i>
                    </div>
                    <div>
                      <div class="stat-label">En retard</div>
                      <div class="stat-value text-danger" id="lateTasks">0</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-12 col-lg-6">
                <div class="card p-4">
                  <h5 class="mb-3">Répartition par statut</h5>
                  <div id="statusBreakdown"></div>
                </div>
              </div>
              <div class="col-12 col-lg-6">
                <div class="card p-4">
                  <h5 class="mb-3">Répartition par priorité</h5>
                  <div id="priorityBreakdown"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- CALENDAR VIEW -->
          <div id="calendarView" class="hidden">
            <div class="calendar-header-custom">
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="calPrev">
                  <i data-lucide="chevron-left"></i>
                </button>
                <div class="fw-semibold" style="min-width:140px;text-align:center;" id="calTitle"></div>
                <button class="btn btn-outline-secondary btn-sm" id="calNext">
                  <i data-lucide="chevron-right"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="calToday">Aujourd'hui</button>
              </div>
            </div>

            <div class="cal-grid" id="calGrid">
              <div class="cal-head">Lun</div>
              <div class="cal-head">Mar</div>
              <div class="cal-head">Mer</div>
              <div class="cal-head">Jeu</div>
              <div class="cal-head">Ven</div>
              <div class="cal-head">Sam</div>
              <div class="cal-head">Dim</div>
            </div>
          </div>

          <!-- TASKS VIEW -->
          <div id="tasksView" class="hidden">
            <div class="row g-3">
              <div class="col-12">
                <div class="card p-3">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Tâches</h5>
                    <div class="d-flex gap-2">
                      <button class="btn btn-outline-secondary btn-sm" onclick="downloadTasksTemplate()">
                        <i data-lucide="download" style="width:14px;height:14px;"></i>
                        Modèle
                      </button>
                      <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('importTasksFile').click()">
                        <i data-lucide="upload" style="width:14px;height:14px;"></i>
                        Import CSV
                      </button>
                      <input type="file" id="importTasksFile" accept=".csv,.xlsx" style="display:none;" onchange="importTasks(event)">
                      <button class="btn btn-success btn-sm" onclick="exportTasksCSV()">
                        <i data-lucide="download" style="width:14px;height:14px;"></i>
                        Export CSV
                      </button>
                      <button class="btn btn-success btn-sm" onclick="exportTasksJSON()">
                        <i data-lucide="download" style="width:14px;height:14px;"></i>
                        Export JSON
                      </button>
                      <button class="btn btn-primary btn-sm" onclick="exportTasksiCal()">
                        <i data-lucide="calendar" style="width:14px;height:14px;"></i>
                        Export iCal
                      </button>
                    </div>
                  </div>

                  <div class="d-flex gap-2 mb-3">
                    <select class="form-select form-select-sm" id="taskStatusFilter" style="width:auto;">
                      <option value="">Tous</option>
                      <option value="todo">À faire</option>
                      <option value="done">Terminées</option>
                    </select>
                    <select class="form-select form-select-sm" id="taskPriorityFilter" style="width:auto;">
                      <option value="">Toutes</option>
                      <option value="haute">Haute</option>
                      <option value="moyenne">Moyenne</option>
                      <option value="basse">Basse</option>
                    </select>
                    <select class="form-select form-select-sm" id="taskTeamFilter" style="width:auto;">
                      <option value="">Toutes</option>
                    </select>
                  </div>

                  <div id="tasksListView"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- TEAMS VIEW -->
          <div id="teamsView" class="hidden">
            <div class="row g-3 mb-3">
              <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h5>Équipes</h5>
                    <p class="text-secondary small mb-0">Gérez vos équipes et leurs tâches</p>
                  </div>
                  <button class="btn btn-primary" onclick="showCreateTeamModal()">
                    <i data-lucide="plus" style="width:16px;height:16px;"></i>
                    Nouvelle équipe
                  </button>
                </div>
              </div>
            </div>

            <div class="row g-3" id="teamsGrid"></div>
          </div>

          <!-- EVENTS VIEW -->
          <div id="eventsView" class="hidden">
            <div class="row g-3 mb-3">
              <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h5>Événements</h5>
                    <p class="text-secondary small mb-0">Jours fériés, soldes et événements spéciaux</p>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('importEventsFile').click()">
                      <i data-lucide="upload" style="width:14px;height:14px;"></i>
                      Import CSV
                    </button>
                    <input type="file" id="importEventsFile" accept=".csv" style="display:none;" onchange="importEvents(event)">
                    <button class="btn btn-success btn-sm" onclick="exportEventsCSV()">
                      <i data-lucide="download" style="width:14px;height:14px;"></i>
                      Export CSV
                    </button>
                    <button class="btn btn-success btn-sm" onclick="exportEventsJSON()">
                      <i data-lucide="download" style="width:14px;height:14px;"></i>
                      Export JSON
                    </button>
                    <button class="btn btn-primary" onclick="showCreateEventModal()">
                      <i data-lucide="plus" style="width:16px;height:16px;"></i>
                      Nouvel événement
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div id="eventsListView"></div>
          </div>

        </div>

      </main>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>

  <script>
    // =========================
    // CONFIG
    // =========================
    const SUPABASE_URL = "https://yeusqubxgxchigssobma.supabase.co";
    const SUPABASE_KEY = "sb_publishable_FkwKSPbHO3CPHdRvt35img__s3HSY5R";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // =========================
    // STATE
    // =========================
    let session = null;
    let user = null;
    let globalRole = null;
    let teams = [];
    let tasks = [];
    let events = [];
    let memberships = [];
    let calDate = new Date();

    // =========================
    // UTILS
    // =========================
    function show(el){ if(el) el.classList.remove("hidden"); }
    function hide(el){ if(el) el.classList.add("hidden"); }
    function setText(el, txt){ if(el) el.textContent = txt; }
    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function ymd(dateObj){
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth()+1).padStart(2,"0");
      const d = String(dateObj.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }
    function fmtDate(d){
      try {
        const dt = new Date(d + "T00:00:00");
        return dt.toLocaleDateString("fr-FR");
      } catch { return d; }
    }
    function isBetween(dateStr, startStr, endStr){
      return dateStr >= startStr && dateStr <= endStr;
    }

    // =========================
    // NAVIGATION
    // =========================
    function switchView(viewName) {
      // Hide all views
      const views = ['dashboardView', 'calendarView', 'tasksView', 'teamsView', 'eventsView'];
      views.forEach(v => {
        const el = document.getElementById(v);
        if (el) hide(el);
      });

      // Show selected view
      const viewEl = document.getElementById(viewName);
      if (viewEl) show(viewEl);

      // Update active nav
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      const activeNav = document.querySelector(`.nav-item[data-view="${viewName.replace('View', '')}"]`);
      if (activeNav) activeNav.classList.add('active');

      // Update page title
      const titles = {
        dashboardView: { title: 'Tableau de bord', subtitle: 'Vue d\'ensemble de toutes les équipes' },
        calendarView: { title: 'Calendrier', subtitle: `${monthNames[calDate.getMonth()]} ${calDate.getFullYear()}` },
        tasksView: { title: 'Tâches', subtitle: 'Gestion des tâches' },
        teamsView: { title: 'Équipes', subtitle: 'Gestion des équipes' },
        eventsView: { title: 'Événements', subtitle: 'Jours fériés et événements spéciaux' }
      };

      const titleData = titles[viewName];
      if (titleData) {
        setText(document.getElementById('pageTitle'), titleData.title);
        setText(document.getElementById('pageSubtitle'), titleData.subtitle);
      }

      // Render view content
      if (viewName === 'dashboardView') renderDashboard();
      else if (viewName === 'calendarView') renderCalendar();
      else if (viewName === 'tasksView') renderTasksList();
      else if (viewName === 'teamsView') renderTeamsGrid();
      else if (viewName === 'eventsView') renderEventsList();

      // Refresh icons
      if (window.lucide) lucide.createIcons();
    }

    // Setup nav clicks
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.nav-item[data-view]').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const view = item.getAttribute('data-view') + 'View';
          switchView(view);
        });
      });
    });

    // =========================
    // AUTH
    // =========================
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(document.getElementById("loginError"));
      hide(document.getElementById("loginOk"));

      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;

      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        const box = document.getElementById("loginError");
        box.textContent = error.message;
        show(box);
        return;
      }
      const ok = document.getElementById("loginOk");
      ok.textContent = "Connecté.";
      show(ok);
    });

    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(document.getElementById("regError"));
      hide(document.getElementById("regOk"));

      const name = document.getElementById("regName").value.trim();
      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value;

      const { data, error } = await supabaseClient.auth.signUp({
        email,
        password,
        options: {
          data: { full_name: name }
        }
      });

      if (error) {
        const box = document.getElementById("regError");
        box.textContent = error.message;
        show(box);
        return;
      }

      const ok = document.getElementById("regOk");
      ok.textContent = "Compte créé. Tu peux te connecter.";
      show(ok);
    });

    document.getElementById("btnLogout").addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
    });

    // =========================
    // DATA LOADERS
    // =========================
    async function loadAllData() {
      await Promise.all([
        loadTeams(),
        loadTasks(),
        loadEvents()
      ]);
    }

    async function loadTeams() {
      const { data, error } = await supabaseClient
        .from("teams")
        .select("*")
        .order("name", { ascending: true });
      if (!error) teams = data || [];
    }

    async function loadTasks() {
      const { data, error } = await supabaseClient
        .from("tasks")
        .select("*, teams(name)")
        .order("start_date", { ascending: true });
      if (!error) tasks = data || [];
    }

    async function loadEvents() {
      const { data, error } = await supabaseClient
        .from("events")
        .select("*")
        .order("start_date", { ascending: true });
      if (!error) events = data || [];
    }

    // =========================
    // DASHBOARD
    // =========================
    function renderDashboard() {
      const today = new Date();
      today.setHours(0,0,0,0);
      const todayStr = ymd(today);

      const total = tasks.length;
      const done = tasks.filter(t => t.completed).length;
      const inProgress = tasks.filter(t => !t.completed && t.end_date >= todayStr).length;
      const late = tasks.filter(t => !t.completed && t.end_date < todayStr).length;

      setText(document.getElementById('totalTasks'), total);
      setText(document.getElementById('doneTasks'), done);
      setText(document.getElementById('inProgressTasks'), inProgress);
      setText(document.getElementById('lateTasks'), late);

      // Status breakdown
      const statusBreakdown = document.getElementById('statusBreakdown');
      if (statusBreakdown) {
        const todoCount = tasks.filter(t => !t.completed).length;
        const todoPercent = total > 0 ? Math.round((todoCount / total) * 100) : 0;
        const donePercent = total > 0 ? Math.round((done / total) * 100) : 0;

        statusBreakdown.innerHTML = `
          <div class="progress-item">
            <div class="progress-label">
              <span>À faire</span>
              <span class="fw-semibold">${todoCount}</span>
            </div>
            <div class="progress">
              <div class="progress-bar bg-secondary" style="width:${todoPercent}%"></div>
            </div>
          </div>
          <div class="progress-item">
            <div class="progress-label">
              <span>Terminée</span>
              <span class="fw-semibold">${done}</span>
            </div>
            <div class="progress">
              <div class="progress-bar bg-success" style="width:${donePercent}%"></div>
            </div>
          </div>
        `;
      }

      // Priority breakdown
      const priorityBreakdown = document.getElementById('priorityBreakdown');
      if (priorityBreakdown) {
        const hauteCount = tasks.filter(t => t.priority === 'haute').length;
        const moyenneCount = tasks.filter(t => t.priority === 'moyenne').length;
        const basseCount = tasks.filter(t => t.priority === 'basse').length;

        const hautePercent = total > 0 ? Math.round((hauteCount / total) * 100) : 0;
        const moyennePercent = total > 0 ? Math.round((moyenneCount / total) * 100) : 0;
        const bassePercent = total > 0 ? Math.round((basseCount / total) * 100) : 0;

        priorityBreakdown.innerHTML = `
          <div class="progress-item">
            <div class="progress-label">
              <span>Basse</span>
              <span class="fw-semibold">${basseCount}</span>
            </div>
            <div class="progress">
              <div class="progress-bar bg-secondary" style="width:${bassePercent}%"></div>
            </div>
          </div>
          <div class="progress-item">
            <div class="progress-label">
              <span>Moyenne</span>
              <span class="fw-semibold">${moyenneCount}</span>
            </div>
            <div class="progress">
              <div class="progress-bar bg-warning" style="width:${moyennePercent}%"></div>
            </div>
          </div>
          <div class="progress-item">
            <div class="progress-label">
              <span>Haute</span>
              <span class="fw-semibold">${hauteCount}</span>
            </div>
            <div class="progress">
              <div class="progress-bar bg-danger" style="width:${hautePercent}%"></div>
            </div>
          </div>
        `;
      }
    }

    // =========================
    // CALENDAR
    // =========================
    const monthNames = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];

    function renderCalendar() {
      const calGrid = document.getElementById('calGrid');
      if (!calGrid) return;

      // Clear existing cells (keep headers)
      const cells = calGrid.querySelectorAll('.cal-cell');
      cells.forEach(c => c.remove());

      const year = calDate.getFullYear();
      const month = calDate.getMonth();

      const first = new Date(year, month, 1);
      const last = new Date(year, month + 1, 0);

      let startDay = first.getDay();
      if (startDay === 0) startDay = 7;
      startDay = startDay - 1;

      // Empty cells
      for (let i=0; i<startDay; i++) {
        const cell = document.createElement("div");
        cell.className = "cal-cell";
        cell.style.opacity = "0.35";
        calGrid.appendChild(cell);
      }

      // Days
      const today = ymd(new Date());
      for (let day=1; day<=last.getDate(); day++) {
        const dt = new Date(year, month, day);
        const dStr = ymd(dt);

        const cell = document.createElement("div");
        cell.className = "cal-cell";

        // Highlight today
        if (dStr === today) {
          cell.style.background = "rgba(255, 107, 53, 0.05)";
          cell.style.border = "2px solid var(--orange)";
        }

        // Tasks for this day
        const dayTasks = tasks.filter(t => t.start_date && t.end_date && isBetween(dStr, t.start_date, t.end_date)).slice(0, 3);

        // Events for this day
        const dayEvents = events.filter(e => e.start_date && e.end_date && isBetween(dStr, e.start_date, e.end_date)).slice(0, 2);

        let html = `<div class="d-flex align-items-center justify-content-between mb-2">
          <div class="cal-day">${day}</div>
        </div>`;

        for (const t of dayTasks) {
          const teamName = (t.teams && t.teams.name) ? t.teams.name : "";
          html += `<div class="task-pill mb-1">${escapeHtml(t.title)}<br><small>${escapeHtml(teamName)}</small></div>`;
        }

        for (const e of dayEvents) {
          html += `<div class="task-pill mb-1" style="background:#9333EA !important;">${escapeHtml(e.name)}</div>`;
        }

        cell.innerHTML = html;
        calGrid.appendChild(cell);
      }

      // Update title
      setText(document.getElementById('calTitle'), `${monthNames[month]} ${year}`);
      setText(document.getElementById('pageSubtitle'), `${monthNames[month]} ${year}`);
    }

    document.getElementById('calPrev')?.addEventListener('click', () => {
      calDate.setMonth(calDate.getMonth() - 1);
      renderCalendar();
    });

    document.getElementById('calNext')?.addEventListener('click', () => {
      calDate.setMonth(calDate.getMonth() + 1);
      renderCalendar();
    });

    document.getElementById('calToday')?.addEventListener('click', () => {
      calDate = new Date();
      renderCalendar();
    });

    // =========================
    // TASKS
    // =========================
    function renderTasksList() {
      const container = document.getElementById('tasksListView');
      if (!container) return;

      container.innerHTML = "";

      // Apply filters
      let filtered = [...tasks];

      const statusFilter = document.getElementById('taskStatusFilter')?.value;
      if (statusFilter === 'todo') filtered = filtered.filter(t => !t.completed);
      if (statusFilter === 'done') filtered = filtered.filter(t => t.completed);

      const priorityFilter = document.getElementById('taskPriorityFilter')?.value;
      if (priorityFilter) filtered = filtered.filter(t => t.priority === priorityFilter);

      const teamFilter = document.getElementById('taskTeamFilter')?.value;
      if (teamFilter) filtered = filtered.filter(t => t.team_id === teamFilter);

      if (!filtered.length) {
        container.innerHTML = `<div class="text-secondary">Aucune tâche.</div>`;
        return;
      }

      for (const t of filtered) {
        const teamName = (t.teams && t.teams.name) ? t.teams.name : "";
        const priorityClass = t.priority || 'basse';

        const card = document.createElement('div');
        card.className = `task-card priority-${priorityClass}`;
        card.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center gap-2 mb-2">
                <h6 class="mb-0">${escapeHtml(t.title)}</h6>
                ${t.completed ? '<span class="badge bg-success">✓ Terminée</span>' : '<span class="badge bg-warning">À faire</span>'}
              </div>
              <p class="text-secondary small mb-2">${escapeHtml(t.description || '')}</p>
              <div class="d-flex gap-2 flex-wrap">
                <span class="badge bg-light text-dark">${escapeHtml(teamName)}</span>
                <span class="badge bg-light text-dark">${escapeHtml(t.category || 'Autre')}</span>
                <span class="badge bg-light text-dark">${fmtDate(t.start_date)} → ${fmtDate(t.end_date)}</span>
                ${t.priority ? `<span class="badge bg-${t.priority === 'haute' ? 'danger' : t.priority === 'moyenne' ? 'warning' : 'secondary'}">${escapeHtml(t.priority)}</span>` : ''}
              </div>
            </div>
            <div>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteTask('${t.id}')">
                <i data-lucide="trash-2" style="width:14px;height:14px;"></i>
              </button>
            </div>
          </div>
        `;
        container.appendChild(card);
      }

      if (window.lucide) lucide.createIcons();
    }

    // Populate team filter
    function populateTaskFilters() {
      const teamFilter = document.getElementById('taskTeamFilter');
      if (!teamFilter) return;

      teamFilter.innerHTML = '<option value="">Toutes</option>';
      teams.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.name;
        teamFilter.appendChild(opt);
      });
    }

    document.getElementById('taskStatusFilter')?.addEventListener('change', renderTasksList);
    document.getElementById('taskPriorityFilter')?.addEventListener('change', renderTasksList);
    document.getElementById('taskTeamFilter')?.addEventListener('change', renderTasksList);

    async function deleteTask(taskId) {
      if (!confirm('Supprimer cette tâche ?')) return;

      const { error } = await supabaseClient
        .from('tasks')
        .delete()
        .eq('id', taskId);

      if (error) {
        alert('Erreur: ' + error.message);
        return;
      }

      await loadTasks();
      renderTasksList();
      renderCalendar();
    }

    // =========================
    // TEAMS
    // =========================
    function renderTeamsGrid() {
      const container = document.getElementById('teamsGrid');
      if (!container) return;

      container.innerHTML = "";

      const teamColors = [
        '#3B82F6', // blue
        '#9333EA', // purple
        '#10B981', // green
        '#EC4899', // pink
        '#14B8A6', // teal
        '#EF4444'  // red
      ];

      teams.forEach((team, index) => {
        const color = teamColors[index % teamColors.length];
        const teamTasks = tasks.filter(t => t.team_id === team.id);

        const col = document.createElement('div');
        col.className = 'col-12 col-lg-4';
        col.innerHTML = `
          <div class="team-card" style="background:${color};">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h5 class="mb-1">${escapeHtml(team.name)}</h5>
                <div class="opacity-75">${teamTasks.length} tâche(s)</div>
              </div>
              <button class="btn btn-sm btn-light" onclick="deleteTeam('${team.id}')">
                <i data-lucide="trash-2" style="width:14px;height:14px;"></i>
              </button>
            </div>
            <div class="vstack gap-2">
              ${teamTasks.slice(0, 3).map(t => `
                <div class="bg-white bg-opacity-25 rounded p-2 small">
                  ${escapeHtml(t.title)}
                </div>
              `).join('')}
              ${teamTasks.length > 3 ? `<div class="small opacity-75">+ ${teamTasks.length - 3} autres...</div>` : ''}
            </div>
          </div>
        `;
        container.appendChild(col);
      });

      if (!teams.length) {
        container.innerHTML = `<div class="col-12"><div class="text-secondary">Aucune équipe.</div></div>`;
      }

      if (window.lucide) lucide.createIcons();
    }

    async function deleteTeam(teamId) {
      if (!confirm('Supprimer cette équipe et toutes ses tâches ?')) return;

      // Delete tasks first
      await supabaseClient.from('tasks').delete().eq('team_id', teamId);

      const { error } = await supabaseClient
        .from('teams')
        .delete()
        .eq('id', teamId);

      if (error) {
        alert('Erreur: ' + error.message);
        return;
      }

      await loadAllData();
      renderTeamsGrid();
    }

    function showCreateTeamModal() {
      const name = prompt('Nom de l\'équipe:');
      if (!name) return;

      createTeam(name);
    }

    async function createTeam(name) {
      const { error } = await supabaseClient
        .from('teams')
        .insert([{ name, created_by: user.id }]);

      if (error) {
        alert('Erreur: ' + error.message);
        return;
      }

      await loadTeams();
      renderTeamsGrid();
      populateTaskFilters();
    }

    // =========================
    // EVENTS
    // =========================
    function renderEventsList() {
      const container = document.getElementById('eventsListView');
      if (!container) return;

      container.innerHTML = "";

      if (!events.length) {
        container.innerHTML = `<div class="text-secondary">Aucun événement.</div>`;
        return;
      }

      const eventColors = {
        'Jour férié': '#EF4444',
        'Soldes': '#EC4899',
        'Fête': '#F59E0B',
        'Autre': '#6B7280'
      };

      for (const e of events) {
        const color = eventColors[e.type] || eventColors['Autre'];

        const card = document.createElement('div');
        card.className = 'event-card';
        card.innerHTML = `
          <div class="event-dot" style="background:${color};"></div>
          <div class="flex-grow-1">
            <div class="fw-semibold">${escapeHtml(e.name)}</div>
            <div class="small text-secondary">${fmtDate(e.start_date)}${e.end_date && e.end_date !== e.start_date ? ' - ' + fmtDate(e.end_date) : ''}</div>
          </div>
          <span class="badge" style="background:${color};">${escapeHtml(e.type || 'Autre')}</span>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteEvent('${e.id}')">
            <i data-lucide="trash-2" style="width:14px;height:14px;"></i>
          </button>
        `;
        container.appendChild(card);
      }

      if (window.lucide) lucide.createIcons();
    }

    async function deleteEvent(eventId) {
      if (!confirm('Supprimer cet événement ?')) return;

      const { error } = await supabaseClient
        .from('events')
        .delete()
        .eq('id', eventId);

      if (error) {
        alert('Erreur: ' + error.message);
        return;
      }

      await loadEvents();
      renderEventsList();
      renderCalendar();
    }

    function showCreateEventModal() {
      const name = prompt('Nom de l\'événement:');
      if (!name) return;

      const date = prompt('Date (AAAA-MM-JJ):');
      if (!date) return;

      const type = prompt('Type (Jour férié, Soldes, Fête, Autre):');

      createEvent(name, date, type || 'Autre');
    }

    async function createEvent(name, date, type) {
      const { error } = await supabaseClient
        .from('events')
        .insert([{
          name,
          start_date: date,
          end_date: date,
          type,
          created_by: user.id
        }]);

      if (error) {
        alert('Erreur: ' + error.message);
        return;
      }

      await loadEvents();
      renderEventsList();
      renderCalendar();
    }

    // =========================
    // EXPORT FUNCTIONS
    // =========================
    function downloadCSV(content, filename) {
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function exportTasksCSV() {
      let csv = 'Titre,Description,Catégorie,Début,Fin,Équipe,Priorité,Statut\n';
      
      tasks.forEach(t => {
        const teamName = (t.teams && t.teams.name) ? t.teams.name : '';
        csv += `"${t.title}","${t.description || ''}","${t.category || ''}","${t.start_date}","${t.end_date}","${teamName}","${t.priority || ''}","${t.completed ? 'Terminée' : 'À faire'}"\n`;
      });

      downloadCSV(csv, 'taches_export.csv');
    }

    function exportTasksJSON() {
      const json = JSON.stringify(tasks, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'taches_export.json';
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function exportTasksiCal() {
      let ical = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//TaskFlow//FR\n';

      tasks.forEach(t => {
        ical += 'BEGIN:VEVENT\n';
        ical += `DTSTART:${t.start_date.replace(/-/g, '')}\n`;
        ical += `DTEND:${t.end_date.replace(/-/g, '')}\n`;
        ical += `SUMMARY:${t.title}\n`;
        if (t.description) ical += `DESCRIPTION:${t.description}\n`;
        ical += 'END:VEVENT\n';
      });

      ical += 'END:VCALENDAR';

      const blob = new Blob([ical], { type: 'text/calendar' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'taches_export.ics';
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function exportEventsCSV() {
      let csv = 'Nom,Type,Date début,Date fin\n';
      
      events.forEach(e => {
        csv += `"${e.name}","${e.type || ''}","${e.start_date}","${e.end_date}"\n`;
      });

      downloadCSV(csv, 'evenements_export.csv');
    }

    function exportEventsJSON() {
      const json = JSON.stringify(events, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'evenements_export.json';
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function downloadTasksTemplate() {
      const csv = 'Titre,Description,Catégorie,Début,Fin,Équipe,Priorité\n"Exemple","Description","Dev","2026-02-01","2026-02-15","Production","haute"';
      downloadCSV(csv, 'modele_taches.csv');
    }

    function importTasks(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        const text = e.target.result;
        const lines = text.split('\n').filter(l => l.trim());
        
        for (let i = 1; i < lines.length; i++) {
          const parts = lines[i].split(',').map(p => p.trim().replace(/^"|"$/g, ''));
          if (parts.length >= 5) {
            const [title, description, category, start_date, end_date, teamName, priority] = parts;
            
            let team_id = teams[0]?.id;
            if (teamName) {
              const team = teams.find(t => t.name.toLowerCase() === teamName.toLowerCase());
              if (team) team_id = team.id;
            }

            await supabaseClient.from('tasks').insert([{
              title,
              description: description || '',
              category: category || 'Autre',
              start_date,
              end_date,
              team_id,
              priority: priority || 'moyenne',
              created_by: user.id,
              completed: false
            }]);
          }
        }

        await loadTasks();
        renderTasksList();
        renderCalendar();
        alert('Import terminé!');
      };
      reader.readAsText(file);
    }

    function importEvents(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        const text = e.target.result;
        const lines = text.split('\n').filter(l => l.trim());
        
        for (let i = 1; i < lines.length; i++) {
          const parts = lines[i].split(',').map(p => p.trim().replace(/^"|"$/g, ''));
          if (parts.length >= 3) {
            const [name, type, start_date, end_date] = parts;

            await supabaseClient.from('events').insert([{
              name,
              type: type || 'Autre',
              start_date,
              end_date: end_date || start_date,
              created_by: user.id
            }]);
          }
        }

        await loadEvents();
        renderEventsList();
        renderCalendar();
        alert('Import terminé!');
      };
      reader.readAsText(file);
    }

    // Make functions global
    window.deleteTask = deleteTask;
    window.deleteTeam = deleteTeam;
    window.deleteEvent = deleteEvent;
    window.showCreateTeamModal = showCreateTeamModal;
    window.showCreateEventModal = showCreateEventModal;
    window.exportTasksCSV = exportTasksCSV;
    window.exportTasksJSON = exportTasksJSON;
    window.exportTasksiCal = exportTasksiCal;
    window.exportEventsCSV = exportEventsCSV;
    window.exportEventsJSON = exportEventsJSON;
    window.downloadTasksTemplate = downloadTasksTemplate;
    window.importTasks = importTasks;
    window.importEvents = importEvents;

    // =========================
    // INIT
    // =========================
    async function setAuthedUI() {
      hide(document.getElementById('authView'));
      show(document.getElementById('appView'));
      show(document.getElementById('btnLogout'));

      setText(document.getElementById('userEmail'), user.email || '');
      
      await loadAllData();
      populateTaskFilters();
      
      // Show calendar by default
      switchView('calendarView');

      if (window.lucide) lucide.createIcons();
    }

    function setAnonUI() {
      show(document.getElementById('authView'));
      hide(document.getElementById('appView'));
      hide(document.getElementById('btnLogout'));

      setText(document.getElementById('userEmail'), '');
      setText(document.getElementById('roleBadge'), 'non connecté');
    }

    (async () => {
      const { data } = await supabaseClient.auth.getSession();
      session = data.session;
      user = session ? session.user : null;

      if (user) await setAuthedUI();
      else setAnonUI();

      supabaseClient.auth.onAuthStateChange(async (_event, newSession) => {
        session = newSession;
        user = newSession ? newSession.user : null;

        if (user) await setAuthedUI();
        else setAnonUI();
      });

      if (window.lucide) lucide.createIcons();
    })();
  </script>
</body>
</html>
