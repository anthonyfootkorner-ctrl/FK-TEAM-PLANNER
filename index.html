<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FK Team Planner</title>

  <!-- Bootstrap (pas jsdelivr) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" />

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Supabase JS v2 (pas jsdelivr) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body { background:#f6f7fb; }
    .card { border:0; border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,.06); }
    .badge-soft { background: rgba(13,110,253,.12); color:#0d6efd; }
    .cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }
    .cal-cell { background:#fff; border-radius:14px; padding:10px; min-height:110px; border:1px solid rgba(0,0,0,.06); }
    .cal-head { font-size:.85rem; color:#6c757d; }
    .cal-day { font-weight:700; }
    .task-pill { display:block; font-size:.78rem; padding:4px 8px; border-radius:999px; margin-top:6px; background:#f1f3f5; }
    .task-pill small { color:#6c757d; }
    .muted { color:#6c757d; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .hidden { display:none !important; }
    .pointer { cursor:pointer; }
  </style>
</head>

<body>
  <div class="container py-4">

    <!-- Top bar -->
    <div class="d-flex align-items-center justify-content-between mb-4">
      <div class="d-flex align-items-center gap-2">
        <div class="rounded-3 px-3 py-2 bg-white border">
          <strong>FK Team Planner</strong>
        </div>
        <span class="badge text-bg-light border" id="roleBadge">non connecté</span>
      </div>

      <div class="d-flex align-items-center gap-2">
        <span class="text-secondary small" id="userEmail"></span>
        <button class="btn btn-outline-secondary btn-sm hidden" id="btnLogout">Se déconnecter</button>
      </div>
    </div>

    <!-- AUTH -->
    <div id="authView" class="row g-3">
      <div class="col-12 col-lg-6">
        <div class="card p-4">
          <h4 class="mb-1">Connexion</h4>
          <p class="muted mb-4">Connecte-toi pour accéder au calendrier collectif.</p>

          <form id="loginForm" class="vstack gap-2">
            <div>
              <label class="form-label">Email</label>
              <input class="form-control" type="email" id="loginEmail" required />
            </div>
            <div>
              <label class="form-label">Mot de passe</label>
              <input class="form-control" type="password" id="loginPassword" required />
            </div>
            <button class="btn btn-primary mt-2" type="submit">Se connecter</button>
          </form>

          <div class="alert alert-danger mt-3 hidden" id="loginError"></div>
          <div class="alert alert-success mt-3 hidden" id="loginOk"></div>
        </div>
      </div>

      <div class="col-12 col-lg-6">
        <div class="card p-4">
          <h4 class="mb-1">Créer un compte</h4>
          <p class="muted mb-4">Inscription simple (email + mot de passe).</p>

          <form id="registerForm" class="vstack gap-2">
            <div>
              <label class="form-label">Nom complet (optionnel)</label>
              <input class="form-control" type="text" id="regName" placeholder="Anthony POIGNARD" />
            </div>
            <div>
              <label class="form-label">Email</label>
              <input class="form-control" type="email" id="regEmail" required />
            </div>
            <div>
              <label class="form-label">Mot de passe</label>
              <input class="form-control" type="password" id="regPassword" required minlength="6" />
              <div class="form-text">Min 6 caractères.</div>
            </div>

            <button class="btn btn-outline-primary mt-2" type="submit">Créer le compte</button>
          </form>

          <div class="alert alert-danger mt-3 hidden" id="regError"></div>
          <div class="alert alert-success mt-3 hidden" id="regOk"></div>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div id="appView" class="hidden">

      <!-- Controls -->
      <div class="row g-3 mb-3">
        <div class="col-12 col-lg-4">
          <div class="card p-3">
            <label class="form-label mb-1">Équipe (pour créer/filtrer)</label>
            <select class="form-select" id="teamSelect"></select>
            <div class="d-flex gap-2 mt-2">
              <button class="btn btn-outline-primary btn-sm hidden" id="btnCreateTeam">
                <i data-lucide="plus" class="me-1"></i>Créer une équipe
              </button>
              <button class="btn btn-outline-secondary btn-sm" id="btnRefresh">
                <i data-lucide="refresh-cw" class="me-1"></i>Rafraîchir
              </button>
            </div>
            <div class="small muted mt-2">
              Lecture globale (calendrier collectif). Écriture selon permissions.
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-8">
          <div class="card p-3">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
              <div>
                <div class="fw-bold">Calendrier collectif</div>
                <div class="small muted">Affiche toutes les équipes. Les tâches couvrent la période start → end.</div>
              </div>
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="calPrev">
                  <i data-lucide="chevron-left"></i>
                </button>
                <div class="fw-semibold" id="calTitle"></div>
                <button class="btn btn-outline-secondary btn-sm" id="calNext">
                  <i data-lucide="chevron-right"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="calToday">Aujourd’hui</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main columns -->
      <div class="row g-3">
        <!-- Left: members + add member -->
        <div class="col-12 col-lg-4">
          <div class="card p-3 mb-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-bold">Membres de l’équipe</div>
              <span class="badge badge-soft" id="teamMembersCount">0</span>
            </div>
            <div id="membersList" class="vstack gap-2 small"></div>

            <hr class="my-3" />
            <div class="fw-bold mb-2">Ajouter un membre (manager/admin)</div>
            <div class="small muted mb-2">Le membre doit déjà avoir créé un compte (profile existant).</div>

            <form id="addMemberForm" class="vstack gap-2 hidden">
              <input class="form-control" type="email" id="addMemberEmail" placeholder="email@exemple.com" required />
              <select class="form-select" id="addMemberRole">
                <option value="member">member (peut modifier son équipe)</option>
                <option value="viewer">viewer (lecture seule)</option>
              </select>
              <button class="btn btn-outline-primary btn-sm" type="submit">Ajouter</button>
              <div class="alert alert-danger mt-2 hidden" id="addMemberError"></div>
              <div class="alert alert-success mt-2 hidden" id="addMemberOk"></div>
            </form>

            <div class="alert alert-info mt-2 hidden" id="addMemberHint">
              Tu n’es pas manager/admin : tu peux voir le collectif, mais tu ne peux pas gérer les membres.
            </div>
          </div>

          <div class="card p-3">
            <div class="fw-bold mb-2">Debug</div>
            <div class="small mono muted" id="debugBox">—</div>
          </div>
        </div>

        <!-- Right: tasks + create task -->
        <div class="col-12 col-lg-8">
          <div class="card p-3 mb-3">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="fw-bold">Créer une tâche</div>
                <div class="small muted">Dates : début + fin. L’équipe vient du sélecteur.</div>
              </div>
              <span class="badge text-bg-light border" id="writeStatus">—</span>
            </div>

            <form id="taskForm" class="row g-2 mt-1">
              <div class="col-12 col-lg-6">
                <label class="form-label">Titre</label>
                <input class="form-control" id="taskTitle" required />
              </div>
              <div class="col-12 col-lg-6">
                <label class="form-label">Catégorie</label>
                <select class="form-select" id="taskCategory">
                  <option>Design</option>
                  <option>Dev</option>
                  <option>Marketing</option>
                  <option>Réunion</option>
                  <option>Autre</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="taskDescription" rows="2"></textarea>
              </div>

              <div class="col-6 col-lg-3">
                <label class="form-label">Début</label>
                <input type="date" class="form-control" id="taskStart" required />
              </div>
              <div class="col-6 col-lg-3">
                <label class="form-label">Fin</label>
                <input type="date" class="form-control" id="taskEnd" required />
              </div>

              <div class="col-12 col-lg-6">
                <label class="form-label">Assigné à</label>
                <select class="form-select" id="taskAssignee">
                  <option value="">Non assigné</option>
                </select>
              </div>

              <div class="col-12 d-flex gap-2 align-items-center">
                <button class="btn btn-primary" type="submit">Créer</button>
                <div class="alert alert-danger py-2 px-3 mb-0 hidden" id="taskError"></div>
                <div class="alert alert-success py-2 px-3 mb-0 hidden" id="taskOk"></div>
              </div>
            </form>
          </div>

          <div class="card p-3">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="fw-bold">Tâches (liste)</div>
              <span class="badge badge-soft" id="tasksCount">0</span>
            </div>
            <div class="small muted mb-2">Affiche toutes les équipes (collectif). Tu peux filtrer avec l’équipe si tu veux.</div>

            <div class="d-flex gap-2 align-items-center mb-3">
              <select class="form-select form-select-sm w-auto" id="taskFilterMode">
                <option value="all">Tout (collectif)</option>
                <option value="team">Seulement l’équipe sélectionnée</option>
              </select>
              <select class="form-select form-select-sm w-auto" id="taskSort">
                <option value="start_asc">Trier: début ↑</option>
                <option value="start_desc">Trier: début ↓</option>
              </select>
            </div>

            <div id="tasksList" class="vstack gap-2"></div>
          </div>
        </div>
      </div>

      <!-- Calendar -->
      <div class="card p-3 mt-3">
        <div class="cal-grid mb-2" id="calHeader"></div>
        <div class="cal-grid" id="calGrid"></div>
      </div>

      <!-- Create team modal (simple) -->
      <div class="modal fade" id="createTeamModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content" style="border-radius:16px;">
            <div class="modal-header">
              <h5 class="modal-title">Créer une équipe</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-2">
                <label class="form-label">Nom</label>
                <input class="form-control" id="newTeamName" placeholder="Web" />
              </div>
              <div class="alert alert-danger hidden" id="createTeamError"></div>
              <div class="alert alert-success hidden" id="createTeamOk"></div>
              <div class="small muted">Seuls admin/manager peuvent créer des équipes.</div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
              <button class="btn btn-primary" note="btn" id="btnCreateTeamConfirm">Créer</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Bootstrap JS (pas jsdelivr) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>

  <script>
    // =========================
    // CONFIG
    // =========================
    const SUPABASE_URL = "https://yeusqubxgxchigssobma.supabase.co";
    const SUPABASE_KEY = "sb_publishable_FkwKSPbHO3CPHdRvt35img__s3HSY5R";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // =========================
    // DOM
    // =========================
    const authView = document.getElementById("authView");
    const appView  = document.getElementById("appView");

    const userEmail = document.getElementById("userEmail");
    const roleBadge = document.getElementById("roleBadge");
    const btnLogout = document.getElementById("btnLogout");

    const debugBox = document.getElementById("debugBox");

    const teamSelect = document.getElementById("teamSelect");
    const btnRefresh = document.getElementById("btnRefresh");
    const btnCreateTeam = document.getElementById("btnCreateTeam");

    const membersList = document.getElementById("membersList");
    const teamMembersCount = document.getElementById("teamMembersCount");

    const addMemberForm = document.getElementById("addMemberForm");
    const addMemberEmail = document.getElementById("addMemberEmail");
    const addMemberRole = document.getElementById("addMemberRole");
    const addMemberError = document.getElementById("addMemberError");
    const addMemberOk = document.getElementById("addMemberOk");
    const addMemberHint = document.getElementById("addMemberHint");

    const taskForm = document.getElementById("taskForm");
    const taskTitle = document.getElementById("taskTitle");
    const taskCategory = document.getElementById("taskCategory");
    const taskDescription = document.getElementById("taskDescription");
    const taskStart = document.getElementById("taskStart");
    const taskEnd = document.getElementById("taskEnd");
    const taskAssignee = document.getElementById("taskAssignee");
    const taskError = document.getElementById("taskError");
    const taskOk = document.getElementById("taskOk");
    const writeStatus = document.getElementById("writeStatus");

    const tasksList = document.getElementById("tasksList");
    const tasksCount = document.getElementById("tasksCount");
    const taskFilterMode = document.getElementById("taskFilterMode");
    const taskSort = document.getElementById("taskSort");

    const calHeader = document.getElementById("calHeader");
    const calGrid = document.getElementById("calGrid");
    const calTitle = document.getElementById("calTitle");
    const calPrev = document.getElementById("calPrev");
    const calNext = document.getElementById("calNext");
    const calToday = document.getElementById("calToday");

    const createTeamModalEl = document.getElementById("createTeamModal");
    const createTeamModal = new bootstrap.Modal(createTeamModalEl);
    const newTeamName = document.getElementById("newTeamName");
    const createTeamError = document.getElementById("createTeamError");
    const createTeamOk = document.getElementById("createTeamOk");
    const btnCreateTeamConfirm = document.getElementById("btnCreateTeamConfirm");

    // =========================
    // State
    // =========================
    let session = null;
    let user = null;
    let globalRole = null; // "admin" | "manager" | null
    let teams = [];
    let memberships = []; // team_memberships rows for current user (for UI decisions)
    let allMemberships = []; // for viewing members by team (global select allowed)
    let profilesCache = new Map(); // user_id -> profile
    let tasks = [];

    let selectedTeamId = null;

    let calDate = new Date();

    // =========================
    // Utils
    // =========================
    function show(el){ el.classList.remove("hidden"); }
    function hide(el){ el.classList.add("hidden"); }
    function setText(idOrEl, txt){
      const el = typeof idOrEl === "string" ? document.getElementById(idOrEl) : idOrEl;
      if (el) el.textContent = txt;
    }
    function fmtDate(d){
      // d: YYYY-MM-DD
      try {
        const dt = new Date(d + "T00:00:00");
        return dt.toLocaleDateString("fr-FR");
      } catch { return d; }
    }
    function ymd(dateObj){
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth()+1).padStart(2,"0");
      const d = String(dateObj.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }
    function monthKey(dateObj){
      return `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,"0")}`;
    }
    function isBetween(dateStr, startStr, endStr){
      return dateStr >= startStr && dateStr <= endStr;
    }
    function info(msg){
      debugBox.textContent = msg;
    }

    // =========================
    // Auth UI
    // =========================
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(document.getElementById("loginError"));
      hide(document.getElementById("loginOk"));

      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;

      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        const box = document.getElementById("loginError");
        box.textContent = error.message;
        show(box);
        return;
      }
      const ok = document.getElementById("loginOk");
      ok.textContent = "Connecté.";
      show(ok);
    });

    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(document.getElementById("regError"));
      hide(document.getElementById("regOk"));

      const name = document.getElementById("regName").value.trim();
      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value;

      const { data, error } = await supabaseClient.auth.signUp({
        email,
        password,
        options: {
          data: { full_name: name }
        }
      });

      if (error) {
        const box = document.getElementById("regError");
        box.textContent = error.message;
        show(box);
        return;
      }

      const ok = document.getElementById("regOk");
      ok.textContent = "Compte créé. Tu peux te connecter.";
      show(ok);
    });

    btnLogout.addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
    });

    // =========================
    // Data loaders
    // =========================
    async function loadGlobalRole() {
      globalRole = null;
      const { data, error } = await supabaseClient
        .from("app_roles")
        .select("role")
        .eq("user_id", user.id)
        .maybeSingle();

      if (!error && data && data.role) globalRole = data.role;
    }

    async function loadTeams() {
      const { data, error } = await supabaseClient
        .from("teams")
        .select("id,name")
        .order("name", { ascending: true });

      if (error) throw error;
      teams = data || [];
    }

    async function loadMyMemberships() {
      // pour savoir si l’utilisateur est member/viewer sur telle team (UI)
      const { data, error } = await supabaseClient
        .from("team_memberships")
        .select("team_id, role")
        .eq("user_id", user.id);

      if (error) throw error;
      memberships = data || [];
    }

    async function loadAllMembershipsAndProfiles() {
      // lecture globale autorisée => on peut lister les membres par équipe
      // On récupère user_id + role + team_id + profiles(email/full_name)
      const { data, error } = await supabaseClient
        .from("team_memberships")
        .select("team_id, user_id, role, profiles!team_memberships_user_id_fkey (id, email, full_name)")
        .order("created_at", { ascending: true });

      if (error) throw error;
      allMemberships = data || [];

      profilesCache.clear();
      for (const row of allMemberships) {
        if (row.profiles && row.profiles.id) {
          profilesCache.set(row.user_id, row.profiles);
        }
      }
    }

    async function loadTasks() {
      const { data, error } = await supabaseClient
        .from("tasks")
        .select("id, team_id, title, description, category, start_date, end_date, completed, assignee_id, created_at, teams!tasks_team_id_fkey (name)")
        .order("start_date", { ascending: true });

      if (error) throw error;
      tasks = data || [];
    }

    function renderTeamSelect() {
      teamSelect.innerHTML = "";
      if (!teams.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Aucune équipe (crée-en une)";
        teamSelect.appendChild(opt);
        selectedTeamId = null;
        return;
      }

      for (const t of teams) {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.name;
        teamSelect.appendChild(opt);
      }

      // keep previous selection if still exists
      if (selectedTeamId && teams.some(t => t.id === selectedTeamId)) {
        teamSelect.value = selectedTeamId;
      } else {
        selectedTeamId = teams[0].id;
        teamSelect.value = selectedTeamId;
      }
    }

    function canWriteSelectedTeam() {
      if (!user || !selectedTeamId) return false;
      if (globalRole === "admin" || globalRole === "manager") return true;

      const my = memberships.find(m => m.team_id === selectedTeamId);
      return my && my.role === "member";
    }

    function renderWriteStatus() {
      if (!selectedTeamId) {
        writeStatus.textContent = "Sélectionne une équipe";
        writeStatus.className = "badge text-bg-light border";
        return;
      }

      if (globalRole === "admin" || globalRole === "manager") {
        writeStatus.textContent = `Écriture OK (global ${globalRole})`;
        writeStatus.className = "badge text-bg-success";
        return;
      }

      const my = memberships.find(m => m.team_id === selectedTeamId);
      if (!my) {
        writeStatus.textContent = "Lecture seule (pas membre de cette équipe)";
        writeStatus.className = "badge text-bg-secondary";
        return;
      }

      if (my.role === "viewer") {
        writeStatus.textContent = "Lecture seule (viewer)";
        writeStatus.className = "badge text-bg-secondary";
        return;
      }

      writeStatus.textContent = "Écriture OK (member sur cette équipe)";
      writeStatus.className = "badge text-bg-success";
    }

    function renderMembersList() {
      membersList.innerHTML = "";

      if (!selectedTeamId) {
        membersList.innerHTML = `<div class="muted">Aucune équipe sélectionnée.</div>`;
        setText(teamMembersCount, "0");
        return;
      }

      const rows = allMemberships.filter(r => r.team_id === selectedTeamId);

      setText(teamMembersCount, String(rows.length));

      if (!rows.length) {
        membersList.innerHTML = `<div class="muted">Aucun membre dans cette équipe.</div>`;
        return;
      }

      for (const r of rows) {
        const p = r.profiles || profilesCache.get(r.user_id) || {};
        const name = (p.full_name && p.full_name.trim()) ? p.full_name : (p.email || "inconnu");
        const email = p.email || "";

        const div = document.createElement("div");
        div.className = "d-flex align-items-center justify-content-between border rounded-3 px-3 py-2 bg-white";

        div.innerHTML = `
          <div>
            <div class="fw-semibold">${escapeHtml(name)}</div>
            <div class="muted">${escapeHtml(email)}</div>
          </div>
          <span class="badge text-bg-light border">${escapeHtml(r.role)}</span>
        `;

        membersList.appendChild(div);
      }
    }

    function renderAssigneeOptions() {
      taskAssignee.innerHTML = `<option value="">Non assigné</option>`;

      if (!selectedTeamId) return;

      const rows = allMemberships.filter(r => r.team_id === selectedTeamId);
      for (const r of rows) {
        const p = r.profiles || profilesCache.get(r.user_id) || {};
        const label = (p.full_name && p.full_name.trim()) ? `${p.full_name} (${p.email || "?"})` : (p.email || r.user_id);

        const opt = document.createElement("option");
        opt.value = r.user_id;
        opt.textContent = label;
        taskAssignee.appendChild(opt);
      }
    }

    function renderTasksList() {
      tasksList.innerHTML = "";

      let rows = [...tasks];

      // filter mode
      if (taskFilterMode.value === "team" && selectedTeamId) {
        rows = rows.filter(t => t.team_id === selectedTeamId);
      }

      // sort
      if (taskSort.value === "start_desc") {
        rows.sort((a,b) => (b.start_date || "").localeCompare(a.start_date || ""));
      } else {
        rows.sort((a,b) => (a.start_date || "").localeCompare(b.start_date || ""));
      }

      setText(tasksCount, String(rows.length));

      if (!rows.length) {
        tasksList.innerHTML = `<div class="muted">Aucune tâche.</div>`;
        return;
      }

      for (const t of rows) {
        const teamName = (t.teams && t.teams.name) ? t.teams.name : "—";
        const range = `${fmtDate(t.start_date)} → ${fmtDate(t.end_date)}`;

        const div = document.createElement("div");
        div.className = "border rounded-3 px-3 py-2 bg-white";

        div.innerHTML = `
          <div class="d-flex align-items-start justify-content-between gap-2">
            <div>
              <div class="fw-semibold">${escapeHtml(t.title)}</div>
              <div class="muted small">${escapeHtml(t.description || "")}</div>
              <div class="small mt-1">
                <span class="badge badge-soft me-1">${escapeHtml(teamName)}</span>
                <span class="badge text-bg-light border me-1">${escapeHtml(t.category || "Autre")}</span>
                <span class="badge text-bg-light border">${escapeHtml(range)}</span>
              </div>
            </div>
            <div class="text-end">
              ${t.completed ? `<span class="badge text-bg-success">done</span>` : `<span class="badge text-bg-warning">todo</span>`}
              <div class="small muted mt-1">${escapeHtml(t.id.slice(0,8))}</div>
            </div>
          </div>
        `;

        // (Option) click to toggle completed if allowed
        if (canWriteForTask(t)) {
          div.classList.add("pointer");
          div.title = "Cliquer pour toggle completed";
          div.addEventListener("click", async () => {
            await toggleTaskCompleted(t);
          });
        }

        tasksList.appendChild(div);
      }
    }

    function canWriteForTask(task) {
      // server enforces anyway; this is UI comfort
      if (!user) return false;
      if (globalRole === "admin" || globalRole === "manager") return true;

      const my = memberships.find(m => m.team_id === task.team_id);
      return my && my.role === "member";
    }

    async function toggleTaskCompleted(task) {
      try {
        const next = !task.completed;
        const { error } = await supabaseClient
          .from("tasks")
          .update({ completed: next })
          .eq("id", task.id);

        if (error) throw error;

        task.completed = next;
        renderTasksList();
        renderCalendar();

      } catch (e) {
        alert("Impossible de modifier (permissions).");
        console.error(e);
      }
    }

    // =========================
    // Calendar
    // =========================
    function renderCalendar() {
      // header
      calHeader.innerHTML = "";
      const days = ["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];
      for (const d of days) {
        const el = document.createElement("div");
        el.className = "cal-head text-center";
        el.textContent = d;
        calHeader.appendChild(el);
      }

      // title
      const monthNames = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];
      calTitle.textContent = `${monthNames[calDate.getMonth()]} ${calDate.getFullYear()}`;

      // grid
      calGrid.innerHTML = "";

      const year = calDate.getFullYear();
      const month = calDate.getMonth();

      const first = new Date(year, month, 1);
      const last = new Date(year, month + 1, 0);

      // Convert to Monday-based offset
      let startDay = first.getDay(); // 0 sunday
      if (startDay === 0) startDay = 7;
      startDay = startDay - 1; // 0 = Monday

      // empty cells before
      for (let i=0; i<startDay; i++) {
        const cell = document.createElement("div");
        cell.className = "cal-cell";
        cell.style.opacity = "0.35";
        lookTodayCell(cell, null);
        calGrid.appendChild(cell);
      }

      // actual days
      for (let day=1; day<=last.getDate(); day++) {
        const dt = new Date(year, month, day);
        const dStr = ymd(dt);

        const cell = document.createElement("div");
        cell.className = "cal-cell";

        // tasks covering that day
        const todays = tasks
          .filter(t => t.start_date && t.end_date && isBetween(dStr, t.start_date, t.end_date))
          .slice(0, 5); // limit display

        let html = `<div class="d-flex align-items-center justify-content-between">
          <div class="cal-day">${day}</div>
          <div class="small muted">${dStr}</div>
        </div>`;

        for (const t of todays) {
          const teamName = (t.teams && t.teams.name) ? t.teams.name : "—";
          html += `<span class="task-pill">
            ${escapeHtml(t.title)}
            <br><small>${escapeHtml(teamName)} • ${escapeHtml(t.category || "Autre")}</small>
          </span>`;
        }

        if (!todays.length) {
          html += `<div class="small muted mt-2">—</div>`;
        } else if (tasks.filter(t => t.start_date && t.end_date && isBetween(dStr, t.start_date, t.end_date)).length > 5) {
          html += `<div class="small muted mt-2">+ plus…</div>`;
        }

        cell.innerHTML = html;
        lookTodayCell(cell, dStr);

        calGrid.appendChild(cell);
      }
    }

    function lookTodayCell(cell, dStr) {
      const today = ymd(new Date());
      if (dStr && dStr === today) {
        cell.style.outline = "2px solid rgba(13,110,253,.45)";
        cell.style.boxShadow = "0 6px 18px rgba(13,110,253,.10)";
      }
    }

    calPrev.addEventListener("click", () => {
      calDate.setMonth(calDate.getMonth() - 1);
      renderCalendar();
    });

    calNext.addEventListener("click", () => {
      calDate.setMonth(calDate.getMonth() + 1);
      renderCalendar();
    });

    calToday.addEventListener("click", () => {
      calDate = new Date();
      renderCalendar();
    });

    // =========================
    // Actions: Create team / Add member / Create task
    // =========================
    btnRefresh.addEventListener("click", async () => {
      await refreshAll();
    });

    teamSelect.addEventListener("change", () => {
      selectedTeamId = teamSelect.value || null;
      renderMembersList();
      renderAssigneeOptions();
      renderWriteStatus();
      renderTasksList();
      info(`selectedTeamId=${selectedTeamId}`);
    });

    btnCreateTeam.addEventListener("click", () => {
      hide(createTeamError); hide(createTeamOk);
      newTeamName.value = "";
      createTeamModal.show();
    });

    btnCreateTeamConfirm.addEventListener("click", async () => {
      hide(createTeamError); hide(createTeamOk);

      const name = (newTeamName.value || "").trim();
      if (!name) {
        createTeamError.textContent = "Nom requis.";
        show(createTeamError);
        return;
      }

      try {
        const { data, error } = await supabaseClient
          .from("teams")
          .insert([{ name, created_by: user.id }])
          .select("id,name")
          .single();

        if (error) throw error;

        createTeamOk.textContent = "Équipe créée.";
        show(createTeamOk);

        // auto add yourself as member of that team (optional)
        await supabaseClient
          .from("team_memberships")
          .insert([{ team_id: data.id, user_id: user.id, role: "member" }]);

        await refreshAll();
        selectedTeamId = data.id;
        renderTeamSelect();
        teamSelect.value = selectedTeamId;
        renderMembersList();
        renderAssigneeOptions();
        renderWriteStatus();

      } catch (e) {
        createTeamError.textContent = e.message || "Erreur création équipe.";
        show(createTeamError);
        console.error(e);
      }
    });

    addMemberForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(addMemberError); hide(addMemberOk);

      const email = (addMemberEmail.value || "").trim().toLowerCase();
      const role = addMemberRole.value;

      if (!selectedTeamId) {
        addMemberError.textContent = "Sélectionne une équipe.";
        show(addMemberError);
        return;
      }

      try {
        // find profile by email
        const { data: prof, error: pErr } = await supabaseClient
          .from("profiles")
          .select("id,email,full_name")
          .eq("email", email)
          .maybeSingle();

        if (pErr) throw pErr;
        if (!prof) {
          addMemberError.textContent = "Aucun profile trouvé avec cet email. Le user doit d’abord créer un compte.";
          show(addMemberError);
          return;
        }

        const { error: mErr } = await supabaseClient
          .from("team_memberships")
          .insert([{ team_id: selectedTeamId, user_id: prof.id, role }]);

        if (mErr) throw mErr;

        addMemberOk.textContent = "Membre ajouté.";
        show(addMemberOk);

        addMemberEmail.value = "";
        await refreshAll();

      } catch (e2) {
        addMemberError.textContent = e2.message || "Erreur ajout membre (permissions ?).";
        show(addMemberError);
        console.error(e2);
      }
    });

    taskForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(taskError); hide(taskOk);

      if (!selectedTeamId) {
        taskError.textContent = "Sélectionne une équipe.";
        show(taskError);
        return;
      }

      const start = taskStart.value;
      const end = taskEnd.value;
      if (end < start) {
        taskError.textContent = "La date de fin doit être >= date de début.";
        show(taskError);
        return;
      }

      try {
        const payload = {
          team_id: selectedTeamId,
          title: taskTitle.value.trim(),
          description: taskDescription.value.trim() || null,
          category: taskCategory.value || "Autre",
          start_date: start,
          end_date: end,
          completed: false,
          assignee_id: taskAssignee.value || null,
          created_by: user.id
        };

        const { error } = await supabaseClient
          .from("tasks")
          .insert([payload]);

        if (error) throw error;

        taskOk.textContent = "Tâche créée.";
        show(taskOk);

        taskTitle.value = "";
        taskDescription.value = "";

        await refreshAll();

      } catch (e3) {
        taskError.textContent = e3.message || "Erreur création tâche (permissions ?).";
        show(taskError);
        console.error(e3);
      }
    });

    taskFilterMode.addEventListener("change", renderTasksList);
    taskSort.addEventListener("change", renderTasksList);

    // =========================
    // Refresh orchestration
    // =========================
    async function refreshAll() {
      info("refresh…");

      await loadGlobalRole();
      await loadTeams();
      await loadMyMemberships();
      await loadAllMembershipsAndProfiles();
      await loadTasks();

      // teams selection
      if (!selectedTeamId && teams.length) selectedTeamId = teams[0].id;

      renderTeamSelect();
      renderWriteStatus();

      // permissions UI
      const isGlobal = (globalRole === "admin" || globalRole === "manager");

      if (isGlobal) {
        show(btnCreateTeam);
        show(addMemberForm);
        hide(addMemberHint);
      } else {
        hide(btnCreateTeam);
        hide(addMemberForm);
        show(addMemberHint);
      }

      // assignees/members
      renderMembersList();
      renderAssigneeOptions();

      // tasks + list + calendar
      renderTasksList();
      renderCalendar();

      // status badge
      roleBadge.textContent = globalRole ? `global: ${globalRole}` : `global: standard`;
      info(`user=${user.email} | globalRole=${globalRole || "none"} | teams=${teams.length} | tasks=${tasks.length}`);
    }

    // =========================
    // HTML escape
    // =========================
    function escapeHtml(str) {
      if (str === null || str === undefined) return "";
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // =========================
    // Boot
    // =========================
    async function setAuthedUI() {
      hide(authView);
      show(appView);
      show(btnLogout);

      userEmail.textContent = user.email || "";
      await refreshAll();

      // default dates to today
      const today = ymd(new Date());
      if (!taskStart.value) taskStart.value = today;
      if (!taskEnd.value) taskEnd.value = today;

      // icons
      if (window.lucide) lucide.createIcons();
    }

    function setAnonUI() {
      show(authView);
      hide(appView);
      hide(btnLogout);

      userEmail.textContent = "";
      roleBadge.textContent = "non connecté";
      info("—");
    }

    (async () => {
      // init session
      const { data } = await supabaseClient.auth.getSession();
      session = data.session;
      user = session ? session.user : null;

      if (user) await setAuthedUI();
      else setAnonUI();

      // auth state changes
      supabaseClient.auth.onAuthStateChange(async (_event, newSession) => {
        session = newSession;
        user = newSession ? newSession.user : null;

        if (user) await setAuthedUI();
        else setAnonUI();
      });

      if (window.lucide) lucide.createIcons();
    })();
  </script>
</body>
</html>
