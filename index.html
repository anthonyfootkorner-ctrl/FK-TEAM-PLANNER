<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FK Team Planner - Gestion d'√©quipe</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" />

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Supabase JS v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    /* RESET & BASE */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --sidebar-bg: #1a1d29;
      --sidebar-hover: #252836;
      --orange: #FF6B35;
      --orange-dark: #E85528;
      --white: #FFFFFF;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --text-primary: #111827;
      --text-secondary: #6B7280;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
      background: #f0f2f5 !important;
      color: var(--text-primary) !important;
      overflow: hidden !important;
    }

    /* LAYOUT FLEX */
    body > .container {
      display: flex !important;
      height: 100vh !important;
      max-width: 100% !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    /* SIDEBAR */
    .sidebar {
      width: 240px;
      background: var(--sidebar-bg);
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 12px rgba(0,0,0,0.1);
      z-index: 1000;
      padding: 1.5rem 0;
      transition: transform 0.3s ease;
    }

    .sidebar.mobile-hidden {
      transform: translateX(-100%);
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .sidebar-overlay.show {
      display: block;
      opacity: 1;
    }

    .sidebar-logo {
      padding: 0 1.5rem 1.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 1rem;
    }

    .logo-content {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: white;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--orange), var(--orange-dark));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .logo-icon:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
    }

    .logo-icon:hover::after {
      content: 'üì∑';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .logo-text {
      font-weight: 700;
      font-size: 1.1rem;
    }

    .logo-subtitle {
      font-size: 0.75rem;
      color: var(--gray-400);
      display: block;
      margin-top: 0.125rem;
    }

    .sidebar-nav {
      flex: 1;
      padding: 0 0.75rem;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      color: var(--gray-400);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 0.25rem;
    }

    .nav-item:hover {
      background: var(--sidebar-hover);
      color: white;
    }

    .nav-item.active {
      background: var(--orange);
      color: white;
    }

    .nav-section-title {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 1.5rem 1rem 0.75rem;
    }

    /* MAIN CONTENT */
    .main-wrapper {
      margin-left: 240px;
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* TOP BAR */
    .top-bar {
      background: white;
      border-bottom: 1px solid var(--gray-200);
      padding: 0.75rem 1rem;
      height: auto;
      min-height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    @media (min-width: 992px) {
      .top-bar {
        padding: 0 2rem;
        height: 70px;
      }
    }

    .page-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    @media (min-width: 768px) {
      .page-title {
        font-size: 1.75rem;
      }
    }

    .page-subtitle {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin: 0.25rem 0 0 0;
    }

    @media (min-width: 768px) {
      .page-subtitle {
        font-size: 0.875rem;
      }
    }

    /* CONTENT AREA */
    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background: #f0f2f5;
    }

    @media (min-width: 768px) {
      .content-area {
        padding: 2rem;
      }
    }

    /* CARDS */
    .card {
      background: white !important;
      border: 1px solid var(--gray-200) !important;
      border-radius: 12px !important;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05) !important;
    }

    /* STAT CARDS */
    .stat-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1rem;
    }

    @media (min-width: 768px) {
      .stat-card {
        padding: 1.5rem;
      }
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @media (min-width: 768px) {
      .stat-icon {
        width: 48px;
        height: 48px;
      }
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    @media (min-width: 768px) {
      .stat-label {
        font-size: 0.875rem;
      }
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    @media (min-width: 768px) {
      .stat-value {
        font-size: 2rem;
      }
    }

    /* PROGRESS BARS */
    .progress-item {
      margin-bottom: 1rem;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .progress {
      height: 8px;
      border-radius: 999px;
      background: var(--gray-100);
    }

    .progress-bar {
      border-radius: 999px;
    }

    /* CALENDAR */
    .calendar-header-custom {
      background: white;
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    @media (min-width: 768px) {
      .calendar-header-custom {
        padding: 1.5rem 2rem;
        margin-bottom: 1.5rem;
      }
    }

    .cal-grid {
      background: white !important;
      border-radius: 12px !important;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05) !important;
      display: grid !important;
      grid-template-columns: repeat(7, 1fr) !important;
      gap: 0 !important;
    }

    .cal-head {
      background: var(--gray-50) !important;
      color: var(--gray-500) !important;
      padding: 0.5rem !important;
      text-align: center !important;
      font-weight: 600 !important;
      font-size: 0.7rem !important;
      border-bottom: 1px solid var(--gray-200) !important;
    }

    @media (min-width: 768px) {
      .cal-head {
        padding: 1rem !important;
        font-size: 0.875rem !important;
      }
    }

    .cal-cell {
      background: white !important;
      border-right: 1px solid var(--gray-100) !important;
      border-bottom: 1px solid var(--gray-100) !important;
      padding: 0.5rem !important;
      min-height: 80px !important;
      transition: background 0.2s ease !important;
      border-radius: 0 !important;
    }

    @media (min-width: 768px) {
      .cal-cell {
        padding: 12px !important;
        min-height: 120px !important;
      }
    }

    .cal-cell:nth-child(7n) {
      border-right: none !important;
    }

    .cal-cell:hover {
      background: var(--gray-50) !important;
    }

    .cal-day {
      font-weight: 600 !important;
      color: var(--text-primary) !important;
      font-size: 0.85rem !important;
    }

    @media (min-width: 768px) {
      .cal-day {
        font-size: 0.95rem !important;
      }
    }

    .task-pill {
      background: var(--orange) !important;
      color: white !important;
      padding: 3px 6px !important;
      border-radius: 6px !important;
      font-size: 0.65rem !important;
      font-weight: 500 !important;
      display: block !important;
      margin-top: 4px !important;
      white-space: nowrap !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
    }

    @media (min-width: 768px) {
      .task-pill {
        padding: 4px 8px !important;
        font-size: 0.75rem !important;
        margin-top: 6px !important;
      }
    }

    .task-pill small {
      color: rgba(255,255,255,0.9) !important;
      display: none;
    }

    @media (min-width: 768px) {
      .task-pill small {
        display: inline;
      }
    }

    /* CALENDAR LIST VIEW (Mobile) */
    #calendarListView {
      background: white;
      border-radius: 12px;
      overflow: hidden;
    }

    .cal-list-day {
      border-bottom: 1px solid var(--gray-100);
    }

    .cal-list-day:last-child {
      border-bottom: none;
    }

    .cal-list-day-header {
      background: var(--gray-50);
      padding: 0.75rem 1rem;
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .cal-list-day-header:hover {
      background: var(--gray-100);
    }

    .cal-list-day-header.today {
      background: rgba(255, 107, 53, 0.1);
      color: var(--orange);
    }

    .cal-list-day-number {
      font-size: 1.5rem;
      font-weight: 700;
      width: 48px;
      text-align: center;
    }

    .cal-list-day-name {
      flex: 1;
      padding-left: 0.75rem;
    }

    .cal-list-tasks {
      padding: 0;
    }

    .cal-list-task {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--gray-100);
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .cal-list-task:hover {
      background: var(--gray-50);
    }

    .cal-list-task:last-child {
      border-bottom: none;
    }

    .cal-list-task-color {
      width: 4px;
      height: 100%;
      min-height: 40px;
      border-radius: 2px;
      flex-shrink: 0;
    }

    .cal-list-task-content {
      flex: 1;
      min-width: 0;
    }

    .cal-list-task-title {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
      word-wrap: break-word;
    }

    .cal-list-task-meta {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .cal-list-task-badge {
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      background: var(--gray-100);
      color: var(--text-secondary);
    }

    .cal-list-empty {
      padding: 1rem;
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .cal-list-add-btn {
      padding: 0.5rem;
      background: transparent;
      border: none;
      color: var(--orange);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .cal-list-add-btn:hover {
      background: rgba(255, 107, 53, 0.1);
      border-radius: 4px;
    }

    /* Hide list view on desktop */
    @media (min-width: 992px) {
      #calendarListView {
        display: none !important;
      }
      
      #calViewToggle {
        display: none !important;
      }
    }

    /* DAY & WEEK VIEW */
    .day-view-container,
    .week-view-container {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .day-view-header,
    .week-day-header {
      background: var(--gray-50);
      padding: 1rem;
      border-bottom: 1px solid var(--gray-200);
      font-weight: 600;
      text-align: center;
    }

    .day-view-content,
    .week-view-content {
      padding: 1rem;
      min-height: 400px;
    }

    .week-view-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--gray-200);
      border: 1px solid var(--gray-200);
    }

    .week-day-column {
      background: white;
      min-height: 400px;
      padding: 0.5rem;
    }

    .week-day-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      text-align: center;
      margin-bottom: 0.5rem;
    }

    .week-day-column.today {
      background: rgba(255, 107, 53, 0.05);
    }

    .week-day-column.today .week-day-number {
      color: var(--orange);
    }

    .time-slot {
      padding: 0.75rem;
      border-bottom: 1px solid var(--gray-100);
      min-height: 60px;
    }

    .time-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .day-task-item,
    .week-task-item {
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s ease;
      border-left: 3px solid;
    }

    .day-task-item:hover,
    .week-task-item:hover {
      transform: translateX(2px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    @media (max-width: 991px) {
      .week-view-grid {
        grid-template-columns: 1fr;
      }

      .week-day-column {
        border-bottom: 2px solid var(--gray-200);
      }
    }

    /* TASK CARD */
    .task-card {
      border: 1px solid var(--gray-200);
      border-left: 4px solid;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      background: white;
      transition: all 0.2s ease;
    }

    .task-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }

    .task-card.priority-haute { border-left-color: #EF4444; }
    .task-card.priority-moyenne { border-left-color: #FBBF24; }
    .task-card.priority-basse { border-left-color: #6B7280; }

    /* TEAM CARD */
    .team-card {
      border-radius: 12px;
      padding: 1.5rem;
      color: white;
      margin-bottom: 1rem;
      position: relative;
      overflow: hidden;
    }

    .team-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, transparent 0%, rgba(0,0,0,0.1) 100%);
      pointer-events: none;
    }

    /* EVENT CARD */
    .event-card {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      background: white;
      margin-bottom: 0.75rem;
      transition: all 0.2s ease;
    }

    .event-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .event-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* BUTTONS */
    .btn {
      border-radius: 8px !important;
      font-weight: 500 !important;
      transition: all 0.2s ease !important;
    }

    .btn-primary {
      background: var(--orange) !important;
      border: none !important;
      color: white !important;
    }

    .btn-primary:hover {
      background: var(--orange-dark) !important;
    }

    .btn-outline-secondary,
    .btn-secondary {
      background: white !important;
      border: 1px solid var(--gray-300) !important;
      color: var(--gray-700) !important;
    }

    .btn-outline-secondary:hover,
    .btn-secondary:hover {
      background: var(--gray-50) !important;
      border-color: var(--gray-400) !important;
    }

    .btn-outline-primary {
      background: transparent !important;
      border: 2px solid var(--orange) !important;
      color: var(--orange) !important;
    }

    .btn-outline-primary:hover {
      background: var(--orange) !important;
      color: white !important;
    }

    .btn-danger {
      background: #DC2626 !important;
      border: none !important;
      color: white !important;
    }

    .btn-danger:hover {
      background: #B91C1C !important;
    }

    /* FORMS */
    .form-control,
    .form-select {
      background: white !important;
      border: 1px solid var(--gray-300) !important;
      color: var(--text-primary) !important;
      border-radius: 8px !important;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--orange) !important;
      box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1) !important;
    }

    .form-label {
      color: var(--gray-700) !important;
      font-weight: 600 !important;
      font-size: 0.875rem !important;
    }

    /* COLOR PALETTE */
    .color-palette {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .color-option {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s ease;
      position: relative;
    }

    .color-option:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .color-option.selected {
      border-color: var(--text-primary);
      box-shadow: 0 0 0 2px white, 0 0 0 4px var(--text-primary);
    }

    .color-option.selected::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: 700;
      font-size: 1rem;
      text-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    /* BADGES */
    .badge {
      border-radius: 999px !important;
      font-size: 0.8rem !important;
      padding: 0.35rem 0.75rem !important;
    }

    .badge-soft {
      background: rgba(255, 107, 53, 0.1) !important;
      color: var(--orange) !important;
    }

    /* TABS */
    .nav-tabs {
      border-bottom: 2px solid var(--gray-200) !important;
    }

    .nav-tabs .nav-link {
      border: none !important;
      color: var(--text-secondary) !important;
      font-weight: 500 !important;
      padding: 0.75rem 1.5rem !important;
      transition: all 0.2s ease !important;
    }

    .nav-tabs .nav-link:hover {
      color: var(--orange) !important;
      border: none !important;
    }

    .nav-tabs .nav-link.active {
      color: var(--orange) !important;
      background: transparent !important;
      border: none !important;
      border-bottom: 2px solid var(--orange) !important;
    }

    /* ALERTS */
    .alert {
      border-radius: 10px !important;
      border: 1px solid !important;
    }

    .alert-danger {
      background: rgba(220, 38, 38, 0.1) !important;
      color: #DC2626 !important;
      border-color: rgba(220, 38, 38, 0.3) !important;
    }

    .alert-success {
      background: rgba(34, 197, 94, 0.1) !important;
      color: #059669 !important;
      border-color: rgba(34, 197, 94, 0.3) !important;
    }

    /* UTILITIES */
    .hidden {
      display: none !important;
    }

    .pointer {
      cursor: pointer !important;
    }

    /* SCROLLBAR */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--gray-100);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--gray-300);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--gray-400);
    }

    /* RESPONSIVE */
    @media (max-width: 991px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.show {
        transform: translateX(0);
      }
      
      .main-wrapper {
        margin-left: 0;
      }
    }

    @media (min-width: 992px) {
      .sidebar {
        transform: translateX(0) !important;
      }
    }

    /* Mobile optimizations */
    @media (max-width: 576px) {
      .btn-group {
        flex-wrap: wrap;
      }

      .card {
        margin-bottom: 1rem;
      }

      h5, h6 {
        font-size: 1rem;
      }

      .task-card {
        padding: 0.75rem;
      }
    }
  </style>
</head>

<body>
  <div class="container py-4">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <div class="logo-content">
          <div class="logo-icon" id="logoContainer" style="cursor:pointer;" onclick="document.getElementById('logoUpload').click()">
            <span id="logoInitials">FK</span>
            <img id="logoImage" style="width:100%;height:100%;object-fit:cover;border-radius:8px;display:none;" />
          </div>
          <input type="file" id="logoUpload" accept="image/*" style="display:none;" onchange="handleLogoUpload(event)">
          <div>
            <div class="logo-text">FK Team Planner</div>
            <span class="logo-subtitle">Gestion d'√©quipe</span>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <a href="#" class="nav-item" data-view="dashboard">
          <i data-lucide="layout-dashboard" style="width:20px;height:20px;"></i>
          Tableau de bord
        </a>
        <a href="#" class="nav-item active" data-view="calendar">
          <i data-lucide="calendar" style="width:20px;height:20px;"></i>
          Calendrier
        </a>
        <a href="#" class="nav-item" data-view="tasks">
          <i data-lucide="check-square" style="width:20px;height:20px;"></i>
          T√¢ches
        </a>
        <a href="#" class="nav-item" data-view="teams">
          <i data-lucide="users" style="width:20px;height:20px;"></i>
          √âquipes
        </a>
        <a href="#" class="nav-item" data-view="events">
          <i data-lucide="star" style="width:20px;height:20px;"></i>
          √âv√©nements
        </a>

        <div class="nav-section-title">VUES RAPIDES</div>
        <a href="#" class="nav-item" data-filter="mine">
          <i data-lucide="user" style="width:20px;height:20px;"></i>
          Mes t√¢ches
        </a>
        <a href="#" class="nav-item" data-filter="late">
          <i data-lucide="alert-circle" style="width:20px;height:20px;"></i>
          En retard
        </a>
        <a href="#" class="nav-item" data-filter="week">
          <i data-lucide="calendar-days" style="width:20px;height:20px;"></i>
          Cette semaine
        </a>
      </nav>
    </aside>

    <!-- SIDEBAR OVERLAY (Mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- MAIN WRAPPER -->
    <div class="main-wrapper">

      <!-- TOP BAR -->
      <header class="top-bar">
        <div class="d-flex align-items-center gap-3">
          <button class="btn btn-outline-secondary d-lg-none" id="mobileSidebarToggle" style="padding:0.5rem;">
            <i data-lucide="menu" style="width:20px;height:20px;"></i>
          </button>
          <div>
            <h1 class="page-title" id="pageTitle">Calendrier</h1>
            <p class="page-subtitle" id="pageSubtitle">Janvier 2026</p>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="badge text-bg-light border d-none d-md-inline" id="roleBadge">non connect√©</span>
          <span class="text-secondary small d-none d-md-inline" id="userEmail"></span>
          
          <!-- Guest mode: Login button -->
          <button class="btn btn-primary btn-sm" id="btnLogin" onclick="showLoginModal()" style="display:none;">
            <i data-lucide="log-in" style="width:16px;height:16px;"></i>
            <span class="d-none d-lg-inline ms-1">Se connecter</span>
          </button>
          
          <!-- Logged in: Logout button -->
          <button class="btn btn-outline-secondary btn-sm hidden" id="btnLogout">
            <i data-lucide="log-out" class="d-lg-none" style="width:16px;height:16px;"></i>
            <span class="d-none d-lg-inline">Se d√©connecter</span>
          </button>
        </div>
      </header>

      <!-- CONTENT AREA -->
      <main class="content-area" id="mainContentArea">

        <!-- AUTH VIEW -->
        <div id="authView" class="row g-3">
          <div class="col-12">
            <div class="card p-4 text-center">
              <h3 class="mb-3">üëã Bienvenue sur FK Team Planner</h3>
              <p class="text-secondary mb-4">
                Vous pouvez <strong>consulter</strong> le calendrier et les t√¢ches sans vous connecter.<br>
                Pour <strong>cr√©er ou modifier</strong> des t√¢ches, veuillez vous connecter.
              </p>
              <div class="d-flex gap-2 justify-content-center mb-3">
                <button class="btn btn-primary" onclick="continueAsGuest()">
                  <i data-lucide="eye" style="width:16px;height:16px;"></i>
                  Continuer en lecture seule
                </button>
                <button class="btn btn-outline-primary" onclick="showLoginModal()">
                  <i data-lucide="log-in" style="width:16px;height:16px;"></i>
                  Se connecter
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- LOGIN MODAL -->
        <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="loginModalLabel">Connexion / Inscription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="row g-3">
                  <div class="col-12 col-lg-6">
                    <div class="card p-4">
                      <h4 class="mb-1">Connexion</h4>
                      <p class="text-secondary mb-4">Connecte-toi pour g√©rer les t√¢ches.</p>

                      <!-- Tabs pour choisir entre mot de passe et magic link -->
                      <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                          <button class="nav-link active" id="password-tab" data-bs-toggle="tab" data-bs-target="#password-login" type="button" role="tab">
                            Mot de passe
                          </button>
                        </li>
                        <li class="nav-item" role="presentation">
                          <button class="nav-link" id="magiclink-tab" data-bs-toggle="tab" data-bs-target="#magiclink-login" type="button" role="tab">
                            Magic Link
                          </button>
                        </li>
                      </ul>

                      <div class="tab-content">
                        <!-- PASSWORD LOGIN -->
                        <div class="tab-pane fade show active" id="password-login" role="tabpanel">
                          <form id="loginForm" class="vstack gap-2">
                            <div>
                              <label class="form-label" for="loginEmail">Email</label>
                              <input class="form-control" type="email" id="loginEmail" required />
                            </div>
                            <div>
                              <label class="form-label" for="loginPassword">Mot de passe</label>
                              <input class="form-control" type="password" id="loginPassword" required />
                            </div>
                            <button class="btn btn-primary mt-2" type="submit">Se connecter</button>
                          </form>
                        </div>

                        <!-- MAGIC LINK LOGIN -->
                        <div class="tab-pane fade" id="magiclink-login" role="tabpanel">
                          <form id="magicLinkForm" class="vstack gap-2">
                            <div>
                              <label class="form-label" for="magicLinkEmail">Email</label>
                              <input class="form-control" type="email" id="magicLinkEmail" required />
                              <div class="form-text">Un lien de connexion sera envoy√© √† cette adresse.</div>
                            </div>
                            <button class="btn btn-primary mt-2" type="submit">
                              <i data-lucide="mail" style="width:16px;height:16px;display:inline-block;vertical-align:middle;"></i>
                              Envoyer le Magic Link
                            </button>
                          </form>
                        </div>
                      </div>

                      <div class="alert alert-danger mt-3 hidden" id="loginError"></div>
                      <div class="alert alert-success mt-3 hidden" id="loginOk"></div>
                    </div>
                  </div>

                  <div class="col-12 col-lg-6">
                    <div class="card p-4">
                      <h4 class="mb-1">Cr√©er un compte</h4>
                      <p class="text-secondary mb-4">Inscription simple (email + mot de passe).</p>

                      <form id="registerForm" class="vstack gap-2">
                        <div>
                          <label class="form-label" for="regName">Nom complet (optionnel)</label>
                          <input class="form-control" type="text" id="regName" placeholder="Anthony POIGNARD" />
                        </div>
                        <div>
                          <label class="form-label" for="regEmail">Email</label>
                          <input class="form-control" type="email" id="regEmail" required />
                        </div>
                        <div>
                          <label class="form-label" for="regPassword">Mot de passe</label>
                          <input class="form-control" type="password" id="regPassword" required minlength="6" />
                          <div class="form-text">Min 6 caract√®res.</div>
                        </div>

                        <button class="btn btn-outline-primary mt-2" type="submit">Cr√©er le compte</button>
                      </form>

                      <div class="alert alert-danger mt-3 hidden" id="regError"></div>
                      <div class="alert alert-success mt-3 hidden" id="regOk"></div>
                      
                      <!-- DEV MODE: Quick bypass for rate limit issues -->
                      <div class="mt-3 pt-3 border-top">
                        <small class="text-muted">üõ†Ô∏è Mode d√©veloppement</small>
                        <button class="btn btn-sm btn-outline-secondary w-100 mt-2" onclick="bypassEmailConfirmation()">
                          Cr√©er compte sans confirmation email
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- APP VIEW -->
        <div id="appView" class="hidden">

          <!-- DASHBOARD VIEW -->
          <div id="dashboardView" class="hidden">
            <div class="row g-3 mb-4">
              <div class="col-12 col-lg-3">
                <div class="stat-card">
                  <div class="d-flex align-items-center gap-3">
                    <div class="stat-icon" style="background:rgba(59,130,246,0.1);">
                      <i data-lucide="clipboard-list" style="width:24px;height:24px;color:#3B82F6;"></i>
                    </div>
                    <div>
                      <div class="stat-label">Total des t√¢ches</div>
                      <div class="stat-value" id="totalTasks">0</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-lg-3">
                <div class="stat-card">
                  <div class="d-flex align-items-center gap-3">
                    <div class="stat-icon" style="background:rgba(34,197,94,0.1);">
                      <i data-lucide="check-circle" style="width:24px;height:24px;color:#22C55E;"></i>
                    </div>
                    <div>
                      <div class="stat-label">Termin√©es</div>
                      <div class="stat-value" id="doneTasks">0</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-lg-3">
                <div class="stat-card">
                  <div class="d-flex align-items-center gap-3">
                    <div class="stat-icon" style="background:rgba(251,191,36,0.1);">
                      <i data-lucide="clock" style="width:24px;height:24px;color:#FBBF24;"></i>
                    </div>
                    <div>
                      <div class="stat-label">En cours</div>
                      <div class="stat-value" id="inProgressTasks">0</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-lg-3">
                <div class="stat-card">
                  <div class="d-flex align-items-center gap-3">
                    <div class="stat-icon" style="background:rgba(239,68,68,0.1);">
                      <i data-lucide="alert-triangle" style="width:24px;height:24px;color:#EF4444;"></i>
                    </div>
                    <div>
                      <div class="stat-label">En retard</div>
                      <div class="stat-value text-danger" id="lateTasks">0</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-12 col-lg-6">
                <div class="card p-4">
                  <h5 class="mb-3">R√©partition par statut</h5>
                  <div id="statusBreakdown"></div>
                </div>
              </div>
              <div class="col-12 col-lg-6">
                <div class="card p-4">
                  <h5 class="mb-3">R√©partition par priorit√©</h5>
                  <div id="priorityBreakdown"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- CALENDAR VIEW -->
          <div id="calendarView" class="hidden">
            <div class="calendar-header-custom">
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="calPrev">
                  <i data-lucide="chevron-left"></i>
                </button>
                <div class="fw-semibold" style="min-width:140px;text-align:center;" id="calTitle"></div>
                <button class="btn btn-outline-secondary btn-sm" id="calNext">
                  <i data-lucide="chevron-right"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="calToday">Aujourd'hui</button>
              </div>
              <div class="d-flex gap-2">
                <!-- Desktop view switcher -->
                <div class="btn-group d-none d-lg-flex" role="group">
                  <button class="btn btn-outline-secondary btn-sm" id="calViewDay">Jour</button>
                  <button class="btn btn-outline-secondary btn-sm" id="calViewWeek">Semaine</button>
                  <button class="btn btn-outline-secondary btn-sm active" id="calViewMonth">Mois</button>
                </div>
                <!-- Mobile list toggle -->
                <button class="btn btn-outline-secondary btn-sm d-lg-none" id="calViewToggle" title="Changer de vue">
                  <i data-lucide="list" id="calViewIcon"></i>
                </button>
              </div>
            </div>

            <!-- Vue grille (desktop et tablette) -->
            <div id="calendarGridView">
              <div class="cal-grid" id="calGrid">
                <div class="cal-head">Lun</div>
                <div class="cal-head">Mar</div>
                <div class="cal-head">Mer</div>
                <div class="cal-head">Jeu</div>
                <div class="cal-head">Ven</div>
                <div class="cal-head">Sam</div>
                <div class="cal-head">Dim</div>
              </div>
            </div>

            <!-- Vue liste (mobile) -->
            <div id="calendarListView" class="hidden">
              <div id="calListContent"></div>
            </div>
          </div>

          <!-- TASKS VIEW -->
          <div id="tasksView" class="hidden">
            <div class="row g-3">
              <div class="col-12">
                <div class="card p-3">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">T√¢ches</h5>
                    <div class="d-flex gap-2">
                      <button class="btn btn-primary require-auth" onclick="showCreateTaskModal()">
                        <i data-lucide="plus" style="width:14px;height:14px;"></i>
                        Nouvelle t√¢che
                      </button>
                      <button class="btn btn-outline-secondary btn-sm" onclick="downloadTasksTemplate()">
                        <i data-lucide="download" style="width:14px;height:14px;"></i>
                        Mod√®le
                      </button>
                      <button class="btn btn-outline-secondary btn-sm require-auth" onclick="document.getElementById('importTasksFile').click()">
                        <i data-lucide="upload" style="width:14px;height:14px;"></i>
                        Import TXT
                      </button>
                      <input type="file" id="importTasksFile" accept=".txt,.tsv" style="display:none;" onchange="importTasks(event)">
                      <button class="btn btn-success btn-sm" onclick="exportTasksCSV()">
                        <i data-lucide="download" style="width:14px;height:14px;"></i>
                        Export TXT
                      </button>
                      <button class="btn btn-success btn-sm" onclick="exportTasksJSON()">
                        <i data-lucide="download" style="width:14px;height:14px;"></i>
                        Export JSON
                      </button>
                      <button class="btn btn-primary btn-sm" onclick="exportTasksiCal()">
                        <i data-lucide="calendar" style="width:14px;height:14px;"></i>
                        Export iCal
                      </button>
                    </div>
                  </div>

                  <div class="d-flex gap-2 mb-3">
                    <select class="form-select form-select-sm" id="taskStatusFilter" style="width:auto;">
                      <option value="">Tous</option>
                      <option value="todo">√Ä faire</option>
                      <option value="done">Termin√©es</option>
                    </select>
                    <select class="form-select form-select-sm" id="taskPriorityFilter" style="width:auto;">
                      <option value="">Toutes</option>
                      <option value="haute">Haute</option>
                      <option value="moyenne">Moyenne</option>
                      <option value="basse">Basse</option>
                    </select>
                    <select class="form-select form-select-sm" id="taskTeamFilter" style="width:auto;">
                      <option value="">Toutes</option>
                    </select>
                  </div>

                  <div id="tasksListView"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- TEAMS VIEW -->
          <div id="teamsView" class="hidden">
            <div class="row g-3 mb-3">
              <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h5>√âquipes</h5>
                    <p class="text-secondary small mb-0">G√©rez vos √©quipes et leurs t√¢ches</p>
                  </div>
                  <button class="btn btn-primary" onclick="showCreateTeamModal()">
                    <i data-lucide="plus" style="width:16px;height:16px;"></i>
                    Nouvelle √©quipe
                  </button>
                </div>
              </div>
            </div>

            <div class="row g-3" id="teamsGrid"></div>
          </div>

          <!-- EVENTS VIEW -->
          <div id="eventsView" class="hidden">
            <div class="row g-3 mb-3">
              <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h5>√âv√©nements</h5>
                    <p class="text-secondary small mb-0">Jours f√©ri√©s, soldes et √©v√©nements sp√©ciaux</p>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('importEventsFile').click()">
                      <i data-lucide="upload" style="width:14px;height:14px;"></i>
                      Import TXT
                    </button>
                    <input type="file" id="importEventsFile" accept=".txt,.tsv" style="display:none;" onchange="importEvents(event)">
                    <button class="btn btn-success btn-sm" onclick="exportEventsCSV()">
                      <i data-lucide="download" style="width:14px;height:14px;"></i>
                      Export TXT
                    </button>
                    <button class="btn btn-success btn-sm" onclick="exportEventsJSON()">
                      <i data-lucide="download" style="width:14px;height:14px;"></i>
                      Export JSON
                    </button>
                    <button class="btn btn-primary" onclick="showCreateEventModal()">
                      <i data-lucide="plus" style="width:16px;height:16px;"></i>
                      Nouvel √©v√©nement
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div id="eventsListView"></div>
          </div>

        </div>

      </main>
    </div>
  </div>

  <!-- MODAL: CREATE/EDIT TASK -->
  <div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalTitle" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="taskModalTitle">Nouvelle t√¢che</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="taskModalForm">
            <input type="hidden" id="taskModalId">
            
            <div class="mb-3">
              <label class="form-label" for="taskModalTitre">Titre *</label>
              <input type="text" class="form-control" id="taskModalTitre" required>
            </div>

            <div class="mb-3">
              <label class="form-label" for="taskModalDescription">Description</label>
              <textarea class="form-control" id="taskModalDescription" rows="3"></textarea>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label" for="taskModalCategorie">Cat√©gorie</label>
                <select class="form-select" id="taskModalCategorie">
                  <option value="Design">Design</option>
                  <option value="Dev">Dev</option>
                  <option value="Marketing">Marketing</option>
                  <option value="Commercial">Commercial</option>
                  <option value="Production">Production</option>
                  <option value="Logistique">Logistique</option>
                  <option value="Autre">Autre</option>
                </select>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Couleur</label>
                <div class="color-palette" id="taskModalCouleurPalette">
                  <div class="color-option" data-color="#FF6B35" style="background:#FF6B35;" title="Orange"></div>
                  <div class="color-option" data-color="#3B82F6" style="background:#3B82F6;" title="Bleu"></div>
                  <div class="color-option" data-color="#10B981" style="background:#10B981;" title="Vert"></div>
                  <div class="color-option" data-color="#F59E0B" style="background:#F59E0B;" title="Jaune"></div>
                  <div class="color-option" data-color="#EF4444" style="background:#EF4444;" title="Rouge"></div>
                  <div class="color-option" data-color="#8B5CF6" style="background:#8B5CF6;" title="Violet"></div>
                  <div class="color-option" data-color="#EC4899" style="background:#EC4899;" title="Rose"></div>
                  <div class="color-option" data-color="#14B8A6" style="background:#14B8A6;" title="Turquoise"></div>
                  <div class="color-option" data-color="#6B7280" style="background:#6B7280;" title="Gris"></div>
                </div>
                <input type="hidden" id="taskModalCouleur" value="#FF6B35">
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label" for="taskModalPriorite">Priorit√©</label>
              <select class="form-select" id="taskModalPriorite">
                <option value="basse">Basse</option>
                <option value="moyenne" selected>Moyenne</option>
                <option value="haute">Haute</option>
              </select>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label" for="taskModalDateDebut">Date de d√©but *</label>
                <input type="date" class="form-control" id="taskModalDateDebut" required>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label" for="taskModalDateFin">Date de fin *</label>
                <input type="date" class="form-control" id="taskModalDateFin" required>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label" for="taskModalEquipe">√âquipe *</label>
              <select class="form-select" id="taskModalEquipe" required>
                <option value="">S√©lectionner une √©quipe</option>
              </select>
            </div>

            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="taskModalCompleted">
                <label class="form-check-label" for="taskModalCompleted">
                  T√¢che termin√©e
                </label>
              </div>
            </div>

            <div class="alert alert-danger hidden" id="taskModalError"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-primary" onclick="saveTaskFromModal()">Enregistrer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>

  <script>
    // =========================
    // CONFIG
    // =========================
    const SUPABASE_URL = "https://yeusqubxgxchigssobma.supabase.co";
    const SUPABASE_KEY = "sb_publishable_FkwKSPbHO3CPHdRvt35img__s3HSY5R";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // =========================
    // STATE
    // =========================
    let session = null;
    let user = null;
    let globalRole = null;
    let teams = [];
    let tasks = [];
    let events = [];
    let memberships = [];
    let calDate = new Date();
    let isGuestMode = false; // Mode lecture seule

    // =========================
    // UTILS
    // =========================
    function show(el){ if(el) el.classList.remove("hidden"); }
    function hide(el){ if(el) el.classList.add("hidden"); }
    function setText(el, txt){ if(el) el.textContent = txt; }
    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function ymd(dateObj){
      const y = dateObj.getFullYear();
      const m = String(dateObj.getMonth()+1).padStart(2,"0");
      const d = String(dateObj.getDate()).padStart(2,"0");
      return `${y}-${m}-${d}`;
    }
    function fmtDate(d){
      try {
        const dt = new Date(d + "T00:00:00");
        return dt.toLocaleDateString("fr-FR");
      } catch { return d; }
    }
    function isBetween(dateStr, startStr, endStr){
      return dateStr >= startStr && dateStr <= endStr;
    }

    // =========================
    // MOBILE SIDEBAR
    // =========================
    const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
    const sidebar = document.querySelector('.sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    function toggleMobileSidebar() {
      sidebar.classList.toggle('show');
      sidebarOverlay.classList.toggle('show');
      document.body.style.overflow = sidebar.classList.contains('show') ? 'hidden' : '';
    }

    function closeMobileSidebar() {
      sidebar.classList.remove('show');
      sidebarOverlay.classList.remove('show');
      document.body.style.overflow = '';
    }

    if (mobileSidebarToggle) {
      mobileSidebarToggle.addEventListener('click', toggleMobileSidebar);
    }

    if (sidebarOverlay) {
      sidebarOverlay.addEventListener('click', closeMobileSidebar);
    }

    // Close sidebar when clicking on a nav item on mobile
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        if (window.innerWidth < 992) {
          closeMobileSidebar();
        }
      });
    });

    // =========================
    // CALENDAR VIEW TOGGLE (Mobile)
    // =========================
    let calendarViewMode = 'grid'; // 'grid' or 'list'
    let calendarDesktopView = 'month'; // 'day', 'week', or 'month'

    function toggleCalendarView() {
      const gridView = document.getElementById('calendarGridView');
      const listView = document.getElementById('calendarListView');
      const viewIcon = document.getElementById('calViewIcon');

      if (calendarViewMode === 'grid') {
        calendarViewMode = 'list';
        hide(gridView);
        show(listView);
        viewIcon.setAttribute('data-lucide', 'calendar');
        renderCalendarList();
      } else {
        calendarViewMode = 'grid';
        show(gridView);
        hide(listView);
        viewIcon.setAttribute('data-lucide', 'list');
      }

      // Refresh icons
      if (window.lucide) lucide.createIcons();
    }

    function setCalendarDesktopView(view) {
      calendarDesktopView = view;

      // Update button states
      document.getElementById('calViewDay')?.classList.remove('active');
      document.getElementById('calViewWeek')?.classList.remove('active');
      document.getElementById('calViewMonth')?.classList.remove('active');

      if (view === 'day') {
        document.getElementById('calViewDay')?.classList.add('active');
      } else if (view === 'week') {
        document.getElementById('calViewWeek')?.classList.add('active');
      } else {
        document.getElementById('calViewMonth')?.classList.add('active');
      }

      renderCalendar();
    }

    const calViewToggle = document.getElementById('calViewToggle');
    if (calViewToggle) {
      calViewToggle.addEventListener('click', toggleCalendarView);
    }

    // Desktop view buttons
    document.getElementById('calViewDay')?.addEventListener('click', () => setCalendarDesktopView('day'));
    document.getElementById('calViewWeek')?.addEventListener('click', () => setCalendarDesktopView('week'));
    document.getElementById('calViewMonth')?.addEventListener('click', () => setCalendarDesktopView('month'));

    // =========================
    // LOGO UPLOAD
    // =========================
    function handleLogoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Check file type
      if (!file.type.startsWith('image/')) {
        alert('Veuillez s√©lectionner une image');
        return;
      }

      // Check file size (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        alert('L\'image ne doit pas d√©passer 2MB');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const logoImage = document.getElementById('logoImage');
        const logoInitials = document.getElementById('logoInitials');
        
        if (logoImage && logoInitials) {
          logoImage.src = e.target.result;
          logoImage.style.display = 'block';
          logoInitials.style.display = 'none';
          
          // Save to localStorage
          try {
            localStorage.setItem('fk_team_planner_logo', e.target.result);
          } catch (err) {
            console.error('Erreur sauvegarde logo:', err);
          }
        }
      };
      reader.readAsDataURL(file);
    }

    function loadSavedLogo() {
      try {
        const savedLogo = localStorage.getItem('fk_team_planner_logo');
        if (savedLogo) {
          const logoImage = document.getElementById('logoImage');
          const logoInitials = document.getElementById('logoInitials');
          
          if (logoImage && logoInitials) {
            logoImage.src = savedLogo;
            logoImage.style.display = 'block';
            logoInitials.style.display = 'none';
          }
        }
      } catch (err) {
        console.error('Erreur chargement logo:', err);
      }
    }

    // =========================
    // TASK MODAL
    // =========================
    let taskModal = null;
    let currentEditingTaskId = null;

    document.addEventListener('DOMContentLoaded', () => {
      const taskModalEl = document.getElementById('taskModal');
      if (taskModalEl) {
        taskModal = new bootstrap.Modal(taskModalEl);
      }

      // Color palette click handlers
      setupColorPalette();
    });

    function setupColorPalette() {
      const palette = document.getElementById('taskModalCouleurPalette');
      if (!palette) return;

      palette.addEventListener('click', (e) => {
        const colorOption = e.target.closest('.color-option');
        if (!colorOption) return;

        const color = colorOption.getAttribute('data-color');
        selectColor(color);
      });
    }

    function selectColor(color) {
      // Update hidden input
      const hiddenInput = document.getElementById('taskModalCouleur');
      if (hiddenInput) hiddenInput.value = color;

      // Update visual selection
      document.querySelectorAll('.color-option').forEach(option => {
        option.classList.remove('selected');
      });

      const selectedOption = document.querySelector(`.color-option[data-color="${color}"]`);
      if (selectedOption) selectedOption.classList.add('selected');
    }

    function resetTaskColor() {
      selectColor('#FF6B35');
    }

    function showCreateTaskModal(defaultDate = null) {
      if (isGuestMode) {
        alert('üîí Vous devez vous connecter pour cr√©er des t√¢ches.\n\nCliquez sur "Se connecter" en haut √† droite.');
        return;
      }

      currentEditingTaskId = null;
      
      document.getElementById('taskModalTitle').textContent = 'Nouvelle t√¢che';
      document.getElementById('taskModalId').value = '';
      document.getElementById('taskModalTitre').value = '';
      document.getElementById('taskModalDescription').value = '';
      document.getElementById('taskModalCategorie').value = 'Autre';
      document.getElementById('taskModalPriorite').value = 'moyenne';
      selectColor('#FF6B35');
      document.getElementById('taskModalCompleted').checked = false;
      
      const today = defaultDate || ymd(new Date());
      document.getElementById('taskModalDateDebut').value = today;
      document.getElementById('taskModalDateFin').value = today;

      // Populate teams
      const teamSelect = document.getElementById('taskModalEquipe');
      teamSelect.innerHTML = '<option value="">S√©lectionner une √©quipe</option>';
      teams.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.name;
        teamSelect.appendChild(opt);
      });

      hide(document.getElementById('taskModalError'));
      
      if (taskModal) taskModal.show();
    }

    function showEditTaskModal(taskId) {
      if (isGuestMode) {
        alert('üîí Vous devez vous connecter pour modifier des t√¢ches.\n\nCliquez sur "Se connecter" en haut √† droite.');
        return;
      }

      const task = tasks.find(t => t.id === taskId);
      if (!task) return;

      currentEditingTaskId = taskId;
      
      document.getElementById('taskModalTitle').textContent = 'Modifier la t√¢che';
      document.getElementById('taskModalId').value = task.id;
      document.getElementById('taskModalTitre').value = task.title || '';
      document.getElementById('taskModalDescription').value = task.description || '';
      document.getElementById('taskModalCategorie').value = task.category || 'Autre';
      document.getElementById('taskModalPriorite').value = task.priority || 'moyenne';
      selectColor(task.color || '#FF6B35');
      document.getElementById('taskModalDateDebut').value = task.start_date || '';
      document.getElementById('taskModalDateFin').value = task.end_date || '';
      document.getElementById('taskModalCompleted').checked = task.completed || false;

      // Populate teams
      const teamSelect = document.getElementById('taskModalEquipe');
      teamSelect.innerHTML = '<option value="">S√©lectionner une √©quipe</option>';
      teams.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.name;
        if (t.id === task.team_id) opt.selected = true;
        teamSelect.appendChild(opt);
      });

      hide(document.getElementById('taskModalError'));
      
      if (taskModal) taskModal.show();
    }

    async function saveTaskFromModal() {
      const titre = document.getElementById('taskModalTitre').value.trim();
      const description = document.getElementById('taskModalDescription').value.trim();
      const categorie = document.getElementById('taskModalCategorie').value;
      const priorite = document.getElementById('taskModalPriorite').value;
      const couleur = document.getElementById('taskModalCouleur').value;
      const dateDebut = document.getElementById('taskModalDateDebut').value;
      const dateFin = document.getElementById('taskModalDateFin').value;
      const equipeId = document.getElementById('taskModalEquipe').value;
      const completed = document.getElementById('taskModalCompleted').checked;

      // Validation
      if (!titre) {
        const errorEl = document.getElementById('taskModalError');
        errorEl.textContent = 'Le titre est requis';
        show(errorEl);
        return;
      }

      if (!equipeId) {
        const errorEl = document.getElementById('taskModalError');
        errorEl.textContent = 'Veuillez s√©lectionner une √©quipe';
        show(errorEl);
        return;
      }

      if (dateFin < dateDebut) {
        const errorEl = document.getElementById('taskModalError');
        errorEl.textContent = 'La date de fin doit √™tre >= √† la date de d√©but';
        show(errorEl);
        return;
      }

      const taskData = {
        title: titre,
        description: description || null,
        category: categorie,
        priority: priorite,
        color: couleur,
        start_date: dateDebut,
        end_date: dateFin,
        team_id: equipeId,
        completed: completed,
        created_by: user.id
      };

      try {
        if (currentEditingTaskId) {
          // Update existing task
          const { error } = await supabaseClient
            .from('tasks')
            .update(taskData)
            .eq('id', currentEditingTaskId);

          if (error) throw error;
        } else {
          // Create new task
          const { error } = await supabaseClient
            .from('tasks')
            .insert([taskData]);

          if (error) throw error;
        }

        // Reload and refresh
        await loadTasks();
        renderTasksList();
        renderCalendar();
        renderDashboard();

        // Close modal
        if (taskModal) taskModal.hide();

      } catch (error) {
        const errorEl = document.getElementById('taskModalError');
        errorEl.textContent = error.message || 'Erreur lors de la sauvegarde';
        show(errorEl);
        console.error(error);
      }
    }

    // =========================
    // NAVIGATION
    // =========================
    function switchView(viewName) {
      // Hide all views
      const views = ['dashboardView', 'calendarView', 'tasksView', 'teamsView', 'eventsView'];
      views.forEach(v => {
        const el = document.getElementById(v);
        if (el) hide(el);
      });

      // Show selected view
      const viewEl = document.getElementById(viewName);
      if (viewEl) show(viewEl);

      // Update active nav
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      const activeNav = document.querySelector(`.nav-item[data-view="${viewName.replace('View', '')}"]`);
      if (activeNav) activeNav.classList.add('active');

      // Update page title
      const titles = {
        dashboardView: { title: 'Tableau de bord', subtitle: 'Vue d\'ensemble de toutes les √©quipes' },
        calendarView: { title: 'Calendrier', subtitle: `${monthNames[calDate.getMonth()]} ${calDate.getFullYear()}` },
        tasksView: { title: 'T√¢ches', subtitle: 'Gestion des t√¢ches' },
        teamsView: { title: '√âquipes', subtitle: 'Gestion des √©quipes' },
        eventsView: { title: '√âv√©nements', subtitle: 'Jours f√©ri√©s et √©v√©nements sp√©ciaux' }
      };

      const titleData = titles[viewName];
      if (titleData) {
        setText(document.getElementById('pageTitle'), titleData.title);
        setText(document.getElementById('pageSubtitle'), titleData.subtitle);
      }

      // Render view content
      if (viewName === 'dashboardView') renderDashboard();
      else if (viewName === 'calendarView') {
        renderCalendar();
        // Auto switch to list view on mobile
        if (window.innerWidth < 992 && calendarViewMode === 'grid') {
          toggleCalendarView();
        }
      }
      else if (viewName === 'tasksView') renderTasksList();
      else if (viewName === 'teamsView') renderTeamsGrid();
      else if (viewName === 'eventsView') renderEventsList();

      // Refresh icons
      if (window.lucide) lucide.createIcons();
    }

    // Setup nav clicks
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.nav-item[data-view]').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const view = item.getAttribute('data-view') + 'View';
          switchView(view);
        });
      });
    });

    // =========================
    // GUEST MODE
    // =========================
    let loginModalInstance = null;

    function updateUIForAuthState() {
      // Hide/show elements based on guest mode
      const requireAuthElements = document.querySelectorAll('.require-auth');
      requireAuthElements.forEach(el => {
        if (isGuestMode) {
          el.style.display = 'none';
        } else {
          el.style.display = '';
        }
      });
    }

    function continueAsGuest() {
      console.log('üîµ continueAsGuest called');
      isGuestMode = true;
      
      // Hide auth view
      const authView = document.getElementById('authView');
      const appView = document.getElementById('appView');
      
      console.log('authView:', authView);
      console.log('appView:', appView);
      
      if (authView) {
        hide(authView);
        console.log('‚úÖ Auth view hidden');
      }
      
      // Show app view
      if (appView) {
        show(appView);
        console.log('‚úÖ App view shown');
      }
      
      // Set guest UI
      setText(document.getElementById('userEmail'), 'Mode lecture seule');
      setText(document.getElementById('roleBadge'), 'üëÅÔ∏è Invit√©');
      
      // Show login button, hide logout button
      const btnLogin = document.getElementById('btnLogin');
      const btnLogout = document.getElementById('btnLogout');
      if (btnLogin) btnLogin.style.display = 'inline-flex';
      if (btnLogout) hide(btnLogout);
      
      // Update UI elements
      updateUIForAuthState();
      
      // Load data without user
      loadGuestData();
      
      // Show calendar by default
      switchView('calendarView');

      if (window.lucide) lucide.createIcons();
      
      console.log('‚úÖ continueAsGuest finished');
    }

    function showLoginModal() {
      const modalEl = document.getElementById('loginModal');
      if (!modalEl) return;
      
      if (!loginModalInstance) {
        loginModalInstance = new bootstrap.Modal(modalEl);
      }
      loginModalInstance.show();
      
      if (window.lucide) lucide.createIcons();
    }

    async function loadGuestData() {
      console.log('üîµ loadGuestData called');
      try {
        // Load teams (public read)
        const { data: teamsData, error: teamsError } = await supabaseClient
          .from('teams')
          .select('*')
          .order('name');
        
        if (teamsError) {
          console.warn('‚ö†Ô∏è Error loading teams:', teamsError);
          teams = [];
        } else {
          teams = teamsData || [];
          console.log('‚úÖ Teams loaded:', teams.length);
        }

        // Load tasks with team info (public read)
        const { data: tasksData, error: tasksError } = await supabaseClient
          .from('tasks')
          .select('*, teams(*)')
          .order('start_date');
        
        if (tasksError) {
          console.warn('‚ö†Ô∏è Error loading tasks:', tasksError);
          tasks = [];
        } else {
          tasks = tasksData || [];
          console.log('‚úÖ Tasks loaded:', tasks.length);
        }

        // Load events (public read)
        const { data: eventsData, error: eventsError } = await supabaseClient
          .from('events')
          .select('*')
          .order('start_date');
        
        if (eventsError) {
          console.warn('‚ö†Ô∏è Error loading events:', eventsError);
          events = [];
        } else {
          events = eventsData || [];
          console.log('‚úÖ Events loaded:', events.length);
        }

        populateTaskFilters();
        console.log('‚úÖ loadGuestData finished');
        
      } catch (error) {
        console.error('‚ùå Error in loadGuestData:', error);
        // Set empty arrays so the app doesn't crash
        teams = [];
        tasks = [];
        events = [];
      }
    }

    // =========================
    // AUTH
    // =========================
    async function bypassEmailConfirmation() {
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value;

      if (!email || !password) {
        alert('‚ö†Ô∏è Veuillez remplir email et mot de passe');
        return;
      }

      if (password.length < 6) {
        alert('‚ö†Ô∏è Le mot de passe doit faire au moins 6 caract√®res');
        return;
      }

      try {
        // Try to sign up with autoConfirm disabled (will work if email confirmation is disabled in Supabase)
        const { data, error } = await supabaseClient.auth.signUp({
          email,
          password,
          options: {
            data: {
              full_name: document.getElementById('regName').value || null
            }
          }
        });

        if (error) {
          // If signup fails, try to login instead (user might already exist)
          const { data: loginData, error: loginError } = await supabaseClient.auth.signInWithPassword({
            email,
            password
          });

          if (loginError) {
            throw new Error(`Erreur: ${error.message}\n\nSuggestion: V√©rifiez que la confirmation email est d√©sactiv√©e dans Supabase (Authentication ‚Üí Settings ‚Üí Disable email confirmation)`);
          }

          alert('‚úÖ Connexion r√©ussie avec le compte existant!');
          if (loginModalInstance) loginModalInstance.hide();
          return;
        }

        if (data.user && !data.session) {
          alert('‚ö†Ô∏è Compte cr√©√© mais vous devez confirmer votre email.\n\nPour d√©sactiver cette contrainte:\n1. Supabase Dashboard\n2. Authentication ‚Üí Settings\n3. Disable "Enable email confirmations"');
          return;
        }

        alert('‚úÖ Compte cr√©√© et connect√©!');
        if (loginModalInstance) loginModalInstance.hide();

      } catch (err) {
        alert('‚ùå ' + err.message);
        console.error(err);
      }
    }

    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(document.getElementById("loginError"));
      hide(document.getElementById("loginOk"));

      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;

      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        const box = document.getElementById("loginError");
        box.textContent = error.message;
        show(box);
        return;
      }
      
      const ok = document.getElementById("loginOk");
      ok.textContent = "‚úÖ Connect√© ! Redirection...";
      show(ok);
      
      // Close modal and reload
      setTimeout(() => {
        if (loginModalInstance) loginModalInstance.hide();
        // Force reload to switch from guest to authenticated mode
        window.location.reload();
      }, 500);
    });

    // Magic Link Form
    document.getElementById("magicLinkForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(document.getElementById("loginError"));
      hide(document.getElementById("loginOk"));

      const email = document.getElementById("magicLinkEmail").value.trim();

      try {
        const { error } = await supabaseClient.auth.signInWithOtp({
          email: email,
          options: {
            emailRedirectTo: window.location.origin + window.location.pathname
          }
        });

        if (error) {
          // Check if it's a rate limit error
          if (error.message.includes('rate limit') || error.message.includes('email rate')) {
            throw new Error('‚è±Ô∏è Trop de tentatives d\'envoi d\'email.\n\nSolutions:\n1. Attendez 1 heure\n2. Utilisez la connexion par mot de passe\n3. Contactez l\'administrateur');
          }
          throw error;
        }

        const ok = document.getElementById("loginOk");
        ok.textContent = `‚úâÔ∏è Magic Link envoy√© √† ${email}. V√©rifie ta bo√Æte mail !`;
        show(ok);

        // Clear form
        document.getElementById("magicLinkEmail").value = "";

      } catch (error) {
        const box = document.getElementById("loginError");
        box.textContent = error.message || "Erreur lors de l'envoi du Magic Link";
        show(box);
        console.error(error);
      }
    });

    document.getElementById("registerForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      hide(document.getElementById("regError"));
      hide(document.getElementById("regOk"));

      const name = document.getElementById("regName").value.trim();
      const email = document.getElementById("regEmail").value.trim();
      const password = document.getElementById("regPassword").value;

      const { data, error } = await supabaseClient.auth.signUp({
        email,
        password,
        options: {
          data: { full_name: name }
        }
      });

      if (error) {
        const box = document.getElementById("regError");
        box.textContent = error.message;
        show(box);
        return;
      }

      if (data.user && !data.session) {
        const ok = document.getElementById("regOk");
        ok.textContent = "‚ö†Ô∏è Compte cr√©√© ! V√©rifie ton email pour confirmer.";
        show(ok);
        return;
      }

      const ok = document.getElementById("regOk");
      ok.textContent = "‚úÖ Compte cr√©√© ! Redirection...";
      show(ok);
      
      // Close modal and reload
      setTimeout(() => {
        if (loginModalInstance) loginModalInstance.hide();
        window.location.reload();
      }, 500);
    });

    document.getElementById("btnLogout").addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
    });

    // =========================
    // DATA LOADERS
    // =========================
    async function loadAllData() {
      await Promise.all([
        loadTeams(),
        loadTasks(),
        loadEvents()
      ]);
    }

    async function loadTeams() {
      const { data, error } = await supabaseClient
        .from("teams")
        .select("*")
        .order("name", { ascending: true });
      if (!error) teams = data || [];
    }

    async function loadTasks() {
      const { data, error } = await supabaseClient
        .from("tasks")
        .select("*, teams(name)")
        .order("start_date", { ascending: true });
      if (!error) tasks = data || [];
    }

    async function loadEvents() {
      const { data, error } = await supabaseClient
        .from("events")
        .select("*")
        .order("start_date", { ascending: true });
      if (!error) events = data || [];
    }

    // =========================
    // DASHBOARD
    // =========================
    function renderDashboard() {
      const today = new Date();
      today.setHours(0,0,0,0);
      const todayStr = ymd(today);

      const total = tasks.length;
      const done = tasks.filter(t => t.completed).length;
      const inProgress = tasks.filter(t => !t.completed && t.end_date >= todayStr).length;
      const late = tasks.filter(t => !t.completed && t.end_date < todayStr).length;

      setText(document.getElementById('totalTasks'), total);
      setText(document.getElementById('doneTasks'), done);
      setText(document.getElementById('inProgressTasks'), inProgress);
      setText(document.getElementById('lateTasks'), late);

      // Status breakdown
      const statusBreakdown = document.getElementById('statusBreakdown');
      if (statusBreakdown) {
        const todoCount = tasks.filter(t => !t.completed).length;
        const todoPercent = total > 0 ? Math.round((todoCount / total) * 100) : 0;
        const donePercent = total > 0 ? Math.round((done / total) * 100) : 0;

        statusBreakdown.innerHTML = `
          <div class="progress-item">
            <div class="progress-label">
              <span>√Ä faire</span>
              <span class="fw-semibold">${todoCount}</span>
            </div>
            <div class="progress">
              <div class="progress-bar bg-secondary" style="width:${todoPercent}%"></div>
            </div>
          </div>
          <div class="progress-item">
            <div class="progress-label">
              <span>Termin√©e</span>
              <span class="fw-semibold">${done}</span>
            </div>
            <div class="progress">
              <div class="progress-bar bg-success" style="width:${donePercent}%"></div>
            </div>
          </div>
        `;
      }

      // Priority breakdown
      const priorityBreakdown = document.getElementById('priorityBreakdown');
      if (priorityBreakdown) {
        const hauteCount = tasks.filter(t => t.priority === 'haute').length;
        const moyenneCount = tasks.filter(t => t.priority === 'moyenne').length;
        const basseCount = tasks.filter(t => t.priority === 'basse').length;

        const hautePercent = total > 0 ? Math.round((hauteCount / total) * 100) : 0;
        const moyennePercent = total > 0 ? Math.round((moyenneCount / total) * 100) : 0;
        const bassePercent = total > 0 ? Math.round((basseCount / total) * 100) : 0;

        priorityBreakdown.innerHTML = `
          <div class="progress-item">
            <div class="progress-label">
              <span>Basse</span>
              <span class="fw-semibold">${basseCount}</span>
            </div>
            <div class="progress">
              <div class="progress-bar bg-secondary" style="width:${bassePercent}%"></div>
            </div>
          </div>
          <div class="progress-item">
            <div class="progress-label">
              <span>Moyenne</span>
              <span class="fw-semibold">${moyenneCount}</span>
            </div>
            <div class="progress">
              <div class="progress-bar bg-warning" style="width:${moyennePercent}%"></div>
            </div>
          </div>
          <div class="progress-item">
            <div class="progress-label">
              <span>Haute</span>
              <span class="fw-semibold">${hauteCount}</span>
            </div>
            <div class="progress">
              <div class="progress-bar bg-danger" style="width:${hautePercent}%"></div>
            </div>
          </div>
        `;
      }
    }

    // =========================
    // CALENDAR LIST VIEW
    // =========================
    function renderCalendarList() {
      const container = document.getElementById('calListContent');
      if (!container) return;

      container.innerHTML = "";

      const year = calDate.getFullYear();
      const month = calDate.getMonth();
      const lastDay = new Date(year, month + 1, 0).getDate();

      const today = ymd(new Date());
      const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

      for (let day = 1; day <= lastDay; day++) {
        const dt = new Date(year, month, day);
        const dStr = ymd(dt);
        const dayName = dayNames[dt.getDay()];

        // Get tasks for this day
        const dayTasks = tasks.filter(t => t.start_date && t.end_date && isBetween(dStr, t.start_date, t.end_date));
        const dayEvents = events.filter(e => e.start_date && e.end_date && isBetween(dStr, e.start_date, e.end_date));

        const allItems = [...dayTasks, ...dayEvents];

        // Skip days with no tasks/events (optional - comment out to show all days)
        // if (!allItems.length) continue;

        const dayDiv = document.createElement('div');
        dayDiv.className = 'cal-list-day';

        const isToday = dStr === today;

        dayDiv.innerHTML = `
          <div class="cal-list-day-header ${isToday ? 'today' : ''}">
            <div class="d-flex align-items-center">
              <div class="cal-list-day-number">${day}</div>
              <div class="cal-list-day-name">
                <div>${dayName}</div>
                ${isToday ? '<div class="small" style="font-weight:400;font-size:0.75rem;">Aujourd\'hui</div>' : ''}
              </div>
            </div>
            <button class="cal-list-add-btn" onclick="showCreateTaskModal('${dStr}')" title="Ajouter une t√¢che">
              <i data-lucide="plus" style="width:20px;height:20px;"></i>
            </button>
          </div>
          <div class="cal-list-tasks" id="tasks-${dStr}"></div>
        `;

        container.appendChild(dayDiv);

        const tasksContainer = document.getElementById(`tasks-${dStr}`);

        if (!allItems.length) {
          tasksContainer.innerHTML = '<div class="cal-list-empty">Aucune t√¢che</div>';
        } else {
          for (const item of allItems) {
            const isEvent = !item.team_id; // Events don't have team_id
            const color = isEvent ? '#9333EA' : (item.color || '#FF6B35');
            const teamName = isEvent ? '' : ((item.teams && item.teams.name) ? item.teams.name : '');

            const taskDiv = document.createElement('div');
            taskDiv.className = 'cal-list-task';
            if (!isEvent) {
              taskDiv.onclick = () => showEditTaskModal(item.id);
            }

            taskDiv.innerHTML = `
              <div class="cal-list-task-color" style="background:${color};"></div>
              <div class="cal-list-task-content">
                <div class="cal-list-task-title">${escapeHtml(item.title || item.name)}</div>
                <div class="cal-list-task-meta">
                  ${teamName ? `<span class="cal-list-task-badge">${escapeHtml(teamName)}</span>` : ''}
                  ${item.category ? `<span class="cal-list-task-badge">${escapeHtml(item.category)}</span>` : ''}
                  ${item.type ? `<span class="cal-list-task-badge">${escapeHtml(item.type)}</span>` : ''}
                  ${item.completed ? '<span class="cal-list-task-badge" style="background:#22C55E;color:white;">‚úì Termin√©e</span>' : ''}
                </div>
              </div>
            `;

            tasksContainer.appendChild(taskDiv);
          }
        }
      }

      // Refresh icons
      if (window.lucide) lucide.createIcons();
    }

    // =========================
    // CALENDAR
    // =========================
    const monthNames = ["Janvier","F√©vrier","Mars","Avril","Mai","Juin","Juillet","Ao√ªt","Septembre","Octobre","Novembre","D√©cembre"];

    function renderCalendar() {
      if (calendarDesktopView === 'day') {
        renderDayView();
      } else if (calendarDesktopView === 'week') {
        renderWeekView();
      } else {
        renderMonthView();
      }
    }

    function renderDayView() {
      const calGrid = document.getElementById('calGrid');
      if (!calGrid) return;

      const dateStr = ymd(calDate);
      const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
      const dayName = dayNames[calDate.getDay()];

      // Update title
      setText(document.getElementById('calTitle'), `${calDate.getDate()} ${monthNames[calDate.getMonth()]} ${calDate.getFullYear()}`);

      // Get tasks for this day
      const dayTasks = tasks.filter(t => t.start_date && t.end_date && isBetween(dateStr, t.start_date, t.end_date));
      const dayEvents = events.filter(e => e.start_date && e.end_date && isBetween(dateStr, e.start_date, e.end_date));

      const allItems = [...dayTasks, ...dayEvents].sort((a, b) => {
        const aStart = a.start_date || a.start_date;
        const bStart = b.start_date || b.start_date;
        return aStart.localeCompare(bStart);
      });

      calGrid.innerHTML = `
        <div class="day-view-container">
          <div class="day-view-header">
            ${dayName} ${calDate.getDate()} ${monthNames[calDate.getMonth()]} ${calDate.getFullYear()}
          </div>
          <div class="day-view-content">
            ${allItems.length === 0 ? '<div class="text-center text-secondary py-5">Aucune t√¢che pour cette journ√©e</div>' : ''}
            ${allItems.map(item => {
              const isEvent = !item.team_id;
              const color = isEvent ? '#9333EA' : (item.color || getTeamColor(item.team_id));
              const teamName = isEvent ? '' : ((item.teams && item.teams.name) ? item.teams.name : '');
              
              return `
                <div class="day-task-item ${isEvent ? '' : 'pointer'}" 
                     style="background:${color}15;border-left-color:${color};"
                     ${isEvent ? '' : `onclick="showEditTaskModal('${item.id}')"`}>
                  <div class="d-flex align-items-start justify-content-between">
                    <div class="flex-grow-1">
                      <div class="fw-semibold" style="color:${color};">${escapeHtml(item.title || item.name)}</div>
                      ${item.description ? `<div class="small text-secondary mt-1">${escapeHtml(item.description)}</div>` : ''}
                      <div class="d-flex gap-2 mt-2 flex-wrap">
                        ${teamName ? `<span class="badge bg-light text-dark">${escapeHtml(teamName)}</span>` : ''}
                        ${item.category ? `<span class="badge bg-light text-dark">${escapeHtml(item.category)}</span>` : ''}
                        ${item.completed ? '<span class="badge bg-success text-white">‚úì Termin√©e</span>' : ''}
                      </div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;

      if (window.lucide) lucide.createIcons();
    }

    function renderWeekView() {
      const calGrid = document.getElementById('calGrid');
      if (!calGrid) return;

      // Get Monday of current week
      const curr = new Date(calDate);
      const first = curr.getDate() - curr.getDay() + (curr.getDay() === 0 ? -6 : 1);
      const monday = new Date(curr.setDate(first));

      const weekDays = [];
      for (let i = 0; i < 7; i++) {
        const day = new Date(monday);
        day.setDate(monday.getDate() + i);
        weekDays.push(day);
      }

      const startStr = ymd(weekDays[0]);
      const endStr = ymd(weekDays[6]);

      // Update title
      setText(document.getElementById('calTitle'), 
        `${weekDays[0].getDate()} ${monthNames[weekDays[0].getMonth()]} - ${weekDays[6].getDate()} ${monthNames[weekDays[6].getMonth()]} ${weekDays[6].getFullYear()}`);

      const today = ymd(new Date());
      const dayNamesShort = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

      calGrid.innerHTML = `
        <div class="week-view-container">
          <div class="week-view-content">
            <div class="week-view-grid">
              ${weekDays.map(day => {
                const dateStr = ymd(day);
                const isToday = dateStr === today;
                const dayTasks = tasks.filter(t => t.start_date && t.end_date && isBetween(dateStr, t.start_date, t.end_date));
                const dayEvents = events.filter(e => e.start_date && e.end_date && isBetween(dateStr, e.start_date, e.end_date));
                const allItems = [...dayTasks, ...dayEvents];

                return `
                  <div class="week-day-column ${isToday ? 'today' : ''}">
                    <div class="week-day-header">
                      ${dayNamesShort[day.getDay()]}
                      <div class="week-day-number">${day.getDate()}</div>
                    </div>
                    ${allItems.length === 0 ? '<div class="text-center text-secondary small py-2">-</div>' : ''}
                    ${allItems.map(item => {
                      const isEvent = !item.team_id;
                      const color = isEvent ? '#9333EA' : (item.color || getTeamColor(item.team_id));
                      
                      return `
                        <div class="week-task-item ${isEvent ? '' : 'pointer'}" 
                             style="background:${color}15;border-left-color:${color};"
                             ${isEvent ? '' : `onclick="showEditTaskModal('${item.id}')"`}>
                          <div class="small fw-semibold" style="color:${color};">${escapeHtml(item.title || item.name)}</div>
                          ${item.completed ? '<div class="small text-success">‚úì</div>' : ''}
                        </div>
                      `;
                    }).join('')}
                    <button class="btn btn-sm btn-outline-primary w-100 mt-2" onclick="showCreateTaskModal('${dateStr}')" style="font-size:0.75rem;">
                      <i data-lucide="plus" style="width:12px;height:12px;"></i>
                    </button>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;

      if (window.lucide) lucide.createIcons();
    }

    function renderMonthView() {
      const calGrid = document.getElementById('calGrid');
      if (!calGrid) return;

      // Clear existing cells (keep headers)
      const cells = calGrid.querySelectorAll('.cal-cell');
      cells.forEach(c => c.remove());

      const year = calDate.getFullYear();
      const month = calDate.getMonth();

      const first = new Date(year, month, 1);
      const last = new Date(year, month + 1, 0);

      let startDay = first.getDay();
      if (startDay === 0) startDay = 7;
      startDay = startDay - 1;

      // Empty cells
      for (let i=0; i<startDay; i++) {
        const cell = document.createElement("div");
        cell.className = "cal-cell";
        cell.style.opacity = "0.35";
        calGrid.appendChild(cell);
      }

      // Days
      const today = ymd(new Date());
      for (let day=1; day<=last.getDate(); day++) {
        const dt = new Date(year, month, day);
        const dStr = ymd(dt);

        const cell = document.createElement("div");
        cell.className = "cal-cell";
        if (dStr === today) cell.setAttribute('data-today', 'true');

        // Highlight today
        if (dStr === today) {
          cell.style.background = "rgba(255, 107, 53, 0.05)";
          cell.style.border = "2px solid var(--orange)";
        }

        // Tasks for this day
        const dayTasks = tasks.filter(t => t.start_date && t.end_date && isBetween(dStr, t.start_date, t.end_date)).slice(0, 3);

        // Events for this day
        const dayEvents = events.filter(e => e.start_date && e.end_date && isBetween(dStr, e.start_date, e.end_date)).slice(0, 2);

        let html = `<div class="d-flex align-items-center justify-content-between mb-2">
          <div class="cal-day">${day}</div>
          <button class="btn btn-sm btn-primary" onclick="showCreateTaskModal('${dStr}')" title="Ajouter une t√¢che" style="padding:2px 6px;">
            <i data-lucide="plus" style="width:12px;height:12px;"></i>
          </button>
        </div>`;

        for (const t of dayTasks) {
          const teamName = (t.teams && t.teams.name) ? t.teams.name : "";
          const taskColor = t.color || '#FF6B35';
          html += `<div class="task-pill mb-1 pointer" onclick="showEditTaskModal('${t.id}')" title="Cliquer pour modifier" style="background:${taskColor} !important;">${escapeHtml(t.title)}<br><small>${escapeHtml(teamName)}</small></div>`;
        }

        for (const e of dayEvents) {
          html += `<div class="task-pill mb-1" style="background:#9333EA !important;">${escapeHtml(e.name)}</div>`;
        }

        cell.innerHTML = html;
        calGrid.appendChild(cell);
      }

      // Update title
      setText(document.getElementById('calTitle'), `${monthNames[month]} ${year}`);
      setText(document.getElementById('pageSubtitle'), `${monthNames[month]} ${year}`);

      // Refresh icons
      if (window.lucide) lucide.createIcons();

      // Auto-scroll to today on first load
      setTimeout(() => {
        const todayCell = document.querySelector('.cal-cell[data-today="true"]');
        if (todayCell && !window.calendarScrolledToToday) {
          todayCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
          window.calendarScrolledToToday = true;
        }
      }, 300);
    }

    document.getElementById('calPrev')?.addEventListener('click', () => {
      if (calendarDesktopView === 'day') {
        calDate.setDate(calDate.getDate() - 1);
      } else if (calendarDesktopView === 'week') {
        calDate.setDate(calDate.getDate() - 7);
      } else {
        calDate.setMonth(calDate.getMonth() - 1);
      }
      renderCalendar();
      if (calendarViewMode === 'list') renderCalendarList();
    });

    document.getElementById('calNext')?.addEventListener('click', () => {
      if (calendarDesktopView === 'day') {
        calDate.setDate(calDate.getDate() + 1);
      } else if (calendarDesktopView === 'week') {
        calDate.setDate(calDate.getDate() + 7);
      } else {
        calDate.setMonth(calDate.getMonth() + 1);
      }
      renderCalendar();
      if (calendarViewMode === 'list') renderCalendarList();
    });

    document.getElementById('calToday')?.addEventListener('click', () => {
      calDate = new Date();
      renderCalendar();
      if (calendarViewMode === 'list') renderCalendarList();
      
      // Scroll to today if in month view
      if (calendarDesktopView === 'month') {
        setTimeout(() => {
          const todayCell = document.querySelector('.cal-cell[data-today="true"]');
          if (todayCell) {
            todayCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 100);
      }
    });

    // =========================
    // TASKS
    // =========================
    function renderTasksList() {
      const container = document.getElementById('tasksListView');
      if (!container) return;

      container.innerHTML = "";

      // Apply filters
      let filtered = [...tasks];

      const statusFilter = document.getElementById('taskStatusFilter')?.value;
      if (statusFilter === 'todo') filtered = filtered.filter(t => !t.completed);
      if (statusFilter === 'done') filtered = filtered.filter(t => t.completed);

      const priorityFilter = document.getElementById('taskPriorityFilter')?.value;
      if (priorityFilter) filtered = filtered.filter(t => t.priority === priorityFilter);

      const teamFilter = document.getElementById('taskTeamFilter')?.value;
      if (teamFilter) filtered = filtered.filter(t => t.team_id === teamFilter);

      if (!filtered.length) {
        container.innerHTML = `<div class="text-secondary">Aucune t√¢che.</div>`;
        return;
      }

      for (const t of filtered) {
        const teamName = (t.teams && t.teams.name) ? t.teams.name : "";
        const priorityClass = t.priority || 'basse';
        const taskColor = t.color || '#FF6B35';

        const card = document.createElement('div');
        card.className = `task-card priority-${priorityClass}`;
        card.style.borderLeftColor = taskColor;
        card.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <div class="d-flex align-items-center gap-2 mb-2">
                <div class="d-flex align-items-center gap-2">
                  <div style="width:16px;height:16px;background:${taskColor};border-radius:4px;"></div>
                  <h6 class="mb-0">${escapeHtml(t.title)}</h6>
                </div>
                ${t.completed ? '<span class="badge bg-success">‚úì Termin√©e</span>' : '<span class="badge bg-warning">√Ä faire</span>'}
              </div>
              <p class="text-secondary small mb-2">${escapeHtml(t.description || '')}</p>
              <div class="d-flex gap-2 flex-wrap">
                <span class="badge bg-light text-dark">${escapeHtml(teamName)}</span>
                <span class="badge bg-light text-dark">${escapeHtml(t.category || 'Autre')}</span>
                <span class="badge bg-light text-dark">${fmtDate(t.start_date)} ‚Üí ${fmtDate(t.end_date)}</span>
                ${t.priority ? `<span class="badge bg-${t.priority === 'haute' ? 'danger' : t.priority === 'moyenne' ? 'warning' : 'secondary'}">${escapeHtml(t.priority)}</span>` : ''}
              </div>
            </div>
            ${!isGuestMode ? `
            <div class="d-flex gap-1">
              <button class="btn btn-sm btn-outline-primary" onclick="showEditTaskModal('${t.id}')" title="Modifier">
                <i data-lucide="edit" style="width:14px;height:14px;"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteTask('${t.id}')" title="Supprimer">
                <i data-lucide="trash-2" style="width:14px;height:14px;"></i>
              </button>
            </div>
            ` : ''}
          </div>
        `;
        container.appendChild(card);
      }

      if (window.lucide) lucide.createIcons();
    }

    // Populate team filter
    function populateTaskFilters() {
      const teamFilter = document.getElementById('taskTeamFilter');
      if (!teamFilter) return;

      teamFilter.innerHTML = '<option value="">Toutes</option>';
      teams.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.name;
        teamFilter.appendChild(opt);
      });
    }

    document.getElementById('taskStatusFilter')?.addEventListener('change', renderTasksList);
    document.getElementById('taskPriorityFilter')?.addEventListener('change', renderTasksList);
    document.getElementById('taskTeamFilter')?.addEventListener('change', renderTasksList);

    async function deleteTask(taskId) {
      if (isGuestMode) {
        alert('üîí Vous devez vous connecter pour supprimer des t√¢ches.');
        return;
      }

      if (!confirm('Supprimer cette t√¢che ?')) return;

      const { error } = await supabaseClient
        .from('tasks')
        .delete()
        .eq('id', taskId);

      if (error) {
        alert('Erreur: ' + error.message);
        return;
      }

      await loadTasks();
      renderTasksList();
      renderCalendar();
    }

    // =========================
    // TEAMS
    // =========================
    function renderTeamsGrid() {
      const container = document.getElementById('teamsGrid');
      if (!container) return;

      container.innerHTML = "";

      teams.forEach((team, index) => {
        const color = getTeamColor(team.id);
        const teamTasks = tasks.filter(t => t.team_id === team.id);

        const col = document.createElement('div');
        col.className = 'col-12 col-lg-4';
        col.innerHTML = `
          <div class="team-card" style="background:${color};">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <h5 class="mb-1">${escapeHtml(team.name)}</h5>
                <div class="opacity-75">${teamTasks.length} t√¢che(s)</div>
                <div class="small opacity-75 mt-1">Couleur: ${color}</div>
              </div>
              <button class="btn btn-sm btn-light" onclick="deleteTeam('${team.id}')">
                <i data-lucide="trash-2" style="width:14px;height:14px;"></i>
              </button>
            </div>
            <div class="vstack gap-2">
              ${teamTasks.slice(0, 3).map(t => `
                <div class="bg-white bg-opacity-25 rounded p-2 small">
                  ${escapeHtml(t.title)}
                </div>
              `).join('')}
              ${teamTasks.length > 3 ? `<div class="small opacity-75">+ ${teamTasks.length - 3} autres...</div>` : ''}
            </div>
          </div>
        `;
        container.appendChild(col);
      });

      if (!teams.length) {
        container.innerHTML = `<div class="col-12"><div class="text-secondary">Aucune √©quipe.</div></div>`;
      }

      if (window.lucide) lucide.createIcons();
    }

    async function deleteTeam(teamId) {
      if (isGuestMode) {
        alert('üîí Vous devez vous connecter pour supprimer des √©quipes.');
        return;
      }

      if (!confirm('Supprimer cette √©quipe et toutes ses t√¢ches ?')) return;

      // Delete tasks first
      await supabaseClient.from('tasks').delete().eq('team_id', teamId);

      const { error } = await supabaseClient
        .from('teams')
        .delete()
        .eq('id', teamId);

      if (error) {
        alert('Erreur: ' + error.message);
        return;
      }

      await loadAllData();
      renderTeamsGrid();
    }

    function showCreateTeamModal() {
      if (isGuestMode) {
        alert('üîí Vous devez vous connecter pour cr√©er des √©quipes.');
        return;
      }

      const name = prompt('Nom de l\'√©quipe:');
      if (!name) return;

      createTeam(name);
    }

    async function createTeam(name) {
      if (isGuestMode) return;
      const { error } = await supabaseClient
        .from('teams')
        .insert([{ name, created_by: user.id }]);

      if (error) {
        alert('Erreur: ' + error.message);
        return;
      }

      await loadTeams();
      renderTeamsGrid();
      populateTaskFilters();
    }

    // =========================
    // EVENTS
    // =========================
    function renderEventsList() {
      const container = document.getElementById('eventsListView');
      if (!container) return;

      container.innerHTML = "";

      if (!events.length) {
        container.innerHTML = `<div class="text-secondary">Aucun √©v√©nement.</div>`;
        return;
      }

      const eventColors = {
        'Jour f√©ri√©': '#EF4444',
        'Soldes': '#EC4899',
        'F√™te': '#F59E0B',
        'Autre': '#6B7280'
      };

      for (const e of events) {
        const color = eventColors[e.type] || eventColors['Autre'];

        const card = document.createElement('div');
        card.className = 'event-card';
        card.innerHTML = `
          <div class="event-dot" style="background:${color};"></div>
          <div class="flex-grow-1">
            <div class="fw-semibold">${escapeHtml(e.name)}</div>
            <div class="small text-secondary">${fmtDate(e.start_date)}${e.end_date && e.end_date !== e.start_date ? ' - ' + fmtDate(e.end_date) : ''}</div>
          </div>
          <span class="badge" style="background:${color};">${escapeHtml(e.type || 'Autre')}</span>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteEvent('${e.id}')">
            <i data-lucide="trash-2" style="width:14px;height:14px;"></i>
          </button>
        `;
        container.appendChild(card);
      }

      if (window.lucide) lucide.createIcons();
    }

    async function deleteEvent(eventId) {
      if (isGuestMode) {
        alert('üîí Vous devez vous connecter pour supprimer des √©v√©nements.');
        return;
      }

      if (!confirm('Supprimer cet √©v√©nement ?')) return;

      const { error } = await supabaseClient
        .from('events')
        .delete()
        .eq('id', eventId);

      if (error) {
        alert('Erreur: ' + error.message);
        return;
      }

      await loadEvents();
      renderEventsList();
      renderCalendar();
    }

    function showCreateEventModal() {
      if (isGuestMode) {
        alert('üîí Vous devez vous connecter pour cr√©er des √©v√©nements.');
        return;
      }

      const name = prompt('Nom de l\'√©v√©nement:');
      if (!name) return;

      const date = prompt('Date (AAAA-MM-JJ):');
      if (!date) return;

      const type = prompt('Type (Jour f√©ri√©, Soldes, F√™te, Autre):');

      createEvent(name, date, type || 'Autre');
    }

    async function createEvent(name, date, type) {
      if (isGuestMode) return;
      const { error } = await supabaseClient
        .from('events')
        .insert([{
          name,
          start_date: date,
          end_date: date,
          type,
          created_by: user.id
        }]);

      if (error) {
        alert('Erreur: ' + error.message);
        return;
      }

      await loadEvents();
      renderEventsList();
      renderCalendar();
    }

    // =========================
    // TEAM COLORS
    // =========================
    const teamColors = [
      '#FF6B35', // Orange
      '#3B82F6', // Bleu
      '#10B981', // Vert
      '#F59E0B', // Jaune
      '#EF4444', // Rouge
      '#8B5CF6', // Violet
      '#EC4899', // Rose
      '#14B8A6', // Turquoise
      '#6B7280'  // Gris
    ];

    function getTeamColor(teamId) {
      if (!teamId) return '#FF6B35'; // Couleur par d√©faut
      
      const teamIndex = teams.findIndex(t => t.id === teamId);
      if (teamIndex === -1) return '#FF6B35';
      
      return teamColors[teamIndex % teamColors.length];
    }

    function getTeamColorByName(teamName) {
      if (!teamName) return '#FF6B35';
      
      const team = teams.find(t => t.name.toLowerCase() === teamName.toLowerCase());
      if (!team) return '#FF6B35';
      
      return getTeamColor(team.id);
    }

    // =========================
    // EXPORT FUNCTIONS
    // =========================
    function downloadCSV(content, filename) {
      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function downloadTSV(content, filename) {
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function exportTasksCSV() {
      let tsv = 'Titre\tDescription\tCat√©gorie\tD√©but\tFin\t√âquipe\tPriorit√©\tCouleur\tStatut\n';
      
      tasks.forEach(t => {
        const teamName = (t.teams && t.teams.name) ? t.teams.name : '';
        const color = t.color || getTeamColor(t.team_id);
        tsv += `${t.title}\t${t.description || ''}\t${t.category || ''}\t${t.start_date}\t${t.end_date}\t${teamName}\t${t.priority || ''}\t${color}\t${t.completed ? 'Termin√©e' : '√Ä faire'}\n`;
      });

      downloadTSV(tsv, 'taches_export.txt');
    }

    function exportTasksJSON() {
      const json = JSON.stringify(tasks, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'taches_export.json';
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function exportTasksiCal() {
      let ical = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//TaskFlow//FR\n';

      tasks.forEach(t => {
        ical += 'BEGIN:VEVENT\n';
        ical += `DTSTART:${t.start_date.replace(/-/g, '')}\n`;
        ical += `DTEND:${t.end_date.replace(/-/g, '')}\n`;
        ical += `SUMMARY:${t.title}\n`;
        if (t.description) ical += `DESCRIPTION:${t.description}\n`;
        ical += 'END:VEVENT\n';
      });

      ical += 'END:VCALENDAR';

      const blob = new Blob([ical], { type: 'text/calendar' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'taches_export.ics';
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function exportEventsCSV() {
      let tsv = 'Nom\tType\tDate d√©but\tDate fin\n';
      
      events.forEach(e => {
        tsv += `${e.name}\t${e.type || ''}\t${e.start_date}\t${e.end_date}\n`;
      });

      downloadTSV(tsv, 'evenements_export.txt');
    }

    function exportEventsJSON() {
      const json = JSON.stringify(events, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'evenements_export.json';
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function downloadTasksTemplate() {
      const tsv = `Titre\tDescription\tCat√©gorie\tD√©but\tFin\t√âquipe\tPriorit√©\tCouleur
Exemple t√¢che 1\tDescription de la t√¢che\tDev\t2026-02-01\t2026-02-15\tProduction\thaute\t#FF6B35
Exemple t√¢che 2\tAutre description\tDesign\t2026-02-05\t2026-02-10\tDesign\tmoyenne\t#3B82F6
Exemple t√¢che 3\tExemple sans couleur (auto selon √©quipe)\tMarketing\t2026-02-10\t2026-02-20\tMarketing\tbasse\t`;
      downloadTSV(tsv, 'modele_taches.txt');
    }

    function importTasks(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        const text = e.target.result;
        const lines = text.split('\n').filter(l => l.trim());
        
        if (lines.length < 2) {
          alert('‚ùå Fichier vide ou invalide');
          return;
        }

        let imported = 0;
        let errors = 0;
        
        for (let i = 1; i < lines.length; i++) {
          // Split by tab instead of comma
          const parts = lines[i].split('\t').map(p => p.trim());
          if (parts.length >= 5) {
            const [title, description, category, start_date, end_date, teamName, priority, colorFromTSV] = parts;
            
            // Find team
            let team_id = teams[0]?.id;
            let team = null;
            if (teamName) {
              team = teams.find(t => t.name.toLowerCase() === teamName.toLowerCase());
              if (team) team_id = team.id;
            }

            // Determine color: use TSV color if provided, otherwise auto-assign based on team
            let taskColor = '#FF6B35'; // default
            if (colorFromTSV && colorFromTSV.startsWith('#')) {
              // Color provided in TSV
              taskColor = colorFromTSV;
            } else if (team_id) {
              // Auto-assign color based on team
              taskColor = getTeamColor(team_id);
            }

            if (!team_id) {
              errors++;
              continue;
            }

            try {
              const { error } = await supabaseClient.from('tasks').insert([{
                title,
                description: description || '',
                category: category || 'Autre',
                start_date,
                end_date,
                team_id,
                priority: priority || 'moyenne',
                color: taskColor,
                created_by: user.id,
                completed: false
              }]);
              
              if (error) throw error;
              imported++;
            } catch (e) {
              console.error('Erreur import t√¢che:', e);
              errors++;
            }
          }
        }

        await loadTasks();
        renderTasksList();
        renderCalendar();
        if (calendarViewMode === 'list') renderCalendarList();
        
        alert(`‚úÖ Import termin√©!\n${imported} t√¢che(s) import√©e(s)\n${errors} erreur(s)\n\nüí° Les t√¢ches sans couleur ont √©t√© color√©es automatiquement selon leur √©quipe.`);
        event.target.value = '';
      };
      reader.readAsText(file);
    }

    function importEvents(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        const text = e.target.result;
        const lines = text.split('\n').filter(l => l.trim());
        
        for (let i = 1; i < lines.length; i++) {
          // Split by tab instead of comma
          const parts = lines[i].split('\t').map(p => p.trim());
          if (parts.length >= 3) {
            const [name, type, start_date, end_date] = parts;

            await supabaseClient.from('events').insert([{
              name,
              type: type || 'Autre',
              start_date,
              end_date: end_date || start_date,
              created_by: user.id
            }]);
          }
        }

        await loadEvents();
        renderEventsList();
        renderCalendar();
        alert('Import termin√©!');
      };
      reader.readAsText(file);
    }

    // Make functions global
    window.handleLogoUpload = handleLogoUpload;
    window.resetTaskColor = resetTaskColor;
    window.deleteTask = deleteTask;
    window.deleteTeam = deleteTeam;
    window.deleteEvent = deleteEvent;
    window.showCreateTeamModal = showCreateTeamModal;
    window.showCreateEventModal = showCreateEventModal;
    window.showCreateTaskModal = showCreateTaskModal;
    window.showEditTaskModal = showEditTaskModal;
    window.saveTaskFromModal = saveTaskFromModal;
    window.exportTasksCSV = exportTasksCSV;
    window.exportTasksJSON = exportTasksJSON;
    window.exportTasksiCal = exportTasksiCal;
    window.exportEventsCSV = exportEventsCSV;
    window.exportEventsJSON = exportEventsJSON;
    window.downloadTasksTemplate = downloadTasksTemplate;
    window.importTasks = importTasks;
    window.importEvents = importEvents;

    // =========================
    // INIT
    // =========================
    async function setAuthedUI() {
      isGuestMode = false; // User is now logged in
      
      const authView = document.getElementById('authView');
      const appView = document.getElementById('appView');
      const btnLogout = document.getElementById('btnLogout');
      const btnLogin = document.getElementById('btnLogin');
      
      if (authView) hide(authView);
      if (appView) show(appView);
      if (btnLogout) show(btnLogout);
      
      // Hide login button
      if (btnLogin) btnLogin.style.display = 'none';
      
      // Close login modal if open
      if (loginModalInstance) {
        try {
          loginModalInstance.hide();
        } catch (e) {
          console.log('Modal already closed');
        }
      }

      setText(document.getElementById('userEmail'), user.email || '');
      setText(document.getElementById('roleBadge'), '‚úì Connect√©');
      
      // Update UI elements
      updateUIForAuthState();
      
      await loadAllData();
      populateTaskFilters();
      
      // Show calendar by default
      switchView('calendarView');

      if (window.lucide) lucide.createIcons();
    }

    function setAnonUI() {
      const authView = document.getElementById('authView');
      const appView = document.getElementById('appView');
      const btnLogout = document.getElementById('btnLogout');
      const btnLogin = document.getElementById('btnLogin');
      
      if (authView) show(authView);
      if (appView) hide(appView);
      if (btnLogout) hide(btnLogout);
      if (btnLogin) btnLogin.style.display = 'none';

      setText(document.getElementById('userEmail'), '');
      setText(document.getElementById('roleBadge'), 'non connect√©');
    }

    (async () => {
      // Load saved logo
      loadSavedLogo();

      // init session
      const { data } = await supabaseClient.auth.getSession();
      session = data.session;
      user = session ? session.user : null;

      if (user) await setAuthedUI();
      else setAnonUI();

      supabaseClient.auth.onAuthStateChange(async (_event, newSession) => {
        session = newSession;
        user = newSession ? newSession.user : null;

        if (user) await setAuthedUI();
        else setAnonUI();
      });

      if (window.lucide) lucide.createIcons();
    })();
  </script>
</body>
</html>
